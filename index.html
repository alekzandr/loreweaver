<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LoreWeaver - D&D Exploration Encounter Generator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --glass-bg: rgba(255, 255, 255, 0.08);
            --glass-border: rgba(255, 255, 255, 0.18);
            --glass-shadow: rgba(0, 0, 0, 0.1);
            --accent-blue: #007aff;
            --accent-light: #5ac8fa;
            --text-primary: #1d1d1f;
            --text-secondary: #86868b;
            --bg-primary: #f5f5f7;
            --bg-secondary: #ffffff;
            --hover-bg: rgba(0, 122, 255, 0.08);
        }

        [data-theme="dark"] {
            --glass-bg: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
            --glass-shadow: rgba(0, 0, 0, 0.3);
            --accent-blue: #0a84ff;
            --accent-light: #64d2ff;
            --text-primary: #f5f5f7;
            --text-secondary: #98989d;
            --bg-primary: #000000;
            --bg-secondary: #1c1c1e;
            --hover-bg: rgba(10, 132, 255, 0.15);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #e8f0fe 0%, #f8f9fa 50%, #fff5f5 100%);
            color: var(--text-primary);
            min-height: 100vh;
            padding: 20px;
            line-height: 1.6;
            transition: background 0.3s ease, color 0.3s ease;
        }

        [data-theme="dark"] body {
            background: linear-gradient(135deg, #000000 0%, #1a1a2e 50%, #16213e 100%);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 40px;
            padding: 40px 20px;
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.06),
                        0 1px 3px rgba(0, 0, 0, 0.02);
        }

        [data-theme="dark"] header {
            background: rgba(28, 28, 30, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3),
                        0 1px 3px rgba(0, 0, 0, 0.2);
        }

        h1 {
            font-size: 3em;
            font-weight: 600;
            background: linear-gradient(135deg, #007aff 0%, #5ac8fa 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
            letter-spacing: -0.02em;
        }

        [data-theme="dark"] h1 {
            background: linear-gradient(135deg, #0a84ff 0%, #64d2ff 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            color: var(--text-secondary);
            font-size: 1.1em;
            font-weight: 400;
        }

        .controls {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            padding: 30px;
            border-radius: 20px;
            margin-bottom: 30px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.06),
                        0 1px 3px rgba(0, 0, 0, 0.02);
        }

        [data-theme="dark"] .controls {
            background: rgba(28, 28, 30, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3),
                        0 1px 3px rgba(0, 0, 0, 0.2);
        }

        .control-group {
            margin-bottom: 25px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-primary);
            font-weight: 500;
            font-size: 0.95em;
        }

        select, input[type="number"] {
            width: 100%;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 1em;
            font-family: inherit;
            transition: all 0.2s ease;
        }

        [data-theme="dark"] select,
        [data-theme="dark"] input[type="number"],
        [data-theme="dark"] input[type="text"] {
            background: rgba(58, 58, 60, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        select:focus, input:focus {
            outline: none;
            border-color: var(--accent-blue);
            background: #ffffff;
            box-shadow: 0 0 0 4px rgba(0, 122, 255, 0.1);
        }

        [data-theme="dark"] select:focus,
        [data-theme="dark"] input:focus {
            background: rgba(58, 58, 60, 0.8);
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 4px rgba(10, 132, 255, 0.2);
        }

        select option {
            background: #ffffff;
            color: var(--text-primary);
        }

        [data-theme="dark"] select option {
            background: #1c1c1e;
            color: var(--text-primary);
        }

        .environment-tags {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .tag {
            padding: 10px 15px;
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 12px;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s ease;
            font-weight: 500;
            font-size: 0.9em;
        }

        [data-theme="dark"] .tag {
            background: rgba(58, 58, 60, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .tag:hover {
            background: var(--hover-bg);
            border-color: var(--accent-blue);
            transform: translateY(-1px);
        }

        .tag.active {
            background: var(--accent-blue);
            border-color: var(--accent-blue);
            color: white;
            box-shadow: 0 4px 12px rgba(0, 122, 255, 0.3);
        }

        button {
            background: var(--accent-blue);
            color: white;
            border: none;
            padding: 14px 32px;
            font-size: 1.05em;
            font-weight: 500;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 4px 12px rgba(0, 122, 255, 0.3);
            width: 100%;
            margin-top: 10px;
            font-family: inherit;
        }

        button:hover {
            background: #0062cc;
            transform: translateY(-1px);
            box-shadow: 0 6px 16px rgba(0, 122, 255, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        .nav-tabs {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
            background: rgba(255, 255, 255, 0.5);
            padding: 6px;
            border-radius: 14px;
            backdrop-filter: blur(10px);
            width: fit-content;
            margin-left: auto;
            margin-right: auto;
        }

        [data-theme="dark"] .nav-tabs {
            background: rgba(58, 58, 60, 0.4);
        }

        .nav-tab {
            background: transparent;
            color: var(--text-primary);
            border: none;
            padding: 10px 24px;
            font-size: 1em;
            font-weight: 500;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            width: auto;
            margin: 0;
            box-shadow: none;
        }

        .nav-tab:hover {
            background: rgba(255, 255, 255, 0.6);
        }

        .nav-tab.active {
            background: #ffffff;
            color: var(--accent-blue);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        .page-content {
            animation: fadeIn 0.3s ease-in;
        }

        .search-controls {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            padding: 30px;
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.06);
            margin-bottom: 30px;
        }

        [data-theme="dark"] .search-controls {
            background: rgba(28, 28, 30, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .search-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
        }

        .search-bar input {
            flex: 1;
            padding: 14px 18px;
            font-size: 1em;
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 12px;
            color: var(--text-primary);
            font-family: inherit;
            transition: all 0.2s ease;
        }

        [data-theme="dark"] .search-bar input {
            background: rgba(58, 58, 60, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .search-bar input:focus {
            outline: none;
            border-color: var(--accent-blue);
            background: #ffffff;
            box-shadow: 0 0 0 4px rgba(0, 122, 255, 0.1);
        }

        [data-theme="dark"] .search-bar input:focus {
            background: rgba(58, 58, 60, 0.8);
            box-shadow: 0 0 0 4px rgba(10, 132, 255, 0.2);
        }

        .search-bar button {
            width: auto;
            padding: 14px 28px;
        }

        .filter-section h3 {
            color: var(--text-primary);
            margin-bottom: 16px;
            font-size: 1.2em;
            font-weight: 600;
        }

        .filter-group {
            margin-bottom: 20px;
        }

        .filter-group label {
            display: block;
            color: var(--text-secondary);
            margin-bottom: 10px;
            font-weight: 500;
            font-size: 0.9em;
        }

        .filter-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .filter-tag {
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.9em;
            font-weight: 500;
        }

        .filter-tag:hover {
            background: var(--hover-bg);
            border-color: var(--accent-blue);
            transform: translateY(-1px);
        }

        .filter-tag.active {
            background: var(--accent-blue);
            border-color: var(--accent-blue);
            color: white;
            box-shadow: 0 2px 8px rgba(0, 122, 255, 0.3);
        }

        /* Settings Page */
        .settings-section {
            background: rgba(255, 255, 255, 0.9);
            padding: 24px;
            border-radius: 16px;
            margin-bottom: 20px;
            border: 1px solid rgba(0, 0, 0, 0.06);
        }

        [data-theme="dark"] .settings-section {
            background: rgba(58, 58, 60, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .settings-section h2 {
            color: var(--text-primary);
            margin-bottom: 20px;
            font-size: 1.5em;
            font-weight: 600;
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 0;
            border-bottom: 1px solid rgba(0, 0, 0, 0.06);
        }

        [data-theme="dark"] .setting-item {
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .setting-item:last-child {
            border-bottom: none;
        }

        .setting-info h3 {
            color: var(--text-primary);
            font-size: 1.1em;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .setting-info p {
            color: var(--text-secondary);
            font-size: 0.9em;
        }

        .theme-switch {
            position: relative;
            width: 60px;
            height: 34px;
            background: rgba(0, 0, 0, 0.1);
            border-radius: 34px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        [data-theme="dark"] .theme-switch {
            background: rgba(255, 255, 255, 0.1);
        }

        .theme-switch.active {
            background: var(--accent-blue);
        }

        .theme-switch-slider {
            position: absolute;
            top: 3px;
            left: 3px;
            width: 28px;
            height: 28px;
            background: white;
            border-radius: 50%;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        .theme-switch.active .theme-switch-slider {
            transform: translateX(26px);
        }

        .search-results {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            padding: 30px;
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.06);
        }

        .result-card {
            background: rgba(255, 255, 255, 0.9);
            padding: 20px;
            border-radius: 16px;
            margin-bottom: 15px;
            border: 1px solid rgba(0, 0, 0, 0.06);
            transition: all 0.2s ease;
        }

        [data-theme="dark"] .result-card {
            background: rgba(58, 58, 60, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .result-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
            border-color: rgba(0, 122, 255, 0.2);
        }

        [data-theme="dark"] .result-card:hover {
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
            border-color: rgba(10, 132, 255, 0.4);
        }

        .result-title {
            font-size: 1.3em;
            color: var(--text-primary);
            margin-bottom: 10px;
            font-weight: 600;
        }

        .result-type {
            display: inline-block;
            padding: 4px 12px;
            background: var(--accent-blue);
            color: white;
            border-radius: 8px;
            font-size: 0.85em;
            margin-right: 10px;
            margin-bottom: 10px;
            font-weight: 500;
        }

        .result-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 10px;
        }

        .result-tag {
            padding: 4px 10px;
            background: rgba(0, 122, 255, 0.1);
            border-radius: 6px;
            font-size: 0.8em;
            color: var(--accent-blue);
            font-weight: 500;
        }

        .result-description {
            color: var(--text-secondary);
            margin-top: 10px;
            line-height: 1.6;
        }

        .result-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .result-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s ease;
            font-size: 0.9em;
            font-family: inherit;
        }

        .preview-btn {
            background: rgba(0, 0, 0, 0.05);
            color: var(--text-primary);
        }

        [data-theme="dark"] .preview-btn {
            background: rgba(255, 255, 255, 0.1);
        }

        .preview-btn:hover {
            background: rgba(0, 122, 255, 0.1);
            color: var(--accent-blue);
        }

        [data-theme="dark"] .preview-btn:hover {
            background: rgba(10, 132, 255, 0.2);
        }

        .open-btn {
            background: var(--accent-blue);
            color: white;
        }

        .open-btn:hover {
            background: #0062cc;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 122, 255, 0.3);
        }

        .preview-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }

        .preview-modal.active {
            display: flex;
        }

        .preview-content {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(40px) saturate(180%);
            -webkit-backdrop-filter: blur(40px) saturate(180%);
            padding: 40px;
            border-radius: 20px;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .preview-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.1);
            color: var(--text-primary);
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2em;
            font-weight: 500;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .preview-close:hover {
            background: rgba(0, 0, 0, 0.2);
            transform: scale(1.1);
        }

        .preview-header {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }

        .preview-title {
            font-size: 1.8em;
            color: var(--text-primary);
            margin-bottom: 10px;
            font-weight: 600;
        }

        .preview-body {
            color: var(--text-secondary);
            line-height: 1.8;
        }

        .encounter-display {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            padding: 30px;
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.06);
            display: none;
            animation: fadeIn 0.5s ease-in;
        }

        [data-theme="dark"] .encounter-display {
            background: rgba(28, 28, 30, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .encounter-display.active {
            display: block;
        }

        .encounter-section {
            margin-bottom: 30px;
            padding: 24px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 16px;
            border: 1px solid rgba(0, 0, 0, 0.06);
        }

        [data-theme="dark"] .encounter-section {
            background: rgba(58, 58, 60, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .encounter-section h2 {
            color: var(--text-primary);
            margin-bottom: 15px;
            font-size: 1.6em;
            font-weight: 600;
        }

        .encounter-section h3 {
            color: var(--accent-blue);
            margin-top: 20px;
            margin-bottom: 10px;
            font-size: 1.3em;
            font-weight: 600;
        }

        .skill-check {
            background: rgba(0, 122, 255, 0.05);
            padding: 15px;
            margin: 10px 0;
            border-radius: 12px;
            border-left: 3px solid var(--accent-blue);
        }

        .skill-check-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .skill-name {
            font-weight: 600;
            color: var(--accent-blue);
            font-size: 1.05em;
        }

        .dc {
            background: var(--accent-blue);
            padding: 4px 12px;
            border-radius: 10px;
            font-weight: 600;
            color: white;
            font-size: 0.9em;
        }

        .hazard {
            background: rgba(255, 59, 48, 0.05);
            padding: 15px;
            margin: 10px 0;
            border-radius: 12px;
            border-left: 3px solid #ff3b30;
        }

        .hazard-name {
            font-weight: 600;
            color: #ff3b30;
            font-size: 1.1em;
            margin-bottom: 8px;
        }

        .trap {
            background: rgba(255, 149, 0, 0.05);
            padding: 15px;
            margin: 10px 0;
            border-radius: 12px;
            border-left: 3px solid #ff9500;
        }

        .trap-name {
            font-weight: 600;
            color: #ff9500;
            font-size: 1.1em;
            margin-bottom: 8px;
        }

        .scaling-note {
            background: rgba(0, 122, 255, 0.05);
            padding: 15px;
            border-radius: 12px;
            margin: 10px 0;
            border: 1px solid rgba(0, 122, 255, 0.2);
        }

        .level-badge {
            display: inline-block;
            background: var(--accent-blue);
            padding: 4px 10px;
            border-radius: 8px;
            font-size: 0.85em;
            margin-right: 8px;
            font-weight: 600;
            color: white;
        }

        .environmental-effect {
            background: rgba(90, 200, 250, 0.05);
            padding: 15px;
            margin: 10px 0;
            border-radius: 12px;
            border-left: 3px solid var(--accent-light);
        }

        .effect-name {
            font-weight: 600;
            color: var(--accent-light);
            font-size: 1.05em;
            margin-bottom: 8px;
        }

        ul {
            margin-left: 20px;
            line-height: 1.8;
        }

        li {
            margin: 8px 0;
            color: var(--text-secondary);
        }

        .description {
            line-height: 1.8;
            color: var(--text-secondary);
            margin: 10px 0;
        }

        .room-display {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            padding: 30px;
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.06);
        }

        [data-theme="dark"] .room-display {
            background: rgba(28, 28, 30, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 2em;
            }

            .environment-tags {
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            }

            .controls, .encounter-display, .room-display {
                padding: 20px;
            }

            .preview-content {
                padding: 30px 20px;
                max-width: 95%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>‚öîÔ∏è LoreWeaver ‚öîÔ∏è</h1>
            <p class="subtitle">D&D Exploration Encounter Generator</p>
            
            <!-- Navigation Tabs -->
            <div class="nav-tabs">
                <button class="nav-tab active" onclick="switchPage('generate')">üé≤ Generate</button>
                <button class="nav-tab" onclick="switchPage('npc')">üë§ NPCs</button>
                <button class="nav-tab" onclick="switchPage('search')">üîç Search</button>
                <button class="nav-tab" onclick="switchPage('settings')">‚öôÔ∏è Settings</button>
            </div>
        </header>

        <!-- Generate Page -->
        <div id="generatePage" class="page-content">
            <div class="controls">
                <div class="control-group">
                    <label for="environment">Select Environment:</label>
                    <div class="environment-tags" id="environmentTags">
                        <div class="tag" data-env="urban">üèõÔ∏è Urban</div>
                        <div class="tag" data-env="arctic">‚ùÑÔ∏è Arctic</div>
                        <div class="tag" data-env="ocean">üåä Ocean</div>
                        <div class="tag" data-env="space">üåå Space</div>
                        <div class="tag" data-env="crypt">üíÄ Crypt</div>
                        <div class="tag" data-env="forest">üå≤ Forest</div>
                        <div class="tag" data-env="desert">üèúÔ∏è Desert</div>
                        <div class="tag" data-env="mountain">‚õ∞Ô∏è Mountain</div>
                        <div class="tag" data-env="swamp">üêä Swamp</div>
                        <div class="tag" data-env="underground">üï≥Ô∏è Underground</div>
                    </div>
                </div>

                <div class="control-group">
                    <label for="partyLevel">Party Level (1-20):</label>
                    <input type="number" id="partyLevel" min="1" max="20" value="5">
                </div>

                <button onclick="generateEncounter()">üé≤ Generate Encounter</button>
            </div>

            <div class="encounter-display" id="encounterDisplay">
                <div id="encounterContent"></div>
            </div>

            <!-- Room Display -->
            <div class="room-display" id="roomDisplay" style="display: none;">
                <button onclick="returnToEncounter()" style="background: linear-gradient(135deg, #e74c3c, #c0392b); color: white; border: none; padding: 12px 24px; margin: 20px; font-size: 16px; border-radius: 8px; cursor: pointer; box-shadow: 0 4px 6px rgba(0,0,0,0.2);">
                    ‚Üê Back to Encounter
                </button>
                <div id="roomContent"></div>
            </div>
        </div>

        <!-- NPC Generator Page -->
        <div id="npcPage" class="page-content" style="display: none;">
            <div class="controls">
                <h2 style="margin-bottom: 20px; color: var(--text-primary);">üë§ NPC Generator</h2>
                
                <div class="control-group">
                    <label for="npcSpecies">Species:</label>
                    <select id="npcSpecies">
                        <option value="random">Random</option>
                        <option value="human">Human</option>
                        <option value="elf">Elf</option>
                        <option value="dwarf">Dwarf</option>
                        <option value="halfling">Halfling</option>
                        <option value="dragonborn">Dragonborn</option>
                        <option value="tiefling">Tiefling</option>
                        <option value="gnome">Gnome</option>
                        <option value="half-elf">Half-Elf</option>
                        <option value="half-orc">Half-Orc</option>
                    </select>
                </div>

                <button onclick="generateNPC()">‚ú® Generate NPC</button>
            </div>

            <div class="encounter-display" id="npcDisplay">
                <div class="encounter-section">
                    <h2>üé≤ Your NPC Will Appear Here</h2>
                    <p class="description">Click "Generate NPC" to create a diverse and interesting character for your campaign!</p>
                </div>
            </div>
        </div>

        <!-- Search Page -->
        <div id="searchPage" class="page-content" style="display: none;">
            <div class="search-controls">
                <div class="search-bar">
                    <input type="text" id="searchInput" placeholder="Search encounters and locations (e.g., 'tomb', 'ship', 'forest')..." />
                    <button onclick="performSearch()">üîç Search</button>
                </div>

                <div class="filter-section">
                    <h3>Filter by Tags:</h3>
                    <div class="filter-group">
                        <label>Environment:</label>
                        <div class="filter-tags" id="envFilters"></div>
                    </div>
                    <div class="filter-group">
                        <label>Location Type:</label>
                        <div class="filter-tags" id="locationFilters"></div>
                    </div>
                    <div class="filter-group">
                        <label>Setting:</label>
                        <div class="filter-tags" id="settingFilters"></div>
                    </div>
                    <button onclick="clearFilters()" style="margin-top: 10px; width: auto; padding: 8px 20px;">Clear All Filters</button>
                </div>
            </div>

            <div class="search-results" id="searchResults">
                <p style="text-align: center; color: var(--text-dark); padding: 40px;">Enter a search term or select tags to find encounters and locations</p>
            </div>
        </div>

        <!-- Settings Page -->
        <div id="settingsPage" class="page-content" style="display: none;">
            <div class="controls">
                <h2 style="margin-bottom: 30px; color: var(--text-primary); font-size: 2em;">‚öôÔ∏è Settings</h2>
                
                <div class="settings-section">
                    <h2>Appearance</h2>
                    
                    <div class="setting-item">
                        <div class="setting-info">
                            <h3>Dark Mode</h3>
                            <p>Toggle between light and dark theme</p>
                        </div>
                        <div class="theme-switch" id="themeSwitch" onclick="toggleTheme()">
                            <div class="theme-switch-slider">
                                <span class="theme-icon">üåô</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="settings-section">
                    <h2>About</h2>
                    <p style="color: var(--text-secondary); line-height: 1.8;">
                        <strong style="color: var(--text-primary);">LoreWeaver</strong> is a D&D exploration encounter generator designed to help Dungeon Masters create engaging and dynamic encounters across various environments.
                    </p>
                    <p style="color: var(--text-secondary); margin-top: 16px; line-height: 1.8;">
                        Generate random encounters and locations, or search through the library to find exactly what you need for your campaign.
                    </p>
                </div>
            </div>
        </div>

        <!-- Preview Modal -->
        <div id="previewModal" class="preview-modal">
            <div class="preview-content">
                <button class="preview-close" onclick="closePreview()">‚úï</button>
                <div id="previewBody"></div>
            </div>
        </div>
    </div>

    <script>
        let selectedEnvironment = 'urban';

        // Search page state
        let activeFilters = {
            environment: [],
            locationType: [],
            setting: []
        };

        // Data - if external JSON files fail to load, this embedded data is used as fallback
        // To update content: Edit encounters.json and locations.json files
        // The app will try to load from those files first, then fall back to this embedded data
        
        let encounterTitles = {"urban":[{"title":"The Shadowed Alley","tags":["alley","outdoor","street"]},{"title":"Rooftop Chase","tags":["rooftop","outdoor","building"]},{"title":"The Abandoned Warehouse","tags":["warehouse","indoor","building"]},{"title":"Market District Mystery","tags":["market","outdoor","street"]},{"title":"Sewer Expedition","tags":["sewer","underground","tunnel"]},{"title":"The Clocktower District","tags":["district","outdoor","building"]},{"title":"Wharf at Midnight","tags":["wharf","outdoor","dock"]},{"title":"The Old Quarter","tags":["district","outdoor","street"]}],"arctic":[{"title":"Frozen Wasteland Trek","tags":["wilderness","outdoor","openfield"]},{"title":"The Avalanche Path","tags":["mountain","outdoor","path"]},{"title":"Ice Cave Exploration","tags":["cave","indoor","cavern"]},{"title":"Blizzard Survival","tags":["wilderness","outdoor","openfield"]},{"title":"Glacier Crossing","tags":["glacier","outdoor","openfield"]},{"title":"The Whiteout","tags":["wilderness","outdoor","openfield"]},{"title":"Frostbite Pass","tags":["pass","outdoor","path"]},{"title":"Icebound Peaks","tags":["mountain","outdoor","peaks"]}],"ocean":[{"title":"Storm-Tossed Voyage","tags":["ship","vessel","deck"]},{"title":"The Coral Labyrinth","tags":["underwater","reef","natural"]},{"title":"Derelict Ship Discovery","tags":["ship","vessel","wreck"]},{"title":"Island Approach","tags":["shore","outdoor","beach"]},{"title":"Deep Water Descent","tags":["underwater","depths","openwater"]},{"title":"The Doldrums","tags":["ship","vessel","deck"]},{"title":"Reef of Bones","tags":["underwater","reef","wreck"]},{"title":"Siren's Channel","tags":["underwater","passage","natural"]}],"space":[{"title":"Derelict Spelljammer","tags":["ship","vessel","derelict"]},{"title":"Phlogiston Crossing","tags":["wildspace","void","openspace"]},{"title":"Crystal Sphere Breach","tags":["void","anomaly","openspace"]},{"title":"Astral Debris Field","tags":["debris","void","openspace"]},{"title":"Wildspace Anomaly","tags":["wildspace","anomaly","openspace"]},{"title":"The Rainbow Flow","tags":["phlogiston","void","openspace"]},{"title":"Sphere's Edge","tags":["boundary","void","openspace"]},{"title":"Gravity Well","tags":["anomaly","void","openspace"]}],"crypt":[{"title":"The Ancient Tomb","tags":["tomb","indoor","chamber"]},{"title":"Forgotten Catacombs","tags":["catacomb","tunnel","passage"]},{"title":"Cursed Burial Chamber","tags":["chamber","indoor","tomb"]},{"title":"The Silent Mausoleum","tags":["mausoleum","building","indoor"]},{"title":"Necropolis Depths","tags":["catacomb","tunnel","depths"]},{"title":"Ossuary Halls","tags":["hall","indoor","passage"]},{"title":"The Sealed Vault","tags":["vault","chamber","indoor"]},{"title":"Mourner's Path","tags":["passage","tunnel","path"]}],"forest":[{"title":"Dense Woodland Trail","tags":["trail","outdoor","path"]},{"title":"The Overgrown Ruins","tags":["ruins","structure","outdoor"]},{"title":"Ancient Grove","tags":["grove","outdoor","clearing"]},{"title":"Forest of Whispers","tags":["woods","outdoor","dense"]},{"title":"The Hidden Glade","tags":["glade","outdoor","clearing"]},{"title":"Thornwood Passage","tags":["passage","outdoor","path"]},{"title":"The Green Cathedral","tags":["grove","outdoor","clearing"]},{"title":"Wildwood Maze","tags":["woods","outdoor","dense"]}],"desert":[{"title":"Scorching Dunes","tags":["dunes","outdoor","openfield"]},{"title":"Oasis Mirage","tags":["oasis","outdoor","water"]},{"title":"The Buried Temple","tags":["temple","ruins","structure"]},{"title":"Canyon of Winds","tags":["canyon","outdoor","passage"]},{"title":"Desert Caravan Route","tags":["trail","outdoor","path"]},{"title":"The Glass Wastes","tags":["wasteland","outdoor","openfield"]},{"title":"Sunscorch Valley","tags":["valley","outdoor","passage"]},{"title":"Dune Sea Crossing","tags":["dunes","outdoor","openfield"]}],"mountain":[{"title":"Treacherous Peak","tags":["peak","outdoor","summit"]},{"title":"The Mountain Pass","tags":["pass","outdoor","path"]},{"title":"Cliffside Trail","tags":["cliff","outdoor","path"]},{"title":"Summit Ascent","tags":["peak","outdoor","summit"]},{"title":"The Hidden Valley","tags":["valley","outdoor","clearing"]},{"title":"Eagle's Roost","tags":["peak","outdoor","nest"]},{"title":"Stormbreak Ridge","tags":["ridge","outdoor","path"]},{"title":"The Devil's Stair","tags":["stairs","outdoor","path"]}],"swamp":[{"title":"The Mire","tags":["bog","outdoor","wetland"]},{"title":"Forgotten Wetlands","tags":["wetland","outdoor","wilderness"]},{"title":"Bog of Despair","tags":["bog","outdoor","wetland"]},{"title":"Murky Waters","tags":["water","outdoor","wetland"]},{"title":"The Dead Marsh","tags":["marsh","outdoor","wetland"]},{"title":"Rotwood Fen","tags":["fen","outdoor","wetland"]},{"title":"The Sinking Grounds","tags":["bog","outdoor","wetland"]},{"title":"Viper's Bog","tags":["bog","outdoor","wetland"]}],"underground":[{"title":"Cavern Depths","tags":["cavern","cave","natural"]},{"title":"The Sunless Expanse","tags":["cavern","cave","openspace"]},{"title":"Crystal Caves","tags":["cave","cavern","natural"]},{"title":"Underground River","tags":["river","cave","water"]},{"title":"The Forgotten Mine","tags":["mine","tunnel","manmade"]},{"title":"Echoing Halls","tags":["hall","cavern","chamber"]},{"title":"The Deepways","tags":["tunnel","passage","manmade"]},{"title":"Stonewomb Passage","tags":["passage","tunnel","natural"]}]};

        let locationObjects = {"urban":{"warehouse":{"tags":["warehouse","indoor","building"],"primary":["wooden crate","loading crane","storage shelf","shipping manifest","rope coil","tool bench"],"secondary":["rusted nail","receipt","ledger book","oil lantern","chain","pulley"],"tertiary":["coin purse","jewelry","letter","key","trap mechanism","poison vial"]},"building":{"tags":["building","indoor","rooftop","district"],"primary":["ornate desk","locked safe","bookshelf","filing cabinet","portrait painting","fireplace"],"secondary":["hidden drawer","secret compartment","ledger","correspondence","seal","inkwell"],"tertiary":["family heirloom","deed","treasure map","incriminating letter","gold coins","magic item"]},"street":{"tags":["street","outdoor","alley","district","market"],"primary":["market stall","merchant cart","street lamp","notice board","vendor stand","fountain"],"secondary":["loose cobblestone","rain barrel","awning","signpost","doorway","window"],"tertiary":["dropped coin","torn poster","hidden cache","secret mark","smuggler sign","trap"]},"dock":{"tags":["wharf","dock","outdoor"],"primary":["shipping crate","mooring post","cargo net","dock crane","warehouse door","gangplank"],"secondary":["rope","anchor","barrel","canvas tarp","shipping manifest","oil lamp"],"tertiary":["smuggled goods","hidden compartment","coded message","stolen treasure","trap","key"]},"sewer":{"tags":["sewer","underground","tunnel"],"primary":["drainage pipe","sewer grate","maintenance ladder","brick archway","water channel","junction"],"secondary":["rat nest","debris pile","broken gate","rusty valve","slime","chain"],"tertiary":["lost valuables","body","smuggler cache","disease","trap","monster lair"]}},"crypt":{"tomb":{"tags":["tomb","chamber","indoor"],"primary":["stone sarcophagus","altar","statue","burial niche","stone column","brazier"],"secondary":["burial offering","inscription","sealed urn","canopic jar","ritual item","relic"],"tertiary":["cursed item","treasure","magic weapon","ancient scroll","undead","trap"]},"catacomb":{"tags":["catacomb","tunnel","passage","depths"],"primary":["bone wall","burial alcove","stone pillar","ancient archway","ossuary","memorial plaque"],"secondary":["skull pile","grave goods","ancient torch","carved symbol","sealed niche","offering bowl"],"tertiary":["hidden treasure","secret passage","cursed relic","undead guardian","trap","ritual chamber"]},"mausoleum":{"tags":["mausoleum","building","indoor"],"primary":["family crypt","marble statue","bronze door","stone bench","memorial wall","vaulted ceiling"],"secondary":["inscription plaque","offering table","sealed vault","stained glass","iron gate","torch sconce"],"tertiary":["family treasure","ancient relic","magic item","hidden crypt","undead","protective ward"]},"vault":{"tags":["vault","chamber","indoor"],"primary":["sealed door","guardian statue","treasure chest","magical ward","puzzle lock","pillar"],"secondary":["pressure plate","glyph","keyhole","offering pedestal","ancient mechanism","rune"],"tertiary":["legendary treasure","artifact","curse","powerful undead","deadly trap","magic seal"]}},"forest":{"trail":{"tags":["trail","path","outdoor"],"primary":["ancient tree","moss-covered boulder","trail marker","fallen log","clearing","stream crossing"],"secondary":["animal track","carved mark","abandoned camp","broken branch","root system","mushroom circle"],"tertiary":["hidden cache","druid sign","fey marking","treasure","trap","monster lair"]},"ruins":{"tags":["ruins","structure","outdoor"],"primary":["crumbling wall","stone foundation","overgrown statue","collapsed archway","broken column","moss-covered altar"],"secondary":["ancient inscription","carved relief","pottery shard","rusted weapon","stone fragment","hidden chamber"],"tertiary":["buried treasure","magic item","ancient knowledge","guardian spirit","trap","secret passage"]},"clearing":{"tags":["clearing","glade","grove","outdoor"],"primary":["fairy ring","natural spring","ancient tree circle","flower meadow","stone circle","sacred grove"],"secondary":["unusual plant","animal den","bird nest","mushroom cluster","water source","wildflower patch"],"tertiary":["fey presence","magic spring","druid treasure","nature spirit","blessing","curse"]},"dense":{"tags":["woods","dense","outdoor"],"primary":["thick undergrowth","tangled thicket","hollow log","dense canopy","bramble patch","ancient trunk"],"secondary":["animal burrow","spider web","vine tangle","thorny bush","concealed pit","hidden path"],"tertiary":["monster lair","hidden treasure","trap","rare plant","secret passage","predator nest"]}},"desert":{"dunes":{"tags":["dunes","openfield","outdoor","wasteland"],"primary":["sand dune","wind-carved formation","buried skeleton","abandoned cart","rock outcrop","shifting sand"],"secondary":["sun-bleached bones","tattered cloth","broken wheel","empty waterskin","scorpion nest","sand ripples"],"tertiary":["buried treasure","ancient artifact","oasis map","cursed item","monster lair","quicksand trap"]},"ruins":{"tags":["temple","ruins","structure"],"primary":["weathered stone pillar","collapsed wall","buried entrance","ancient altar","sandstone block","hieroglyph"],"secondary":["carved relief","broken statue","pottery fragment","ritual vessel","stone tablet","sealed chamber"],"tertiary":["ancient treasure","magic artifact","curse tablet","mummy","deadly trap","hidden vault"]},"oasis":{"tags":["oasis","water","outdoor"],"primary":["oasis pool","palm tree","water source","desert plants","rock formation","shade"],"secondary":["animal track","fruit tree","medicinal herb","cool cave","traveler marker","campsite"],"tertiary":["hidden spring","rare plant","treasure cache","spirit guardian","blessing","mirage"]},"trail":{"tags":["trail","path","outdoor"],"primary":["caravan marker","desert trail","way stone","traveler's shrine","cairn","directional sign"],"secondary":["campfire remains","discarded item","footprints","warning marker","supply cache","shelter"],"tertiary":["buried treasure","ambush site","hidden oasis map","bandit cache","trap","ancient relic"]}},"mountain":{"peak":{"tags":["peak","summit","outdoor","nest"],"primary":["mountain peak","rocky outcrop","ice formation","summit cairn","wind-swept stone","precipice"],"secondary":["prayer flags","climber's anchor","eagle nest","ice crystal","rock shelter","marker stone"],"tertiary":["legendary treasure","dragon hoard","ancient relic","rare mineral","spirit shrine","trap"]},"pass":{"tags":["pass","path","outdoor","ridge","stairs"],"primary":["mountain pass","narrow ledge","switchback trail","rock bridge","stone steps","guard post"],"secondary":["rope anchor","safety rope","trail marker","shelter cave","warning sign","avalanche zone"],"tertiary":["hidden cache","bandit treasure","ancient marker","trap","monster ambush","secret passage"]},"valley":{"tags":["valley","clearing","outdoor"],"primary":["hidden valley","mountain stream","alpine meadow","sheltered grove","rocky basin","waterfall"],"secondary":["wildflower field","grazing area","mineral deposit","hot spring","cave entrance","ancient tree"],"tertiary":["hidden sanctuary","hermit dwelling","rare herb","treasure cache","spirit guardian","secret entrance"]},"cliff":{"tags":["cliff","outdoor","path"],"primary":["precarious ledge","cliff face","sheer drop","rock overhang","narrow path","vertical wall"],"secondary":["climbing anchor","bird nest","cave opening","rock shelf","erosion crack","loose stone"],"tertiary":["hidden cave","eagle treasure","ancient carving","trap","monster lair","secret passage"]}},"swamp":{"bog":{"tags":["bog","wetland","outdoor"],"primary":["murky pool","mud mound","gnarled tree","quicksand","stagnant water","dead vegetation"],"secondary":["marsh gas bubble","sunken log","lily pad","insect swarm","muddy bank","rotting vegetation"],"tertiary":["sunken treasure","body","monster lair","disease","trap","cursed area"]},"wetland":{"tags":["wetland","marsh","fen","outdoor","wilderness"],"primary":["marsh grass","water channel","raised hummock","dead tree","reed bed","shallow pool"],"secondary":["bird nest","fish trap","willow tree","stepping stone","floating debris","vegetation mat"],"tertiary":["hidden path","hermit hut","rare plant","treasure cache","hag marker","trap"]},"water":{"tags":["water","outdoor","wetland"],"primary":["dark water","stagnant pool","flowing stream","deep channel","murky pond","water source"],"secondary":["submerged log","floating vegetation","water plant","ripple","current","shallow ford"],"tertiary":["sunken boat","underwater cave","monster lair","treasure","trap","cursed water"]}},"underground":{"cavern":{"tags":["cavern","cave","natural","openspace","chamber"],"primary":["crystal formation","stone pillar","underground lake","stalactite cluster","rock formation","cavern floor"],"secondary":["mineral vein","bat colony","mushroom grove","limestone deposit","water drip","echo chamber"],"tertiary":["rare crystal","underground river","monster lair","treasure deposit","trap","secret passage"]},"tunnel":{"tags":["tunnel","passage","manmade"],"primary":["mine shaft","carved tunnel","support beams","rail tracks","tool marks","ventilation shaft"],"secondary":["mining cart","pickaxe","lantern hook","ore vein","support pillar","wooden brace"],"tertiary":["ore deposit","abandoned equipment","collapsed section","monster nest","trap","hidden passage"]},"river":{"tags":["river","water","cave"],"primary":["underground stream","water channel","rock bridge","waterfall","river bank","current"],"secondary":["stepping stone","water pool","mineral deposit","moisture","echo","fish"],"tertiary":["underwater passage","treasure","monster lair","rare mineral","trap","secret cave"]}},"ocean":{"ship":{"tags":["ship","vessel","deck"],"primary":["ship wheel","mast rigging","cargo hold","captain's quarters","main deck","anchor"],"secondary":["rope coil","barrel","sail","navigation tool","ship bell","cannon"],"tertiary":["treasure chest","ship's log","hidden cargo","secret compartment","trap","contraband"]},"wreck":{"tags":["wreck","ship","vessel","underwater"],"primary":["broken hull","sunken cargo","ship's skeleton","barnacle-covered mast","debris field","coral growth"],"secondary":["rotted sail","rusted chain","broken rudder","scattered cargo","ship bell","anchor"],"tertiary":["treasure chest","ship's safe","captain's loot","cursed cargo","monster lair","trap"]},"underwater":{"tags":["underwater","reef","natural","depths","openwater","passage"],"primary":["coral reef","underwater cave","kelp forest","rock formation","sea floor","current"],"secondary":["sea plant","anemone","shell cluster","fish school","underwater cliff","sand bed"],"tertiary":["pearl bed","sunken treasure","monster lair","ancient ruin","trap","magic current"]},"shore":{"tags":["shore","beach","outdoor"],"primary":["beach shore","tide pool","driftwood pile","rock outcrop","sand beach","wave line"],"secondary":["seashell","seaweed","crab","beach rock","sand dune","flotsam"],"tertiary":["message bottle","shipwreck debris","treasure chest","rare shell","trap","hidden cave"]}},"arctic":{"wilderness":{"tags":["wilderness","openfield","outdoor"],"primary":["ice field","snow plain","frozen tundra","ice wall","snowdrift","frost formation"],"secondary":["animal track","ice crack","wind pattern","snow hole","frozen plant","ice shard"],"tertiary":["frozen corpse","buried treasure","rare resource","monster lair","trap","ancient relic"]},"cave":{"tags":["cave","cavern","indoor"],"primary":["ice cave","snow shelter","frozen cavern","ice tunnel","frost wall","icicle"],"secondary":["ice formation","frozen pool","ice pillar","snow drift","frost pattern","wind tunnel"],"tertiary":["frozen treasure","ancient remains","rare ice","monster den","trap","magic ice"]},"mountain":{"tags":["mountain","peaks","outdoor"],"primary":["ice peak","frozen summit","glacier slope","ice cliff","snow ridge","avalanche path"],"secondary":["ice bridge","crevasse","snow cornice","ice wall","frozen waterfall","wind gap"],"tertiary":["legendary treasure","dragon lair","ancient shrine","rare mineral","trap","avalanche trigger"]},"path":{"tags":["path","pass","outdoor"],"primary":["frozen trail","ice path","snow route","marked way","passage","crossing"],"secondary":["trail marker","shelter","supply cache","warning sign","rope line","cairn"],"tertiary":["hidden cache","abandoned camp","treasure","trap","monster ambush","shortcut"]}},"space":{"ship":{"tags":["ship","vessel","derelict"],"primary":["spelljamming helm","navigation altar","air envelope","gravity plane","helm chamber","main deck"],"secondary":["star chart","planar compass","magic anchor","air pump","gravity ring","void seal"],"tertiary":["arcane treasure","planar map","magic artifact","ship secret","trap","hidden cargo"]},"void":{"tags":["void","openspace","wildspace","phlogiston","boundary"],"primary":["phlogiston flow","wildspace debris","crystal sphere","planar barrier","void current","star field"],"secondary":["asteroid","void eddy","magic field","planar echo","cosmic dust","light phenomenon"],"tertiary":["ancient wreck","planar rift","cosmic treasure","void entity","trap","portal"]},"anomaly":{"tags":["anomaly","void","openspace","wildspace"],"primary":["gravity well","magic vortex","planar rift","time distortion","space fold","reality tear"],"secondary":["energy field","temporal echo","spatial loop","magic surge","void pulse","reality fragment"],"tertiary":["legendary artifact","planar gateway","cosmic secret","powerful entity","deadly trap","reality breach"]},"debris":{"tags":["debris","void","openspace"],"primary":["wrecked ship","floating rock","debris field","broken hull","scattered cargo","void junk"],"secondary":["ship fragment","asteroid chunk","twisted metal","broken mast","cargo container","escape pod"],"tertiary":["salvage treasure","ship log","hidden cargo","survivor","trap","monster nest"]}}};

        let npcData = {"species":{"human":{"tags":["common","versatile","civilized"],"firstNames":["Aldric","Brianna","Cedric","Diana","Elias","Fiona","Garrett","Helena","Ivan","Jasmine","Kael","Lydia","Marcus","Nora","Owen","Petra","Quinn","Rosa","Silas","Thalia"],"surnames":["Ashford","Blackwood","Crawford","Donovan","Everett","Frost","Griffin","Hawthorne","Ironwood","Kane","Lockhart","Morven","Northwood","Oakheart","Pierce","Ravencroft","Sterling","Thornhill","Underwood","Winters"]},"elf":{"tags":["fey","elegant","longlived"],"firstNames":["Aelindra","Beriothien","Cyrillian","Daratrine","Elenwe","Faelyn","Galadrion","Holimion","Ithilwen","Jhelnae","Kylantha","Luthien","Mithrandir","Naeryndam","Olori√´l","Phaendar","Quillith","Ryllae","Sylvari","Thalionw√´"],"surnames":["Moonwhisper","Starweaver","Silverleaf","Dawnbringer","Nightbreeze","Sunfire","Mistwalker","Dreamweaver","Stormwind","Brightwood","Crystalbrook","Shadowgrove","Everglade","Rosepetal","Wintermoon","Goldleaf","Springblossom","Autumnshade","Frostwhisper","Willowmist"]},"dwarf":{"tags":["stout","crafty","underground"],"firstNames":["Baern","Dagnal","Eberk","Fargrim","Gimbol","Harbek","Ilde","Jhulae","Kathra","Mardred","Nalaed","Ovina","Porrak","Rurik","Sannl","Thorin","Ulfgar","Vistra","Whurdred","Zilda"],"surnames":["Ironforge","Stonehammer","Deepdelver","Mountainheart","Goldvein","Steelbeard","Battleborn","Rockhewer","Anvilstrike","Forgemaster","Gemcutter","Oreseeker","Tunnelfoot","Clanhammer","Brassbeard","Strongale","Flintheart","Copperhelm","Mithrilhand","Silverforge"]},"halfling":{"tags":["small","nimble","cheerful"],"firstNames":["Alton","Bree","Cade","Dee","Eldon","Fable","Garret","Holly","Jasper","Kat","Lyle","Merla","Nedda","Ostran","Perrin","Roscoe","Shaena","Tye","Verna","Wellby"],"surnames":["Goodbarrel","Greenbottle","Highhill","Hilltopple","Leagallow","Tealeaf","Thorngage","Tosscobble","Underbough","Brushgather","Goldworthy","Nimblefingers","Quickstep","Rumblefoot","Softstep","Swiftwhistle","Proudfoot","Burrowes","Meadowbrook","Thistletop"]},"dragonborn":{"tags":["draconic","proud","ancient"],"firstNames":["Arjhan","Balasar","Bharash","Donaar","Ghesh","Heskan","Kriv","Medrash","Mehen","Nadarr","Pandjed","Patrin","Rhogar","Shamash","Shedinn","Tarhun","Torinn","Akra","Biri","Daar"],"surnames":["Clethtinthiallor","Daardendrian","Delmirev","Drachedandion","Fenkenkabradon","Kepeshkmolik","Kerrhylon","Kimbatuul","Linxakasendalor","Myastan","Nemmonis","Norixius","Ophinshtalajiir","Prexijandilin","Shestendeliath","Turnuroth","Verthisathurgiesh","Yarjerit","Zradeth","Flamebrand"]},"tiefling":{"tags":["infernal","charismatic","outcast"],"firstNames":["Akmenios","Amnon","Barakas","Damakos","Ekemon","Iados","Kairon","Leucis","Melech","Mordai","Morthos","Pelaios","Skamos","Therai","Akta","Bryseis","Criella","Damaia","Ea","Kallista"],"surnames":["Art","Carrion","Despair","Excellence","Fear","Glory","Hope","Ideal","Music","Nowhere","Open","Poetry","Quest","Random","Reverence","Sorrow","Temerity","Torment","Weary","Nowhere"]},"gnome":{"tags":["small","inventive","curious"],"firstNames":["Alston","Boddynock","Brocc","Burgell","Dimble","Eldon","Erky","Fonkin","Frug","Gerbo","Gimble","Jebeddo","Kellen","Namfoodle","Orryn","Roondar","Seebo","Sindri","Warryn","Zook"],"surnames":["Beren","Daergel","Folkor","Garrick","Nackle","Murnig","Ningel","Raulnor","Scheppen","Timbers","Turen","Sparklegem","Tinkertop","Cogsworth","Gearwhistle","Brassbolt","Quickwit","Fizzlebang","Rumblebottom","Brightgem"]},"half-elf":{"tags":["mixed","diplomatic","versatile"],"firstNames":["Amaranth","Brevin","Carric","Dalkon","Enna","Faelyn","Gareth","Hazel","Immeral","Jorlan","Kylan","Lyriel","Marik","Neria","Oriel","Perrin","Quarion","Reinna","Soveliss","Talon"],"surnames":["Amakiir","Brightwood","Deepbrook","Evenwood","Greycastle","Hallowmere","Ironleaf","Lakemere","Moonbrook","Nighthollow","Oakenheart","Riverwood","Silvermoon","Starling","Thorngage","Wayfinder","Whisperwind","Wildflower","Winterbloom","Woodwalker"]},"half-orc":{"tags":["strong","fierce","outcast"],"firstNames":["Dench","Feng","Gell","Henk","Holg","Imsh","Keth","Krusk","Mhurren","Ront","Shump","Thokk","Baggi","Emen","Engong","Kansif","Myev","Neega","Ovak","Ownka"],"surnames":["Ironhide","Skullcrusher","Bloodrage","Grimjaw","Stonefist","Warbringer","Thunderborn","Battleheart","Ashmark","Flintborn","Hardknuckle","Razortusk","Steelgaze","Wolfheart","Earthshaker","Bonegrinder","Firebrand","Rockback","Shadowmaw","Stormbrow"]}},"alignments":[{"name":"Lawful Good","tags":["lawful","good","honorable"]},{"name":"Neutral Good","tags":["neutral","good","kind"]},{"name":"Chaotic Good","tags":["chaotic","good","rebellious"]},{"name":"Lawful Neutral","tags":["lawful","neutral","orderly"]},{"name":"True Neutral","tags":["neutral","balanced","pragmatic"]},{"name":"Chaotic Neutral","tags":["chaotic","neutral","unpredictable"]},{"name":"Lawful Evil","tags":["lawful","evil","tyrannical"]},{"name":"Neutral Evil","tags":["neutral","evil","selfish"]},{"name":"Chaotic Evil","tags":["chaotic","evil","destructive"]}],"personalities":[{"trait":"Argumentative and stubborn","tags":["combative","difficult","strong-willed"]},{"trait":"Cheerful and optimistic","tags":["happy","positive","encouraging"]},{"trait":"Curious and inquisitive","tags":["nosy","scholarly","investigative"]},{"trait":"Cynical and distrustful","tags":["suspicious","pessimistic","wary"]},{"trait":"Friendly and helpful","tags":["kind","supportive","welcoming"]},{"trait":"Greedy and materialistic","tags":["selfish","merchant","ambitious"]},{"trait":"Honest and forthright","tags":["truthful","direct","reliable"]},{"trait":"Humble and modest","tags":["meek","unassuming","quiet"]},{"trait":"Impulsive and reckless","tags":["hasty","dangerous","unpredictable"]},{"trait":"Lazy and unmotivated","tags":["slothful","apathetic","passive"]},{"trait":"Melancholic and brooding","tags":["sad","thoughtful","withdrawn"]},{"trait":"Nervous and anxious","tags":["fearful","worried","timid"]},{"trait":"Proud and arrogant","tags":["haughty","confident","superior"]},{"trait":"Quiet and observant","tags":["watchful","reserved","perceptive"]},{"trait":"Sarcastic and witty","tags":["humorous","clever","mocking"]},{"trait":"Secretive and mysterious","tags":["enigmatic","private","guarded"]},{"trait":"Serious and stern","tags":["grave","strict","formal"]},{"trait":"Superstitious and cautious","tags":["fearful","traditional","careful"]},{"trait":"Theatrical and dramatic","tags":["flamboyant","expressive","performer"]},{"trait":"Violent and aggressive","tags":["hostile","dangerous","combative"]}],"professions":[{"name":"Blacksmith","tags":["crafting","metal","strength"]},{"name":"Merchant","tags":["trading","wealthy","social"]},{"name":"Innkeeper","tags":["hospitality","social","information"]},{"name":"Guard","tags":["combat","lawful","protective"]},{"name":"Farmer","tags":["rural","hardworking","humble"]},{"name":"Alchemist","tags":["crafting","intelligent","experimental"]},{"name":"Cleric","tags":["religious","healing","spiritual"]},{"name":"Wizard","tags":["magical","scholarly","reclusive"]},{"name":"Thief","tags":["criminal","sneaky","street"]},{"name":"Bard","tags":["performer","charismatic","traveling"]},{"name":"Sailor","tags":["nautical","adventurous","tough"]},{"name":"Hunter","tags":["wilderness","skilled","solitary"]},{"name":"Scholar","tags":["intellectual","bookish","knowledgeable"]},{"name":"Noble","tags":["wealthy","influential","political"]},{"name":"Beggar","tags":["poor","desperate","street"]},{"name":"Artisan","tags":["crafting","creative","skilled"]},{"name":"Soldier","tags":["combat","disciplined","veteran"]},{"name":"Herbalist","tags":["nature","healing","knowledgeable"]},{"name":"Gambler","tags":["risky","social","untrustworthy"]},{"name":"Priest","tags":["religious","devoted","influential"]},{"name":"Assassin","tags":["criminal","deadly","secretive"]},{"name":"Spy","tags":["secretive","intelligent","deceptive"]},{"name":"Gladiator","tags":["combat","entertaining","strong"]},{"name":"Cartographer","tags":["scholarly","traveling","observant"]},{"name":"Fortune Teller","tags":["mystical","charismatic","mysterious"]}],"secrets":[{"secret":"Is actually a member of a thieves' guild","tags":["criminal","deceptive","dangerous"]},{"secret":"Witnessed a terrible crime but never reported it","tags":["guilty","fearful","compromised"]},{"secret":"Is deeply in debt to a powerful organization","tags":["desperate","vulnerable","pressured"]},{"secret":"Has a hidden magical ability they're afraid to reveal","tags":["magical","fearful","special"]},{"secret":"Is actually nobility traveling incognito","tags":["disguised","wealthy","fugitive"]},{"secret":"Murdered someone in their past","tags":["guilty","dangerous","haunted"]},{"secret":"Is a spy for a foreign power","tags":["deceptive","dangerous","political"]},{"secret":"Has a terminal illness they're hiding","tags":["dying","tragic","desperate"]},{"secret":"Is secretly in love with someone inappropriate","tags":["romantic","conflicted","vulnerable"]},{"secret":"Knows the location of a hidden treasure","tags":["knowledgeable","valuable","targeted"]},{"secret":"Is being blackmailed","tags":["vulnerable","desperate","compromised"]},{"secret":"Has a doppelganger twin nobody knows about","tags":["mysterious","dangerous","confusing"]},{"secret":"Was involved in a cult in their youth","tags":["dark past","reformed","haunted"]},{"secret":"Is actually a lycanthrope","tags":["cursed","dangerous","monstrous"]},{"secret":"Faked their own death years ago","tags":["fugitive","deceptive","mysterious"]},{"secret":"Has a child they abandoned","tags":["guilty","shameful","vulnerable"]},{"secret":"Is addicted to a dangerous substance","tags":["weak","desperate","vulnerable"]},{"secret":"Knows a devastating secret about the local ruler","tags":["dangerous","knowledgeable","political"]},{"secret":"Is actually undead but appears living","tags":["monstrous","magical","deceptive"]},{"secret":"Betrayed their closest friend for personal gain","tags":["treacherous","guilty","untrustworthy"]}],"appearances":[{"description":"Distinctive scar across face","tags":["scarred","veteran","memorable"]},{"description":"Unusually tall for their species","tags":["tall","imposing","noticeable"]},{"description":"Unusually short for their species","tags":["short","small","underestimated"]},{"description":"Missing an eye or wears an eyepatch","tags":["scarred","veteran","distinctive"]},{"description":"Brightly colored clothing","tags":["colorful","flashy","noticeable"]},{"description":"Always wears a hood or mask","tags":["hidden","mysterious","secretive"]},{"description":"Elaborate tattoos covering body","tags":["marked","artistic","cultural"]},{"description":"Walks with a pronounced limp","tags":["injured","veteran","memorable"]},{"description":"Extremely muscular build","tags":["strong","intimidating","physical"]},{"description":"Very thin and gaunt","tags":["frail","sickly","mysterious"]},{"description":"Heterochromia (different colored eyes)","tags":["unique","striking","memorable"]},{"description":"Silver or white hair despite young age","tags":["unusual","striking","mysterious"]},{"description":"Missing fingers or hand","tags":["scarred","veteran","distinctive"]},{"description":"Constantly fidgets with a trinket","tags":["nervous","memorable","quirky"]},{"description":"Wears expensive jewelry","tags":["wealthy","flashy","target"]},{"description":"Has a pet that follows them everywhere","tags":["unique","memorable","quirky"]},{"description":"Speaks with a thick accent","tags":["foreign","distinctive","memorable"]},{"description":"Burns or fire scars on skin","tags":["scarred","survivor","distinctive"]},{"description":"Wears armor even in casual settings","tags":["paranoid","veteran","prepared"]},{"description":"Exceptionally beautiful or handsome","tags":["attractive","charismatic","memorable"]}]};

        let dataLoaded = true; // Data is embedded, so it's always loaded

        // Load data on page load (tries external files, falls back to embedded data)
        async function loadData() {
            try {
                const [encountersResponse, locationsResponse] = await Promise.all([
                    fetch('encounters.json').catch(() => null),
                    fetch('locations.json').catch(() => null)
                ]);

                if (encountersResponse && locationsResponse && encountersResponse.ok && locationsResponse.ok) {
                    encounterTitles = await encountersResponse.json();
                    locationObjects = await locationsResponse.json();
                }
            } catch (error) {
                console.log('Using embedded data');
            }
        }

        // Call loadData and setup event listeners when page loads
        document.addEventListener('DOMContentLoaded', async function() {
            // Load saved theme
            loadTheme();
            
            // Load external data files
            await loadData();

            // Setup Enter key for search input
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        performSearch();
                    }
                });
            }
        });

        // REMOVED: Encounter titles now loaded from encounters.json
        
        // REMOVED: Location objects now loaded from locations.json

        // Theme toggle
        function toggleTheme() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            
            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            
            // Update icon and switch state
            updateThemeUI(newTheme);
        }

        // Update theme UI elements
        function updateThemeUI(theme) {
            const icons = document.querySelectorAll('.theme-icon');
            const themeSwitch = document.getElementById('themeSwitch');
            
            icons.forEach(icon => {
                icon.textContent = theme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
            });
            
            if (themeSwitch) {
                if (theme === 'dark') {
                    themeSwitch.classList.add('active');
                } else {
                    themeSwitch.classList.remove('active');
                }
            }
        }

        // Load saved theme on page load
        function loadTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            updateThemeUI(savedTheme);
        }

        // Page switching
        function switchPage(page) {
            document.getElementById('generatePage').style.display = 'none';
            document.getElementById('npcPage').style.display = 'none';
            document.getElementById('searchPage').style.display = 'none';

            document.getElementById('settingsPage').style.display = 'none';
            
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));

            if (page === 'generate') {
                document.getElementById('generatePage').style.display = 'block';
                document.querySelectorAll('.nav-tab')[0].classList.add('active');
            } else if (page === 'npc') {
                document.getElementById('npcPage').style.display = 'block';
                document.querySelectorAll('.nav-tab')[1].classList.add('active');
            } else if (page === 'search') {
                document.getElementById('searchPage').style.display = 'block';
                document.querySelectorAll('.nav-tab')[2].classList.add('active');
                initializeSearchFilters();
            } else if (page === 'settings') {
                document.getElementById('settingsPage').style.display = 'block';
                document.querySelectorAll('.nav-tab')[3].classList.add('active');
            }
        }

        // Initialize search filters
        function initializeSearchFilters() {
            if (document.getElementById('envFilters').children.length > 0) return;

            const envFilters = document.getElementById('envFilters');
            const environments = ['urban', 'arctic', 'ocean', 'space', 'crypt', 'forest', 'desert', 'mountain', 'swamp', 'underground'];
            const envIcons = { urban: 'üèõÔ∏è', arctic: '‚ùÑÔ∏è', ocean: 'üåä', space: 'üåå', crypt: 'üíÄ', forest: 'üå≤', desert: 'üèúÔ∏è', mountain: '‚õ∞Ô∏è', swamp: 'üêä', underground: 'üï≥Ô∏è' };

            environments.forEach(env => {
                const tag = document.createElement('div');
                tag.className = 'filter-tag';
                tag.textContent = `${envIcons[env]} ${env.charAt(0).toUpperCase() + env.slice(1)}`;
                tag.dataset.filter = env;
                tag.dataset.type = 'environment';
                tag.onclick = () => toggleFilter(tag, 'environment', env);
                envFilters.appendChild(tag);
            });

            const locationFilters = document.getElementById('locationFilters');
            const locationTypes = ['indoor', 'outdoor', 'building', 'street', 'cave', 'ruins', 'ship', 'underwater', 'tunnel', 'chamber', 'wilderness', 'path'];

            locationTypes.forEach(type => {
                const tag = document.createElement('div');
                tag.className = 'filter-tag';
                tag.textContent = type.charAt(0).toUpperCase() + type.slice(1);
                tag.dataset.filter = type;
                tag.dataset.type = 'locationType';
                tag.onclick = () => toggleFilter(tag, 'locationType', type);
                locationFilters.appendChild(tag);
            });

            const settingFilters = document.getElementById('settingFilters');
            const settings = ['natural', 'manmade', 'magical', 'tomb', 'void', 'water', 'urban', 'wilderness'];

            settings.forEach(setting => {
                const tag = document.createElement('div');
                tag.className = 'filter-tag';
                tag.textContent = setting.charAt(0).toUpperCase() + setting.slice(1);
                tag.dataset.filter = setting;
                tag.dataset.type = 'setting';
                tag.onclick = () => toggleFilter(tag, 'setting', setting);
                settingFilters.appendChild(tag);
            });
        }

        // Toggle filter
        function toggleFilter(element, type, value) {
            element.classList.toggle('active');

            const index = activeFilters[type].indexOf(value);
            if (index > -1) {
                activeFilters[type].splice(index, 1);
            } else {
                activeFilters[type].push(value);
            }

            performSearch();
        }

        // Clear filters
        function clearFilters() {
            activeFilters = {
                environment: [],
                locationType: [],
                setting: []
            };

            document.querySelectorAll('.filter-tag').forEach(tag => {
                tag.classList.remove('active');
            });

            document.getElementById('searchInput').value = '';
            performSearch();
        }

        // Perform search
        function performSearch() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
            const results = [];

            // Search encounters
            for (const [environment, encounters] of Object.entries(encounterTitles)) {
                encounters.forEach(encounter => {
                    let matches = true;

                    if (activeFilters.environment.length > 0 && !activeFilters.environment.includes(environment)) {
                        matches = false;
                    }

                    if (activeFilters.locationType.length > 0) {
                        const hasMatchingTag = encounter.tags.some(tag => activeFilters.locationType.includes(tag));
                        if (!hasMatchingTag) matches = false;
                    }

                    if (activeFilters.setting.length > 0) {
                        const hasMatchingTag = encounter.tags.some(tag => activeFilters.setting.includes(tag));
                        if (!hasMatchingTag) matches = false;
                    }

                    if (searchTerm) {
                        const titleMatch = encounter.title.toLowerCase().includes(searchTerm);
                        const tagMatch = encounter.tags.some(tag => tag.toLowerCase().includes(searchTerm));
                        const envMatch = environment.toLowerCase().includes(searchTerm);

                        if (!titleMatch && !tagMatch && !envMatch) {
                            matches = false;
                        }
                    }

                    if (matches) {
                        results.push({
                            type: 'encounter',
                            title: encounter.title,
                            environment: environment,
                            tags: encounter.tags,
                            description: buildEncounterDescription(environment, encounter.title, encounter.description)
                        });
                    }
                });
            }

            // Search locations
            for (const [environment, locations] of Object.entries(locationObjects)) {
                for (const [locationType, locationData] of Object.entries(locations)) {
                    let matches = true;

                    if (activeFilters.environment.length > 0 && !activeFilters.environment.includes(environment)) {
                        matches = false;
                    }

                    if (activeFilters.locationType.length > 0) {
                        const hasMatchingTag = locationData.tags.some(tag => activeFilters.locationType.includes(tag));
                        if (!hasMatchingTag) matches = false;
                    }

                    if (activeFilters.setting.length > 0) {
                        const hasMatchingTag = locationData.tags.some(tag => activeFilters.setting.includes(tag));
                        if (!hasMatchingTag) matches = false;
                    }

                    if (searchTerm) {
                        const typeMatch = locationType.toLowerCase().includes(searchTerm);
                        const tagMatch = locationData.tags.some(tag => tag.toLowerCase().includes(searchTerm));
                        const envMatch = environment.toLowerCase().includes(searchTerm);
                        const primaryMatch = locationData.primary.some(obj => obj.toLowerCase().includes(searchTerm));
                        const secondaryMatch = locationData.secondary.some(obj => obj.toLowerCase().includes(searchTerm));
                        const tertiaryMatch = locationData.tertiary.some(obj => obj.toLowerCase().includes(searchTerm));

                        if (!typeMatch && !tagMatch && !envMatch && !primaryMatch && !secondaryMatch && !tertiaryMatch) {
                            matches = false;
                        }
                    }

                    if (matches) {
                        const totalObjects = locationData.primary.length + locationData.secondary.length + locationData.tertiary.length;
                        const locationDescription = locationData.description || `Explore ${totalObjects} interactable objects across 3 layers of detail`;
                        results.push({
                            type: 'location',
                            title: `${locationType.charAt(0).toUpperCase() + locationType.slice(1)} (${environment})`,
                            environment: environment,
                            locationType: locationType,
                            tags: locationData.tags,
                            description: locationDescription,
                            objects: locationData.primary.slice(0, 4).join(', ') + '...'
                        });
                    }
                }
            }

            displaySearchResults(results);
        }

        // Display search results
        function displaySearchResults(results) {
            const container = document.getElementById('searchResults');

            if (results.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--text-dark); padding: 40px;">No results found. Try different keywords or filters.</p>';
                return;
            }

            let html = `<h2 style="color: var(--accent-color); margin-bottom: 20px;">Found ${results.length} result${results.length !== 1 ? 's' : ''}</h2>`;

            results.forEach((result, index) => {
                const typeColor = result.type === 'encounter' ? 'var(--primary-color)' : 'var(--success)';

                html += `
                    <div class="result-card">
                        <div class="result-title">${result.title}</div>
                        <span class="result-type" style="background: ${typeColor};">${result.type.toUpperCase()}</span>
                        <span class="result-type" style="background: var(--bg-dark);">${result.environment.toUpperCase()}</span>
                        <p class="result-description">${result.description}</p>
                        ${result.objects ? `<p class="result-description"><strong>Sample objects:</strong> ${result.objects}</p>` : ''}
                        <div class="result-tags">
                            ${result.tags.map(tag => `<span class="result-tag">${tag}</span>`).join('')}
                        </div>
                        <div class="result-actions">
                            <button class="result-btn preview-btn" onclick='previewResult(${index})'>üëÅÔ∏è Preview</button>
                            <button class="result-btn open-btn" onclick='openResult(${index})'>üìÇ Open</button>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
            window.searchResults = results;
        }

        // Preview result
        function previewResult(index) {
            const result = window.searchResults[index];
            const modal = document.getElementById('previewModal');
            const previewBody = document.getElementById('previewBody');

            let html = `
                <div class="preview-header">
                    <div class="preview-title">${result.title}</div>
                    <div style="display: flex; gap: 10px; margin-top: 10px;">
                        <span class="result-type" style="background: ${result.type === 'encounter' ? 'var(--primary-color)' : 'var(--success)'};">${result.type.toUpperCase()}</span>
                        <span class="result-type" style="background: var(--bg-dark);">${result.environment.toUpperCase()}</span>
                    </div>
                </div>
                <div class="preview-body">
            `;

            if (result.type === 'encounter') {
                html += `
                    <h3 style="color: var(--accent-color); margin-bottom: 15px;">üìú Encounter Overview</h3>
                    <p style="margin-bottom: 20px;">${result.description}</p>

                    <h3 style="color: var(--success); margin-bottom: 15px;">üè∑Ô∏è Tags</h3>
                    <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 20px;">
                        ${result.tags.map(tag => `<span class="result-tag">${tag}</span>`).join('')}
                    </div>

                    <h3 style="color: var(--warning); margin-bottom: 15px;">üé≤ What to Expect</h3>
                    <ul style="margin-left: 20px; line-height: 2;">
                        <li>Skill challenges themed to ${result.environment} exploration</li>
                        <li>Mechanical, magical, or environmental traps</li>
                        <li>Natural, supernatural, or creature-based hazards</li>
                        <li>Environmental effects unique to ${result.environment} settings</li>
                    </ul>

                    <div style="margin-top: 30px; text-align: center;">
                        <button class="open-btn" onclick='closePreview(); openResult(${index});' style="padding: 12px 30px; font-size: 1.1em;">
                            üìÇ Open Full Encounter
                        </button>
                    </div>
                `;
            } else {
                html += `
                    <h3 style="color: var(--accent-color); margin-bottom: 15px;">üìç Location Overview</h3>
                    <p style="margin-bottom: 20px;">${result.description}</p>

                    <h3 style="color: var(--success); margin-bottom: 15px;">üè∑Ô∏è Tags</h3>
                    <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 20px;">
                        ${result.tags.map(tag => `<span class="result-tag">${tag}</span>`).join('')}
                    </div>

                    <h3 style="color: var(--warning); margin-bottom: 15px;">üîç Sample Objects</h3>
                    <p style="margin-left: 20px; line-height: 2;">${result.objects}</p>

                    <div style="margin-top: 30px; text-align: center;">
                        <button class="open-btn" onclick='closePreview(); openResult(${index});' style="padding: 12px 30px; font-size: 1.1em;">
                            üìÇ Generate This Location
                        </button>
                    </div>
                `;
            }

            html += `</div>`;
            previewBody.innerHTML = html;
            modal.classList.add('active');
        }

        // Close preview
        function closePreview() {
            document.getElementById('previewModal').classList.remove('active');
        }

        // Close modal when clicking outside
        document.addEventListener('click', function(e) {
            const modal = document.getElementById('previewModal');
            if (e.target === modal) {
                closePreview();
            }
        });

        // Open result
        function openResult(index) {
            const result = window.searchResults[index];

            if (result.type === 'encounter') {
                selectedEnvironment = result.environment;

                document.querySelectorAll('.tag').forEach(t => t.classList.remove('active'));
                const tag = document.querySelector(`.tag[data-env="${result.environment}"]`);
                if (tag) tag.classList.add('active');

                generateEncounter();
                switchPage('generate');

                setTimeout(() => {
                    document.getElementById('encounterDisplay').scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 100);
            } else if (result.type === 'location') {
                const locationData = locationObjects[result.environment][result.locationType];

                generateRoom(result.environment, result.locationType, locationData);
                switchPage('generate');

                setTimeout(() => {
                    document.getElementById('roomDisplay').scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 100);
            }
        }

        // Environment tag selection
        document.querySelectorAll('.tag').forEach(tag => {
            tag.addEventListener('click', function() {
                document.querySelectorAll('.tag').forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                selectedEnvironment = this.dataset.env;
            });
        });

        // Set default active tag
        document.querySelector('.tag[data-env="urban"]').classList.add('active');

        let encounterTitles = {
    "urban": [
        {
            "title": "The Shadowed Alley",
            "tags": [
                "alley",
                "outdoor",
                "street"
            ],
            "description": "A single guttering lantern throws nervous silhouettes against damp brick as smugglers barter over forbidden relics. Every whispered threat rides the fog, ready to drag interlopers into a maze of hidden doors and knife-bright intentions.",
            "weight": 1.1
        },
        {
            "title": "Rooftop Chase",
            "tags": [
                "rooftop",
                "outdoor",
                "building"
            ],
            "description": "Terracotta shingles and laundry lines blur beneath desperate feet while bells toll the alarm across the skyline. Chimney sweeps, nesting griffins, and sheer drops turn every leap into a wager with gravity and the guards below.",
            "weight": 1.2
        },
        {
            "title": "The Abandoned Warehouse",
            "tags": [
                "warehouse",
                "indoor",
                "building"
            ],
            "description": "Dust-choked crates form a claustrophobic labyrinth where contraband sigils flare to life when touched. Something restless prowls between the pallets, stirred awake by anyone bold enough to break the silence.",
            "weight": 0.9
        },
        {
            "title": "Market District Mystery",
            "tags": [
                "market",
                "outdoor",
                "street"
            ],
            "description": "Merchants hawk fragrant spices over the hushed gossip of a vanished magistrate. Beneath the tapestry of awnings, secret ledgers, coded chalk marks, and suspicious performers all beg to be decoded before the crowd turns hostile.",
            "weight": 1.0
        },
        {
            "title": "Sewer Expedition",
            "tags": [
                "sewer",
                "underground",
                "tunnel"
            ],
            "description": "Sluggish canals of alchemical runoff glow sickly green, illuminating murals that rewrite the city\u2019s founding myths. Mutated vermin and forgotten cult wards conspire to drown the unwary beneath a century of secrets.",
            "weight": 0.8
        },
        {
            "title": "The Clocktower District",
            "tags": [
                "district",
                "outdoor",
                "building"
            ],
            "description": "Clockwork giants toll the hour as brass gears strain against a sabotage-born misalignment. Spires connected by maintenance catwalks demand delicate timing lest the party be caught in a storm of spinning weights and civic panic.",
            "weight": 1.0
        },
        {
            "title": "Wharf at Midnight",
            "tags": [
                "wharf",
                "outdoor",
                "dock"
            ],
            "description": "Salt mist swallows lantern light while contraband-laden barges glide in under foreign colors. Whispered deals, restless spirits, and tide-called predators all hunger for a single misstep on the slick planks.",
            "weight": 0.95
        },
        {
            "title": "The Old Quarter",
            "tags": [
                "district",
                "outdoor",
                "street"
            ],
            "description": "Lean tenements huddle over cobbles carved with warding sigils now cracked and fading. Elders barricade their doorways as ancestral guardians stir against a brewing riot the watch refuses to quell.",
            "weight": 0.85
        },
        {
            "title": "Festival of Masks Unveiled",
            "tags": [
                "festival",
                "crowd",
                "market"
            ],
            "description": "Ribboned performers and masked revelers whirl beneath fireworks that spell omens in smoke. When a prophetic masque ends in a real abduction, the heroes must navigate jubilant chaos to unmask conspirators.",
            "weight": 1.35
        },
        {
            "title": "Guildhouse Heist Aftermath",
            "tags": [
                "guild",
                "heist",
                "indoor"
            ],
            "description": "Shattered vault wards and drifting illusion shards reveal a thieves\u2019 triumph hours too soon. Rival factions arrive in waves, each eager to pin blame or steal what the original crew missed.",
            "weight": 1.1
        },
        {
            "title": "Basilica of Echoing Confessions",
            "tags": [
                "temple",
                "indoor",
                "district"
            ],
            "description": "Sound-catcher domes preserve every whispered confession until the clergy release them in sonorous choruses. Tonight a vengeful chorus threatens to expose blackmail material unless the sanctum\u2019s curse is soothed.",
            "weight": 0.9
        },
        {
            "title": "Night Watch Mutiny",
            "tags": [
                "guard",
                "street",
                "riot"
            ],
            "description": "Barricades of overturned carts frame a standoff between loyalist captains and disgruntled rookies. The party must thread the line between diplomacy and derring-do before the city wakes to civil war.",
            "weight": 1.25
        },
        {
            "title": "Skybridge Duel at Dawn",
            "tags": [
                "rooftop",
                "bridge",
                "duel"
            ],
            "description": "A duelist\u2019s seconds tighten ceremonial harnesses as the river sunrise paints the elevated span in molten gold. Sabotaged anchors, hidden snipers, and hungry gargoyles mean honor is only one of many blades drawn.",
            "weight": 1.05
        },
        {
            "title": "Arcane Tram Derailment",
            "tags": [
                "transit",
                "arcane",
                "disaster"
            ],
            "description": "Lightning-fed rails shriek while a levitating tram car dangles above a plaza of panicked commuters. Stabilizing the conduit requires crowd control, counter-spells, and a race against plummeting wreckage.",
            "weight": 1.3
        },
        {
            "title": "Stormglass Conservatory Siege",
            "tags": [
                "conservatory",
                "indoor",
                "arcane"
            ],
            "description": "Crystalline greenhouses fracture under the strain of caged tempests now raging free. Elemental botanists plead for rescue as sentient vines and living hail duel beneath shimmering domes.",
            "weight": 0.95
        },
        {
            "title": "Moonlit Menagerie Escape",
            "tags": [
                "menagerie",
                "outdoor",
                "beasts"
            ],
            "description": "Exotic beasts prowl the moon-washed gardens after a sabotaged lock release. From chimeric songbirds to a melancholic manticore, each creature demands a different mix of empathy and strategy to corral.",
            "weight": 1.05
        },
        {
            "title": "Tax Collector's Uprising",
            "tags": [
                "bureaucracy",
                "protest",
                "street"
            ],
            "description": "Ledgers burn in braziers as clerks and citizens storm the civic countinghouse over a cursed levy. The crowd\u2019s fury hides a spectral auditor eager to balance the books with blood.",
            "weight": 0.9
        },
        {
            "title": "Cursed Foundry Reawakening",
            "tags": [
                "foundry",
                "industrial",
                "indoor"
            ],
            "description": "Molten channels spark to life in a long-shuttered foundry where golems once forged city defenses. Unchecked anima surges now seek new hosts among the living, forcing a desperate shutdown under blistering heat.",
            "weight": 1.15
        }
    ],
    "arctic": [
        {
            "title": "Frozen Wasteland Trek",
            "tags": [
                "wilderness",
                "outdoor",
                "openfield"
            ]
        },
        {
            "title": "The Avalanche Path",
            "tags": [
                "mountain",
                "outdoor",
                "path"
            ]
        },
        {
            "title": "Ice Cave Exploration",
            "tags": [
                "cave",
                "indoor",
                "cavern"
            ]
        },
        {
            "title": "Blizzard Survival",
            "tags": [
                "wilderness",
                "outdoor",
                "openfield"
            ]
        },
        {
            "title": "Glacier Crossing",
            "tags": [
                "glacier",
                "outdoor",
                "openfield"
            ]
        },
        {
            "title": "The Whiteout",
            "tags": [
                "wilderness",
                "outdoor",
                "openfield"
            ]
        },
        {
            "title": "Frostbite Pass",
            "tags": [
                "pass",
                "outdoor",
                "path"
            ]
        },
        {
            "title": "Icebound Peaks",
            "tags": [
                "mountain",
                "outdoor",
                "peaks"
            ]
        }
    ],
    "ocean": [
        {
            "title": "Storm-Tossed Voyage",
            "tags": [
                "ship",
                "vessel",
                "deck"
            ]
        },
        {
            "title": "The Coral Labyrinth",
            "tags": [
                "underwater",
                "reef",
                "natural"
            ]
        },
        {
            "title": "Derelict Ship Discovery",
            "tags": [
                "ship",
                "vessel",
                "wreck"
            ]
        },
        {
            "title": "Island Approach",
            "tags": [
                "shore",
                "outdoor",
                "beach"
            ]
        },
        {
            "title": "Deep Water Descent",
            "tags": [
                "underwater",
                "depths",
                "openwater"
            ]
        },
        {
            "title": "The Doldrums",
            "tags": [
                "ship",
                "vessel",
                "deck"
            ]
        },
        {
            "title": "Reef of Bones",
            "tags": [
                "underwater",
                "reef",
                "wreck"
            ]
        },
        {
            "title": "Siren's Channel",
            "tags": [
                "underwater",
                "passage",
                "natural"
            ]
        }
    ],
    "space": [
        {
            "title": "Derelict Spelljammer",
            "tags": [
                "ship",
                "vessel",
                "derelict"
            ]
        },
        {
            "title": "Phlogiston Crossing",
            "tags": [
                "wildspace",
                "void",
                "openspace"
            ]
        },
        {
            "title": "Crystal Sphere Breach",
            "tags": [
                "void",
                "anomaly",
                "openspace"
            ]
        },
        {
            "title": "Astral Debris Field",
            "tags": [
                "debris",
                "void",
                "openspace"
            ]
        },
        {
            "title": "Wildspace Anomaly",
            "tags": [
                "wildspace",
                "anomaly",
                "openspace"
            ]
        },
        {
            "title": "The Rainbow Flow",
            "tags": [
                "phlogiston",
                "void",
                "openspace"
            ]
        },
        {
            "title": "Sphere's Edge",
            "tags": [
                "boundary",
                "void",
                "openspace"
            ]
        },
        {
            "title": "Gravity Well",
            "tags": [
                "anomaly",
                "void",
                "openspace"
            ]
        },
        {
            "title": "Siege of the Living Voidship",
            "tags": [
                "ship",
                "void",
                "boarding",
                "living"
            ]
        },
        {
            "title": "Rescue at the Solar Flare Regatta",
            "tags": [
                "ship",
                "phlogiston",
                "storm",
                "rescue"
            ]
        },
        {
            "title": "Moondust Corsair Ambush",
            "tags": [
                "asteroid",
                "ambush",
                "pirates",
                "void"
            ]
        },
        {
            "title": "Chronal Drift Salvage",
            "tags": [
                "anomaly",
                "time",
                "salvage",
                "debris"
            ]
        },
        {
            "title": "Gith Armada Blockade",
            "tags": [
                "armada",
                "githyanki",
                "military",
                "void"
            ]
        },
        {
            "title": "Phlogiston Bloom Storm",
            "tags": [
                "phlogiston",
                "storm",
                "hazard",
                "wildspace"
            ]
        },
        {
            "title": "Nebula Sanctuary Negotiation",
            "tags": [
                "nebula",
                "diplomacy",
                "sanctuary",
                "void"
            ]
        },
        {
            "title": "Crystal Sphere Siegebreakers",
            "tags": [
                "crystalsphere",
                "siege",
                "battle",
                "void"
            ]
        },
        {
            "title": "Starbeast Migration Crossing",
            "tags": [
                "wildlife",
                "migration",
                "hazard",
                "void"
            ]
        },
        {
            "title": "Planar Observatory Heist",
            "tags": [
                "observatory",
                "heist",
                "structure",
                "void"
            ]
        }
    ],
    "crypt": [
        {
            "title": "The Ancient Tomb",
            "tags": [
                "tomb",
                "indoor",
                "chamber"
            ]
        },
        {
            "title": "Forgotten Catacombs",
            "tags": [
                "catacomb",
                "tunnel",
                "passage"
            ]
        },
        {
            "title": "Cursed Burial Chamber",
            "tags": [
                "chamber",
                "indoor",
                "tomb"
            ]
        },
        {
            "title": "The Silent Mausoleum",
            "tags": [
                "mausoleum",
                "building",
                "indoor"
            ]
        },
        {
            "title": "Necropolis Depths",
            "tags": [
                "catacomb",
                "tunnel",
                "depths"
            ]
        },
        {
            "title": "Ossuary Halls",
            "tags": [
                "hall",
                "indoor",
                "passage"
            ]
        },
        {
            "title": "The Sealed Vault",
            "tags": [
                "vault",
                "chamber",
                "indoor"
            ]
        },
        {
            "title": "Mourner's Path",
            "tags": [
                "passage",
                "tunnel",
                "path"
            ]
        }
    ],
    "forest": [
        {
            "title": "Dense Woodland Trail",
            "tags": [
                "trail",
                "outdoor",
                "path"
            ]
        },
        {
            "title": "The Overgrown Ruins",
            "tags": [
                "ruins",
                "structure",
                "outdoor"
            ]
        },
        {
            "title": "Ancient Grove",
            "tags": [
                "grove",
                "outdoor",
                "clearing"
            ]
        },
        {
            "title": "Forest of Whispers",
            "tags": [
                "woods",
                "outdoor",
                "dense"
            ]
        },
        {
            "title": "The Hidden Glade",
            "tags": [
                "glade",
                "outdoor",
                "clearing"
            ]
        },
        {
            "title": "Thornwood Passage",
            "tags": [
                "passage",
                "outdoor",
                "path"
            ]
        },
        {
            "title": "The Green Cathedral",
            "tags": [
                "grove",
                "outdoor",
                "clearing"
            ]
        },
        {
            "title": "Wildwood Maze",
            "tags": [
                "woods",
                "outdoor",
                "dense"
            ]
        }
    ],
    "desert": [
        {
            "title": "Scorching Dunes",
            "tags": [
                "dunes",
                "outdoor",
                "openfield"
            ]
        },
        {
            "title": "Oasis Mirage",
            "tags": [
                "oasis",
                "outdoor",
                "water"
            ]
        },
        {
            "title": "The Buried Temple",
            "tags": [
                "temple",
                "ruins",
                "structure"
            ]
        },
        {
            "title": "Canyon of Winds",
            "tags": [
                "canyon",
                "outdoor",
                "passage"
            ]
        },
        {
            "title": "Desert Caravan Route",
            "tags": [
                "trail",
                "outdoor",
                "path"
            ]
        },
        {
            "title": "The Glass Wastes",
            "tags": [
                "wasteland",
                "outdoor",
                "openfield"
            ]
        },
        {
            "title": "Sunscorch Valley",
            "tags": [
                "valley",
                "outdoor",
                "passage"
            ]
        },
        {
            "title": "Dune Sea Crossing",
            "tags": [
                "dunes",
                "outdoor",
                "openfield"
            ]
        }
    ],
    "mountain": [
        {
            "title": "Treacherous Peak",
            "tags": [
                "peak",
                "outdoor",
                "summit"
            ]
        },
        {
            "title": "The Mountain Pass",
            "tags": [
                "pass",
                "outdoor",
                "path"
            ]
        },
        {
            "title": "Cliffside Trail",
            "tags": [
                "cliff",
                "outdoor",
                "path"
            ]
        },
        {
            "title": "Summit Ascent",
            "tags": [
                "peak",
                "outdoor",
                "summit"
            ]
        },
        {
            "title": "The Hidden Valley",
            "tags": [
                "valley",
                "outdoor",
                "clearing"
            ]
        },
        {
            "title": "Eagle's Roost",
            "tags": [
                "peak",
                "outdoor",
                "nest"
            ]
        },
        {
            "title": "Stormbreak Ridge",
            "tags": [
                "ridge",
                "outdoor",
                "path"
            ]
        },
        {
            "title": "The Devil's Stair",
            "tags": [
                "stairs",
                "outdoor",
                "path"
            ]
        }
    ],
    "swamp": [
        {
            "title": "The Mire",
            "tags": [
                "bog",
                "outdoor",
                "wetland"
            ]
        },
        {
            "title": "Forgotten Wetlands",
            "tags": [
                "wetland",
                "outdoor",
                "wilderness"
            ]
        },
        {
            "title": "Bog of Despair",
            "tags": [
                "bog",
                "outdoor",
                "wetland"
            ]
        },
        {
            "title": "Murky Waters",
            "tags": [
                "water",
                "outdoor",
                "wetland"
            ]
        },
        {
            "title": "The Dead Marsh",
            "tags": [
                "marsh",
                "outdoor",
                "wetland"
            ]
        },
        {
            "title": "Rotwood Fen",
            "tags": [
                "fen",
                "outdoor",
                "wetland"
            ]
        },
        {
            "title": "The Sinking Grounds",
            "tags": [
                "bog",
                "outdoor",
                "wetland"
            ]
        },
        {
            "title": "Viper's Bog",
            "tags": [
                "bog",
                "outdoor",
                "wetland"
            ]
        }
    ],
    "underground": [
        {
            "title": "Cavern Depths",
            "tags": [
                "cavern",
                "cave",
                "natural"
            ]
        },
        {
            "title": "The Sunless Expanse",
            "tags": [
                "cavern",
                "cave",
                "openspace"
            ]
        },
        {
            "title": "Crystal Caves",
            "tags": [
                "cave",
                "cavern",
                "natural"
            ]
        },
        {
            "title": "Underground River",
            "tags": [
                "river",
                "cave",
                "water"
            ]
        },
        {
            "title": "The Forgotten Mine",
            "tags": [
                "mine",
                "tunnel",
                "manmade"
            ]
        },
        {
            "title": "Echoing Halls",
            "tags": [
                "hall",
                "cavern",
                "chamber"
            ]
        },
        {
            "title": "The Deepways",
            "tags": [
                "tunnel",
                "passage",
                "manmade"
            ]
        },
        {
            "title": "Stonewomb Passage",
            "tags": [
                "passage",
                "tunnel",
                "natural"
            ]
        }
    ]
};

        let locationObjects = {
    "urban": {
        "warehouse": {
            "tags": [
                "warehouse",
                "indoor",
                "building"
            ],
            "primary": [
                "wooden crate",
                "loading crane",
                "storage shelf",
                "shipping manifest",
                "rope coil",
                "tool bench"
            ],
            "secondary": [
                "rusted nail",
                "receipt",
                "ledger book",
                "oil lantern",
                "chain",
                "pulley"
            ],
            "tertiary": [
                "coin purse",
                "jewelry",
                "letter",
                "key",
                "trap mechanism",
                "poison vial"
            ]
        },
        "building": {
            "tags": [
                "building",
                "indoor",
                "rooftop",
                "district"
            ],
            "primary": [
                "ornate desk",
                "locked safe",
                "bookshelf",
                "filing cabinet",
                "portrait painting",
                "fireplace"
            ],
            "secondary": [
                "hidden drawer",
                "secret compartment",
                "ledger",
                "correspondence",
                "seal",
                "inkwell"
            ],
            "tertiary": [
                "family heirloom",
                "deed",
                "treasure map",
                "incriminating letter",
                "gold coins",
                "magic item"
            ]
        },
        "street": {
            "tags": [
                "street",
                "outdoor",
                "alley",
                "district",
                "market"
            ],
            "primary": [
                "market stall",
                "merchant cart",
                "street lamp",
                "notice board",
                "vendor stand",
                "fountain"
            ],
            "secondary": [
                "loose cobblestone",
                "rain barrel",
                "awning",
                "signpost",
                "doorway",
                "window"
            ],
            "tertiary": [
                "dropped coin",
                "torn poster",
                "hidden cache",
                "secret mark",
                "smuggler sign",
                "trap"
            ]
        },
        "dock": {
            "tags": [
                "wharf",
                "dock",
                "outdoor"
            ],
            "primary": [
                "shipping crate",
                "mooring post",
                "cargo net",
                "dock crane",
                "warehouse door",
                "gangplank"
            ],
            "secondary": [
                "rope",
                "anchor",
                "barrel",
                "canvas tarp",
                "shipping manifest",
                "oil lamp"
            ],
            "tertiary": [
                "smuggled goods",
                "hidden compartment",
                "coded message",
                "stolen treasure",
                "trap",
                "key"
            ]
        },
        "sewer": {
            "tags": [
                "sewer",
                "underground",
                "tunnel"
            ],
            "primary": [
                "drainage pipe",
                "sewer grate",
                "maintenance ladder",
                "brick archway",
                "water channel",
                "junction"
            ],
            "secondary": [
                "rat nest",
                "debris pile",
                "broken gate",
                "rusty valve",
                "slime",
                "chain"
            ],
            "tertiary": [
                "lost valuables",
                "body",
                "smuggler cache",
                "disease",
                "trap",
                "monster lair"
            ]
        },
        "skybridge": {
            "tags": [
                "skybridge",
                "rooftop",
                "outdoor",
                "bridge"
            ],
            "description": "Suspended between rival guild towers, the skybridge trembles with dawn winds and unresolved grudges. Every cable hums with latent magic that keeps the city moving far below.",
            "primary": [
                "suspension cables humming with latent magic",
                "ornate stone balustrade etched with duelist crests",
                "lantern pylons casting rainbows through morning mist",
                "banner-strewn archway leading into guild towers",
                "watchpost alcove overlooking the river docks",
                "emergency winch platform secured with brass locks"
            ],
            "secondary": [
                "tethered dueling harness draped over a railing",
                "discarded glove stamped with a noble seal",
                "loose paving stone hiding a grappling hook clamp",
                "maintenance hatch leading into the tower interior",
                "chalked boundary line for formal challenges",
                "sightline to a concealed crossbow perch"
            ],
            "tertiary": [
                "folded ransom note weighted by a silver coin",
                "concealed wand sheath wedged beneath the balustrade",
                "clockwork raven relay awaiting whispered orders",
                "spent alchemical flare lodged in the railing",
                "gemstone dust marking sabotage runes",
                "coil of silken rope with a dangerously frayed section"
            ]
        },
        "maskmakers_guildhall": {
            "tags": [
                "guildhall",
                "indoor",
                "artisanal"
            ],
            "description": "Velvet drapes, perfumed steam, and disciplined apprentices cloak the guildhall in theatrical mystique. The slightest breeze sends jeweled masks whispering like gossip against the walls.",
            "primary": [
                "grand showroom lined with mannequins in seasonal regalia",
                "engraving studio with mirror-bright tools",
                "vaulted ceiling mural depicting historic galas",
                "apprentice workshop buzzing with illusion magic",
                "sealed vault door embossed with the guild sigil",
                "ledger table stacked with commission contracts"
            ],
            "secondary": [
                "mask molds carved from rare heartwood",
                "racks of scented lacquer vials",
                "discarded ticket stubs from recent performances",
                "secret trapdoor concealed beneath layered carpet",
                "whispering illusion that reenacts famous scandals",
                "spyglass trained on the plaza outside"
            ],
            "tertiary": [
                "blackmail ledger tucked inside a gilt mask",
                "vial of sleep-inducing incense blend",
                "encrypted invitation to a rival guild soiree",
                "hidden compartment containing counterfeit seals",
                "promise note from a debtor noble",
                "glimmering spirit mask that speaks truths unasked"
            ]
        },
        "arcane_tram_depot": {
            "tags": [
                "transit",
                "industrial",
                "indoor"
            ],
            "description": "Crystal rails and brass couplings crackle with residual lightning as workers scramble to calm the depot. The air smells of ozone and hot copper whenever a tram arrives too quickly.",
            "primary": [
                "levitating tram car suspended in maintenance cradle",
                "conductor's control dais surrounded by safety sigils",
                "rack of insulated harnesses for line workers",
                "dispatch board mapping city routes in light",
                "emergency aether dampener anchored to the floor",
                "tool trolley bristling with arc-wrenches"
            ],
            "secondary": [
                "scorch-marked panel awaiting repair",
                "stack of commuter complaints bound with ribbon",
                "arc flash shield leaning against a column",
                "maintenance log etched into glass tablet",
                "warning placard listing evacuation procedures",
                "spare focusing crystals stored in padded cases"
            ],
            "tertiary": [
                "prototype speed governor hidden under a tarp",
                "smuggled cargo crate mislabeled as scrap",
                "encrypted schedule chip containing extra stops",
                "bundle of bribe notes for inspector lookaways",
                "sympathetic charm binding two tram conductors",
                "unstable lightning elemental trapped in a flask"
            ]
        },
        "moonlit_menagerie": {
            "tags": [
                "menagerie",
                "outdoor",
                "garden"
            ],
            "description": "Fragrant nightbloom flowers mingle with the musk of exotic beasts roaming free of their enclosures. Bioluminescent insects trace anxious constellations above the pathways.",
            "primary": [
                "star-lit aviary dome with prismatic glass panes",
                "serene reflecting pool doubling as a selkie habitat",
                "caretaker kiosk stocked with calming draughts",
                "ornamental hedge maze concealing hidden pens",
                "stone amphitheater for animal training displays",
                "runed gate that responds to keeper whistles"
            ],
            "secondary": [
                "scattered feed buckets tipped by panicked creatures",
                "broken latch hanging from a griffon roost",
                "trail of luminescent fur leading into the gardens",
                "scribbled feeding schedule pinned to a post",
                "abandoned spectator cloak marked with noble crest",
                "quiet alarm bell disabled by cut wires"
            ],
            "tertiary": [
                "cracked crate that once housed a miniature dragon",
                "tranquilizing blowgun with empty darts",
                "secret adoption contract for an illegal familiar",
                "map of underground escape tunnels for beasts",
                "enchanted collar that compels obedience",
                "unhatched egg pulsing with latent magic"
            ]
        },
        "stormglass_conservatory": {
            "tags": [
                "conservatory",
                "arcane",
                "indoor"
            ],
            "description": "Glass spires chime in the wind while contained squalls flash across enchanted terrariums. Scholars hurry between habitats, chasing weather phenomena in miniature.",
            "primary": [
                "cyclone terrarium contained by sigil-laced glass",
                "humidity regulator shaped like a silver tree",
                "research dais covered in pressure gauges",
                "stormglass petals refracting multicolored light",
                "spiral staircase leading to observation balcony",
                "arcane sluice routing rainwater into reservoirs"
            ],
            "secondary": [
                "loose runic clamp sparking erratically",
                "journal detailing forecast experiments",
                "protective cloak woven from water-repellent silk",
                "lantern fueled by bottled lightning",
                "case of emergency grounding rods",
                "collection of thunderstone seeds ready to bloom"
            ],
            "tertiary": [
                "sentient vine specimen seeking new soil",
                "sealed note from a saboteur demanding funding",
                "prototype weather wand calibrated for hurricanes",
                "rare pollen that induces prophetic dreams",
                "dimensional leak whispering with storm spirits",
                "booby-trapped toolbox rigged to explode in rain"
            ]
        },
        "clockwork_foundry": {
            "tags": [
                "foundry",
                "industrial",
                "indoor"
            ],
            "description": "Molten metal glows beneath gantries crowded with articulated arms and pacing foremen. The heartbeat of pistons reverberates through the bones of anyone inside.",
            "primary": [
                "central smelting crucible fed by fire elementals",
                "assembly line of half-finished guardian constructs",
                "control balcony overlooking stamping presses",
                "rack of modular armor plating in various sizes",
                "cooling trough bubbling with tempering oils",
                "vault door leading to blueprint archives"
            ],
            "secondary": [
                "slag heap glittering with valuable scrap",
                "abacus tallying production quotas",
                "overheated pressure gauge venting steam",
                "worker locker stuffed with protective gear",
                "toolbox containing precision tuning forks",
                "work roster with names hastily scratched out"
            ],
            "tertiary": [
                "rune-stamped schematic revealing forbidden designs",
                "residual anima crystal craving a new host",
                "strike fund hidden beneath loose floorboards",
                "dormant golem heart waiting to ignite",
                "unpaid invoice to a mercenary company",
                "emergency shutoff lever jammed with slag"
            ]
        },
        "hidden_resistance_safehouse": {
            "tags": [
                "safehouse",
                "underground",
                "alley"
            ],
            "description": "A humble soup kitchen hides a labyrinth of escape tunnels, message drops, and loyal lookouts. Lantern light is hooded, and every greeting is a test phrase.",
            "primary": [
                "cellar entrance concealed behind flour sacks",
                "chalkboard menu masking coded directives",
                "meeting table carved with insurgent slogans",
                "lockbox filled with forged travel papers",
                "narrow tunnel leading to the sewer network",
                "makeshift infirmary stocked with contraband salves"
            ],
            "secondary": [
                "rotating pantry shelf that opens a hidden passage",
                "pinned map riddled with colored string routes",
                "stash of plain cloaks for fast disguises",
                "listening tube connected to street-level grate",
                "symbolic relic of a fallen revolutionary",
                "pair of messenger pigeons cooing softly"
            ],
            "tertiary": [
                "sealed orders naming the next target of sabotage",
                "coded confession from an embedded spy",
                "cache of emeralds funding the resistance",
                "knock sequence engraved on a copper coin",
                "portable sending stone tuned to allies",
                "trapdoor rigged with sleeping gas for intruders"
            ]
        },
        "floating_bazaar": {
            "tags": [
                "market",
                "floating",
                "outdoor"
            ],
            "description": "Linked barges bob against the river current while lanterns cast jeweled light over eager shoppers. Bargaining happens as much with secrets as with coin.",
            "primary": [
                "central barter raft stacked with rare spices",
                "rope bridges connecting brightly painted stalls",
                "river shamans chanting for calm waters",
                "entertainers juggling fireflies in glass globes",
                "driftwood shrine honoring river spirits",
                "ledger booth for customs inspectors"
            ],
            "secondary": [
                "hidden keelboat loaded with contraband",
                "clinking string of barter tokens",
                "net of glittering fish offered as payment",
                "folding stage for sudden performances",
                "tethered guard drake dozing beside a post",
                "weathered chart of shifting sandbars"
            ],
            "tertiary": [
                "smuggler's code etched beneath a crate",
                "sealed jar containing a wish-granting minnow",
                "secret contract binding a merchant prince",
                "glass ampoule of river curse antidote",
                "escape rope anchored for a quick getaway",
                "assassin's garrote hidden in a silk sash"
            ]
        },
        "city_watch_barracks": {
            "tags": [
                "barracks",
                "guard",
                "indoor"
            ],
            "description": "Banners bearing the city crest hang above rows of neatly made bunks and polished armor racks. The scent of oil, steel, and strong tea keeps the watch sharp between patrols.",
            "primary": [
                "mess hall full of half-finished breakfasts",
                "armory cage lined with spears and tower shields",
                "briefing dais showcasing active patrol routes",
                "evidence locker secured with arcane wards",
                "sparring ring ringed by practice dummies",
                "captain's office overlooking the courtyard"
            ],
            "secondary": [
                "disciplinary board listing recent infractions",
                "locked chest of confiscated contraband",
                "stack of requisition forms awaiting signatures",
                "training manuals annotated with field notes",
                "wall of commendations for brave service",
                "pigeon coop used for urgent alerts"
            ],
            "tertiary": [
                "unsigned arrest warrant implicating a noble",
                "hidden flask tucked behind a duty roster",
                "emergency whistle tuned to resonate citywide wards",
                "favor chit owed by an influential guildmaster",
                "encoded patrol schedule indicating a planned mutiny",
                "secret ledger documenting protection rackets"
            ]
        },
        "echoing_basilica": {
            "tags": [
                "temple",
                "indoor",
                "acoustic"
            ],
            "description": "Every whisper blossoms into a choir beneath the basilica's resonance domes. Penitent candles flicker in time with the echoes, revealing sins long suppressed.",
            "primary": [
                "choir loft suspended above marble nave",
                "confessional alcoves veiled by velvet curtains",
                "resonance bell attuned to spoken truths",
                "mosaic floor depicting civic heroes kneeling",
                "sacristy cabinet filled with sanctified relics",
                "archives chamber storing confession transcripts"
            ],
            "secondary": [
                "incense brazier that amplifies spoken words",
                "scribbled sermon notes hinting at scandal",
                "acoustic focus crystal humming with energy",
                "collection plate overflowing with anonymous coins",
                "warden's staff inlaid with silence runes",
                "hidden stairway to rooftop observation deck"
            ],
            "tertiary": [
                "sealed letter threatening public revelation",
                "atonement mask whispering secrets of past wearers",
                "banned treatise on manipulating the basilica echoes",
                "crypt key disguised as rosary beads",
                "scroll promising absolution in exchange for treachery",
                "ethereal choir member bound to a silver cage"
            ]
        }
    },
    "crypt": {
        "tomb": {
            "tags": [
                "tomb",
                "chamber",
                "indoor"
            ],
            "primary": [
                "stone sarcophagus",
                "altar",
                "statue",
                "burial niche",
                "stone column",
                "brazier"
            ],
            "secondary": [
                "burial offering",
                "inscription",
                "sealed urn",
                "canopic jar",
                "ritual item",
                "relic"
            ],
            "tertiary": [
                "cursed item",
                "treasure",
                "magic weapon",
                "ancient scroll",
                "undead",
                "trap"
            ]
        },
        "catacomb": {
            "tags": [
                "catacomb",
                "tunnel",
                "passage",
                "depths"
            ],
            "primary": [
                "bone wall",
                "burial alcove",
                "stone pillar",
                "ancient archway",
                "ossuary",
                "memorial plaque"
            ],
            "secondary": [
                "skull pile",
                "grave goods",
                "ancient torch",
                "carved symbol",
                "sealed niche",
                "offering bowl"
            ],
            "tertiary": [
                "hidden treasure",
                "secret passage",
                "cursed relic",
                "undead guardian",
                "trap",
                "ritual chamber"
            ]
        },
        "mausoleum": {
            "tags": [
                "mausoleum",
                "building",
                "indoor"
            ],
            "primary": [
                "family crypt",
                "marble statue",
                "bronze door",
                "stone bench",
                "memorial wall",
                "vaulted ceiling"
            ],
            "secondary": [
                "inscription plaque",
                "offering table",
                "sealed vault",
                "stained glass",
                "iron gate",
                "torch sconce"
            ],
            "tertiary": [
                "family treasure",
                "ancient relic",
                "magic item",
                "hidden crypt",
                "undead",
                "protective ward"
            ]
        },
        "vault": {
            "tags": [
                "vault",
                "chamber",
                "indoor"
            ],
            "primary": [
                "sealed door",
                "guardian statue",
                "treasure chest",
                "magical ward",
                "puzzle lock",
                "pillar"
            ],
            "secondary": [
                "pressure plate",
                "glyph",
                "keyhole",
                "offering pedestal",
                "ancient mechanism",
                "rune"
            ],
            "tertiary": [
                "legendary treasure",
                "artifact",
                "curse",
                "powerful undead",
                "deadly trap",
                "magic seal"
            ]
        }
    },
    "forest": {
        "trail": {
            "tags": [
                "trail",
                "path",
                "outdoor"
            ],
            "primary": [
                "ancient tree",
                "moss-covered boulder",
                "trail marker",
                "fallen log",
                "clearing",
                "stream crossing"
            ],
            "secondary": [
                "animal track",
                "carved mark",
                "abandoned camp",
                "broken branch",
                "root system",
                "mushroom circle"
            ],
            "tertiary": [
                "hidden cache",
                "druid sign",
                "fey marking",
                "treasure",
                "trap",
                "monster lair"
            ]
        },
        "ruins": {
            "tags": [
                "ruins",
                "structure",
                "outdoor"
            ],
            "primary": [
                "crumbling wall",
                "stone foundation",
                "overgrown statue",
                "collapsed archway",
                "broken column",
                "moss-covered altar"
            ],
            "secondary": [
                "ancient inscription",
                "carved relief",
                "pottery shard",
                "rusted weapon",
                "stone fragment",
                "hidden chamber"
            ],
            "tertiary": [
                "buried treasure",
                "magic item",
                "ancient knowledge",
                "guardian spirit",
                "trap",
                "secret passage"
            ]
        },
        "clearing": {
            "tags": [
                "clearing",
                "glade",
                "grove",
                "outdoor"
            ],
            "primary": [
                "fairy ring",
                "natural spring",
                "ancient tree circle",
                "flower meadow",
                "stone circle",
                "sacred grove"
            ],
            "secondary": [
                "unusual plant",
                "animal den",
                "bird nest",
                "mushroom cluster",
                "water source",
                "wildflower patch"
            ],
            "tertiary": [
                "fey presence",
                "magic spring",
                "druid treasure",
                "nature spirit",
                "blessing",
                "curse"
            ]
        },
        "dense": {
            "tags": [
                "woods",
                "dense",
                "outdoor"
            ],
            "primary": [
                "thick undergrowth",
                "tangled thicket",
                "hollow log",
                "dense canopy",
                "bramble patch",
                "ancient trunk"
            ],
            "secondary": [
                "animal burrow",
                "spider web",
                "vine tangle",
                "thorny bush",
                "concealed pit",
                "hidden path"
            ],
            "tertiary": [
                "monster lair",
                "hidden treasure",
                "trap",
                "rare plant",
                "secret passage",
                "predator nest"
            ]
        }
    },
    "desert": {
        "dunes": {
            "tags": [
                "dunes",
                "openfield",
                "outdoor",
                "wasteland"
            ],
            "primary": [
                "sand dune",
                "wind-carved formation",
                "buried skeleton",
                "abandoned cart",
                "rock outcrop",
                "shifting sand"
            ],
            "secondary": [
                "sun-bleached bones",
                "tattered cloth",
                "broken wheel",
                "empty waterskin",
                "scorpion nest",
                "sand ripples"
            ],
            "tertiary": [
                "buried treasure",
                "ancient artifact",
                "oasis map",
                "cursed item",
                "monster lair",
                "quicksand trap"
            ]
        },
        "ruins": {
            "tags": [
                "temple",
                "ruins",
                "structure"
            ],
            "primary": [
                "weathered stone pillar",
                "collapsed wall",
                "buried entrance",
                "ancient altar",
                "sandstone block",
                "hieroglyph"
            ],
            "secondary": [
                "carved relief",
                "broken statue",
                "pottery fragment",
                "ritual vessel",
                "stone tablet",
                "sealed chamber"
            ],
            "tertiary": [
                "ancient treasure",
                "magic artifact",
                "curse tablet",
                "mummy",
                "deadly trap",
                "hidden vault"
            ]
        },
        "oasis": {
            "tags": [
                "oasis",
                "water",
                "outdoor"
            ],
            "primary": [
                "oasis pool",
                "palm tree",
                "water source",
                "desert plants",
                "rock formation",
                "shade"
            ],
            "secondary": [
                "animal track",
                "fruit tree",
                "medicinal herb",
                "cool cave",
                "traveler marker",
                "campsite"
            ],
            "tertiary": [
                "hidden spring",
                "rare plant",
                "treasure cache",
                "spirit guardian",
                "blessing",
                "mirage"
            ]
        },
        "trail": {
            "tags": [
                "trail",
                "path",
                "outdoor"
            ],
            "primary": [
                "caravan marker",
                "desert trail",
                "way stone",
                "traveler's shrine",
                "cairn",
                "directional sign"
            ],
            "secondary": [
                "campfire remains",
                "discarded item",
                "footprints",
                "warning marker",
                "supply cache",
                "shelter"
            ],
            "tertiary": [
                "buried treasure",
                "ambush site",
                "hidden oasis map",
                "bandit cache",
                "trap",
                "ancient relic"
            ]
        }
    },
    "mountain": {
        "peak": {
            "tags": [
                "peak",
                "summit",
                "outdoor",
                "nest"
            ],
            "primary": [
                "mountain peak",
                "rocky outcrop",
                "ice formation",
                "summit cairn",
                "wind-swept stone",
                "precipice"
            ],
            "secondary": [
                "prayer flags",
                "climber's anchor",
                "eagle nest",
                "ice crystal",
                "rock shelter",
                "marker stone"
            ],
            "tertiary": [
                "legendary treasure",
                "dragon hoard",
                "ancient relic",
                "rare mineral",
                "spirit shrine",
                "trap"
            ]
        },
        "pass": {
            "tags": [
                "pass",
                "path",
                "outdoor",
                "ridge",
                "stairs"
            ],
            "primary": [
                "mountain pass",
                "narrow ledge",
                "switchback trail",
                "rock bridge",
                "stone steps",
                "guard post"
            ],
            "secondary": [
                "rope anchor",
                "safety rope",
                "trail marker",
                "shelter cave",
                "warning sign",
                "avalanche zone"
            ],
            "tertiary": [
                "hidden cache",
                "bandit treasure",
                "ancient marker",
                "trap",
                "monster ambush",
                "secret passage"
            ]
        },
        "valley": {
            "tags": [
                "valley",
                "clearing",
                "outdoor"
            ],
            "primary": [
                "hidden valley",
                "mountain stream",
                "alpine meadow",
                "sheltered grove",
                "rocky basin",
                "waterfall"
            ],
            "secondary": [
                "wildflower field",
                "grazing area",
                "mineral deposit",
                "hot spring",
                "cave entrance",
                "ancient tree"
            ],
            "tertiary": [
                "hidden sanctuary",
                "hermit dwelling",
                "rare herb",
                "treasure cache",
                "spirit guardian",
                "secret entrance"
            ]
        },
        "cliff": {
            "tags": [
                "cliff",
                "outdoor",
                "path"
            ],
            "primary": [
                "precarious ledge",
                "cliff face",
                "sheer drop",
                "rock overhang",
                "narrow path",
                "vertical wall"
            ],
            "secondary": [
                "climbing anchor",
                "bird nest",
                "cave opening",
                "rock shelf",
                "erosion crack",
                "loose stone"
            ],
            "tertiary": [
                "hidden cave",
                "eagle treasure",
                "ancient carving",
                "trap",
                "monster lair",
                "secret passage"
            ]
        }
    },
    "swamp": {
        "bog": {
            "tags": [
                "bog",
                "wetland",
                "outdoor"
            ],
            "primary": [
                "murky pool",
                "mud mound",
                "gnarled tree",
                "quicksand",
                "stagnant water",
                "dead vegetation"
            ],
            "secondary": [
                "marsh gas bubble",
                "sunken log",
                "lily pad",
                "insect swarm",
                "muddy bank",
                "rotting vegetation"
            ],
            "tertiary": [
                "sunken treasure",
                "body",
                "monster lair",
                "disease",
                "trap",
                "cursed area"
            ]
        },
        "wetland": {
            "tags": [
                "wetland",
                "marsh",
                "fen",
                "outdoor",
                "wilderness"
            ],
            "primary": [
                "marsh grass",
                "water channel",
                "raised hummock",
                "dead tree",
                "reed bed",
                "shallow pool"
            ],
            "secondary": [
                "bird nest",
                "fish trap",
                "willow tree",
                "stepping stone",
                "floating debris",
                "vegetation mat"
            ],
            "tertiary": [
                "hidden path",
                "hermit hut",
                "rare plant",
                "treasure cache",
                "hag marker",
                "trap"
            ]
        },
        "water": {
            "tags": [
                "water",
                "outdoor",
                "wetland"
            ],
            "primary": [
                "dark water",
                "stagnant pool",
                "flowing stream",
                "deep channel",
                "murky pond",
                "water source"
            ],
            "secondary": [
                "submerged log",
                "floating vegetation",
                "water plant",
                "ripple",
                "current",
                "shallow ford"
            ],
            "tertiary": [
                "sunken boat",
                "underwater cave",
                "monster lair",
                "treasure",
                "trap",
                "cursed water"
            ]
        }
    },
    "underground": {
        "cavern": {
            "tags": [
                "cavern",
                "cave",
                "natural",
                "openspace",
                "chamber"
            ],
            "primary": [
                "crystal formation",
                "stone pillar",
                "underground lake",
                "stalactite cluster",
                "rock formation",
                "cavern floor"
            ],
            "secondary": [
                "mineral vein",
                "bat colony",
                "mushroom grove",
                "limestone deposit",
                "water drip",
                "echo chamber"
            ],
            "tertiary": [
                "rare crystal",
                "underground river",
                "monster lair",
                "treasure deposit",
                "trap",
                "secret passage"
            ]
        },
        "tunnel": {
            "tags": [
                "tunnel",
                "passage",
                "manmade"
            ],
            "primary": [
                "mine shaft",
                "carved tunnel",
                "support beams",
                "rail tracks",
                "tool marks",
                "ventilation shaft"
            ],
            "secondary": [
                "mining cart",
                "pickaxe",
                "lantern hook",
                "ore vein",
                "support pillar",
                "wooden brace"
            ],
            "tertiary": [
                "ore deposit",
                "abandoned equipment",
                "collapsed section",
                "monster nest",
                "trap",
                "hidden passage"
            ]
        },
        "river": {
            "tags": [
                "river",
                "water",
                "cave"
            ],
            "primary": [
                "underground stream",
                "water channel",
                "rock bridge",
                "waterfall",
                "river bank",
                "current"
            ],
            "secondary": [
                "stepping stone",
                "water pool",
                "mineral deposit",
                "moisture",
                "echo",
                "fish"
            ],
            "tertiary": [
                "underwater passage",
                "treasure",
                "monster lair",
                "rare mineral",
                "trap",
                "secret cave"
            ]
        }
    },
    "ocean": {
        "ship": {
            "tags": [
                "ship",
                "vessel",
                "deck"
            ],
            "primary": [
                "ship wheel",
                "mast rigging",
                "cargo hold",
                "captain's quarters",
                "main deck",
                "anchor"
            ],
            "secondary": [
                "rope coil",
                "barrel",
                "sail",
                "navigation tool",
                "ship bell",
                "cannon"
            ],
            "tertiary": [
                "treasure chest",
                "ship's log",
                "hidden cargo",
                "secret compartment",
                "trap",
                "contraband"
            ]
        },
        "wreck": {
            "tags": [
                "wreck",
                "ship",
                "vessel",
                "underwater"
            ],
            "primary": [
                "broken hull",
                "sunken cargo",
                "ship's skeleton",
                "barnacle-covered mast",
                "debris field",
                "coral growth"
            ],
            "secondary": [
                "rotted sail",
                "rusted chain",
                "broken rudder",
                "scattered cargo",
                "ship bell",
                "anchor"
            ],
            "tertiary": [
                "treasure chest",
                "ship's safe",
                "captain's loot",
                "cursed cargo",
                "monster lair",
                "trap"
            ]
        },
        "underwater": {
            "tags": [
                "underwater",
                "reef",
                "natural",
                "depths",
                "openwater",
                "passage"
            ],
            "primary": [
                "coral reef",
                "underwater cave",
                "kelp forest",
                "rock formation",
                "sea floor",
                "current"
            ],
            "secondary": [
                "sea plant",
                "anemone",
                "shell cluster",
                "fish school",
                "underwater cliff",
                "sand bed"
            ],
            "tertiary": [
                "pearl bed",
                "sunken treasure",
                "monster lair",
                "ancient ruin",
                "trap",
                "magic current"
            ]
        },
        "shore": {
            "tags": [
                "shore",
                "beach",
                "outdoor"
            ],
            "primary": [
                "beach shore",
                "tide pool",
                "driftwood pile",
                "rock outcrop",
                "sand beach",
                "wave line"
            ],
            "secondary": [
                "seashell",
                "seaweed",
                "crab",
                "beach rock",
                "sand dune",
                "flotsam"
            ],
            "tertiary": [
                "message bottle",
                "shipwreck debris",
                "treasure chest",
                "rare shell",
                "trap",
                "hidden cave"
            ]
        }
    },
    "arctic": {
        "wilderness": {
            "tags": [
                "wilderness",
                "openfield",
                "outdoor"
            ],
            "primary": [
                "ice field",
                "snow plain",
                "frozen tundra",
                "ice wall",
                "snowdrift",
                "frost formation"
            ],
            "secondary": [
                "animal track",
                "ice crack",
                "wind pattern",
                "snow hole",
                "frozen plant",
                "ice shard"
            ],
            "tertiary": [
                "frozen corpse",
                "buried treasure",
                "rare resource",
                "monster lair",
                "trap",
                "ancient relic"
            ]
        },
        "cave": {
            "tags": [
                "cave",
                "cavern",
                "indoor"
            ],
            "primary": [
                "ice cave",
                "snow shelter",
                "frozen cavern",
                "ice tunnel",
                "frost wall",
                "icicle"
            ],
            "secondary": [
                "ice formation",
                "frozen pool",
                "ice pillar",
                "snow drift",
                "frost pattern",
                "wind tunnel"
            ],
            "tertiary": [
                "frozen treasure",
                "ancient remains",
                "rare ice",
                "monster den",
                "trap",
                "magic ice"
            ]
        },
        "mountain": {
            "tags": [
                "mountain",
                "peaks",
                "outdoor"
            ],
            "primary": [
                "ice peak",
                "frozen summit",
                "glacier slope",
                "ice cliff",
                "snow ridge",
                "avalanche path"
            ],
            "secondary": [
                "ice bridge",
                "crevasse",
                "snow cornice",
                "ice wall",
                "frozen waterfall",
                "wind gap"
            ],
            "tertiary": [
                "legendary treasure",
                "dragon lair",
                "ancient shrine",
                "rare mineral",
                "trap",
                "avalanche trigger"
            ]
        },
        "path": {
            "tags": [
                "path",
                "pass",
                "outdoor"
            ],
            "primary": [
                "frozen trail",
                "ice path",
                "snow route",
                "marked way",
                "passage",
                "crossing"
            ],
            "secondary": [
                "trail marker",
                "shelter",
                "supply cache",
                "warning sign",
                "rope line",
                "cairn"
            ],
            "tertiary": [
                "hidden cache",
                "abandoned camp",
                "treasure",
                "trap",
                "monster ambush",
                "shortcut"
            ]
        }
    },
    "space": {
        "ship": {
            "tags": [
                "ship",
                "vessel",
                "derelict"
            ],
            "primary": [
                "spelljamming helm",
                "navigation altar",
                "air envelope",
                "gravity plane",
                "helm chamber",
                "main deck"
            ],
            "secondary": [
                "star chart",
                "planar compass",
                "magic anchor",
                "air pump",
                "gravity ring",
                "void seal"
            ],
            "tertiary": [
                "arcane treasure",
                "planar map",
                "magic artifact",
                "ship secret",
                "trap",
                "hidden cargo"
            ]
        },
        "void": {
            "tags": [
                "void",
                "openspace",
                "wildspace",
                "phlogiston",
                "boundary"
            ],
            "primary": [
                "phlogiston flow",
                "wildspace debris",
                "crystal sphere",
                "planar barrier",
                "void current",
                "star field"
            ],
            "secondary": [
                "asteroid",
                "void eddy",
                "magic field",
                "planar echo",
                "cosmic dust",
                "light phenomenon"
            ],
            "tertiary": [
                "ancient wreck",
                "planar rift",
                "cosmic treasure",
                "void entity",
                "trap",
                "portal"
            ]
        },
        "anomaly": {
            "tags": [
                "anomaly",
                "void",
                "openspace",
                "wildspace"
            ],
            "primary": [
                "gravity well",
                "magic vortex",
                "planar rift",
                "time distortion",
                "space fold",
                "reality tear"
            ],
            "secondary": [
                "energy field",
                "temporal echo",
                "spatial loop",
                "magic surge",
                "void pulse",
                "reality fragment"
            ],
            "tertiary": [
                "legendary artifact",
                "planar gateway",
                "cosmic secret",
                "powerful entity",
                "deadly trap",
                "reality breach"
            ]
        },
        "debris": {
            "tags": [
                "debris",
                "void",
                "openspace"
            ],
            "primary": [
                "wrecked ship",
                "floating rock",
                "debris field",
                "broken hull",
                "scattered cargo",
                "void junk"
            ],
            "secondary": [
                "ship fragment",
                "asteroid chunk",
                "twisted metal",
                "broken mast",
                "cargo container",
                "escape pod"
            ],
            "tertiary": [
                "salvage treasure",
                "ship log",
                "hidden cargo",
                "survivor",
                "trap",
                "monster nest"
            ]
        },
        "spelljammer_bridge": {
            "tags": [
                "ship",
                "bridge",
                "command",
                "void"
            ],
            "primary": [
                "spelljamming helm dais",
                "captain's astrolabe",
                "constellation chart table",
                "command sigil console",
                "panoramic crystal viewport",
                "gravity plane ladder"
            ],
            "secondary": [
                "star chart vellum",
                "arcane relay conduit",
                "whispering sending stone",
                "captain's log sphere",
                "emergency aether lever",
                "battle standard rack"
            ],
            "tertiary": [
                "hidden mutiny cache",
                "encrypted orders cylinder",
                "prototype helm core",
                "loyalty geas seal",
                "arcane sabotage rune",
                "stasis-cocooned prisoner"
            ]
        },
        "asteroid_outpost": {
            "tags": [
                "asteroid",
                "outpost",
                "structure",
                "void"
            ],
            "primary": [
                "hollowed asteroid plaza",
                "defensive ballista platform",
                "docking claw gantry",
                "radiant crystal beacon",
                "market canopy webbing",
                "gravity stabilizer pylon"
            ],
            "secondary": [
                "salvaged hull plating",
                "makeshift barracks",
                "void-garden planter",
                "contraband locker",
                "signal flag array",
                "guard post brazier"
            ],
            "tertiary": [
                "hidden smuggler vault",
                "encrypted trade contract",
                "spyglass attuned to sphere",
                "githyanki sleeper agent",
                "phlogiston flare trap",
                "void-sickness cure ampoule"
            ]
        },
        "nebula_waystation": {
            "tags": [
                "nebula",
                "waystation",
                "refuge",
                "void"
            ],
            "primary": [
                "luminescent mist chamber",
                "drift anchor spire",
                "pilgrim shrine alcove",
                "meditation prism garden",
                "resupply kiosk",
                "guardian lantern array"
            ],
            "secondary": [
                "incense brazier",
                "nebula water condenser",
                "song crystal choir",
                "navigation bell pull",
                "tranquil hammocks",
                "visitation ledger"
            ],
            "tertiary": [
                "secret refuge passage",
                "peace accord treaty",
                "unbound star elemental",
                "contraband etherwine",
                "astral thieves guildmark",
                "memory-draining mist trap"
            ]
        },
        "crystal_sphere_gateway": {
            "tags": [
                "crystalsphere",
                "gateway",
                "boundary",
                "void"
            ],
            "primary": [
                "sphere breach arch",
                "guardian obelisk ring",
                "ritual focus platform",
                "anchor rune circle",
                "prismatic seal curtain",
                "sentinel golem niche"
            ],
            "secondary": [
                "ancient script panel",
                "attunement pedestal",
                "warning sigil chain",
                "patrol brazier",
                "etheric measurement rod",
                "crystal resonance fork"
            ],
            "tertiary": [
                "sealed portal key",
                "sphere-cartographer journal",
                "latent planar breach",
                "arcane contagion ward",
                "cosmic gatekeeper spirit",
                "catastrophic seal release"
            ]
        },
        "phlogiston_tidepool": {
            "tags": [
                "phlogiston",
                "hazard",
                "wildspace",
                "void"
            ],
            "primary": [
                "floating fire eddy",
                "tidepool observation ring",
                "safety tether gantry",
                "emberproof shelter",
                "pressure release valve",
                "warning lantern buoy"
            ],
            "secondary": [
                "heat-scorched tools",
                "volatile sample vials",
                "fire-retardant cloak rack",
                "alchemical damping rod",
                "burned logbook",
                "spill containment mesh"
            ],
            "tertiary": [
                "ignition chain trap",
                "rare phlogiston crystal",
                "fire elemental prisoner",
                "secret smugglers cache",
                "emergency planar gateway",
                "experimental ignition engine"
            ]
        },
        "living_ship_grove": {
            "tags": [
                "ship",
                "living",
                "organic",
                "void"
            ],
            "primary": [
                "bioluminescent helm blossom",
                "sungrown canopy corridor",
                "sap-infused control tendril",
                "photosynthetic ward pod",
                "drifting pollen lantern",
                "rooted crew cradle"
            ],
            "secondary": [
                "symbiotic tool niche",
                "healing resin pool",
                "spore communication node",
                "caretaker chant circle",
                "grafted weapon rack",
                "sap-scribed logbook"
            ],
            "tertiary": [
                "rebellious growth tumor",
                "dormant star seed",
                "mutiny pheromone cache",
                "feywild graft portal",
                "curative nectar vial",
                "predatory vine trap"
            ]
        },
        "planar_observatory": {
            "tags": [
                "observatory",
                "structure",
                "void",
                "anomaly"
            ],
            "primary": [
                "rotating scrying dome",
                "calibrated ether telescope",
                "chronometer dais",
                "constellation mosaic floor",
                "gravity-inverted balcony",
                "arcane calculation engine"
            ],
            "secondary": [
                "star ledger scroll case",
                "phase-adjustment tools",
                "astral alignment gong",
                "protective ward lattice",
                "assistant homunculus alcove",
                "sealed research cabinet"
            ],
            "tertiary": [
                "forbidden planar map",
                "time-locked experiment",
                "stolen imperial cipher",
                "malfunctioning prediction orb",
                "portal to future echo",
                "runaway summoned entity"
            ]
        },
        "void_market": {
            "tags": [
                "market",
                "void",
                "trade",
                "floating"
            ],
            "primary": [
                "gravity-tethered bazaar ring",
                "merchant pennant canopy",
                "arcane auction dais",
                "cargo barge dock",
                "psionic negotiation booth",
                "floating tavern pavilion"
            ],
            "secondary": [
                "spice vapor diffuser",
                "contract scribes alcove",
                "barter token fountain",
                "mercenary guard post",
                "cage of exotic familiars",
                "contraband inspection table"
            ],
            "tertiary": [
                "hidden price-fixing ledger",
                "rival guild sabotage kit",
                "rare starwine crate",
                "secret escape portal",
                "assassin's staging perch",
                "cursed trade charm"
            ]
        },
        "spellforge_workshop": {
            "tags": [
                "workshop",
                "forge",
                "arcane",
                "void"
            ],
            "primary": [
                "gravity-anchored anvil",
                "molten starmetal crucible",
                "levitating tool rack",
                "runic cooling pool",
                "spell lattice loom",
                "shielding glyph wall"
            ],
            "secondary": [
                "apprentice workbench",
                "schematic scroll tubes",
                "ingot storage locker",
                "etheric hammer rack",
                "protective aprons",
                "hazard rune panel"
            ],
            "tertiary": [
                "unstable prototype weapon",
                "forbidden forge pact",
                "volatile slag cache",
                "hidden guild contract",
                "sentient forge spirit",
                "detonation fail-safe trap"
            ]
        },
        "starbeast_graveyard": {
            "tags": [
                "graveyard",
                "wildspace",
                "bones",
                "void"
            ],
            "primary": [
                "colossal rib arch",
                "fossilized heart chamber",
                "drifting bone field",
                "memorial totem pole",
                "salvager camp scaffold",
                "soul lantern cairn"
            ],
            "secondary": [
                "necromantic residue",
                "scavenger tether lines",
                "spore-choked crevice",
                "bone-harp wind chime",
                "ritual chalk circle",
                "starbeast tooth pile"
            ],
            "tertiary": [
                "haunting astral echo",
                "ancient captain's log",
                "predatory bone swarm",
                "guardian revenant spirit",
                "legendary marrow relic",
                "planar seal fracture"
            ]
        }
    }
};

        // Encounter data structures
        const encounterData = {
            urban: {
                skillChecks: [
                    { skill: 'Investigation', purpose: 'piecing together scattered clues amid market hubbub and alleyway whispers' },
                    { skill: 'Perception', purpose: 'reading the cityscape for hidden sigils, shadowy shapes, or subtle architecture shifts' },
                    { skill: 'Stealth', purpose: 'ghosting through lantern-lit streets without drawing the eye of the watch or rival crews' },
                    { skill: 'Persuasion', purpose: 'coaxing gossip from tavern regulars or calming jittery witnesses' },
                    { skill: 'Insight', purpose: 'sussing out concealed motives behind polite smiles and officious decrees' },
                    { skill: 'Acrobatics', purpose: 'dancing across pitched rooftops and threadbare clotheslines with catlike balance' }
                ],
                traps: [
                    { name: 'Alley Ambush Setup', description: 'Broken barrels, dangling nets, and tripwires choke the narrow lane; triggering one cascades debris in a thunder of splinters and screams.' },
                    { name: 'Sewer Gas Pocket', description: 'A rancid swell of alchemical runoff waits beneath a loose grate, eager to blossom into hungry flame at the spark of a torch.' },
                    { name: 'Collapsing Scaffold', description: 'A mason\u2019s scaffold trembles with hidden faults‚Äîone incautious step sends timbers and tiles collapsing like a wooden avalanche.' },
                    { name: 'Guard Checkpoint', description: 'Steel helms and sharp eyes bar the way; without the right papers or a deft distraction, crossbow bolts and shackles follow.' }
                ],
                hazards: [
                    { name: 'Crowded Market', description: 'A sea of merchants and hawkers surges like a living tide, tangling cloaks and coin purses while unseen hands test every pocket.' },
                    { name: 'Crumbling Buildings', description: 'Abandoned tenements lean together in weary embrace; rotten beams creak underfoot before surrendering to sudden collapse.' },
                    { name: 'Polluted Waterways', description: 'Canals run slick with refuse and alchemical waste, promising fever dreams and gut-twisting curses to any who drink or fall within.' },
                    { name: 'Street Riots', description: 'Cobblestones become weapons as factions clash in a storm of banners, smoke, and hurled debris that swallows whole intersections.' }
                ],
                environmentalEffects: [
                    { name: 'City Noise', description: 'Bell towers, clattering hooves, and relentless gossip forge a constant din that drowns the softest warning or whispered spell.' },
                    { name: 'Smog and Smoke', description: 'Sooty chimneys cloak alleys in eye-stinging haze, stealing breath and weighing on the weary like a tangible shroud.' },
                    { name: 'Labyrinthine Streets', description: 'Switchback alleys and secret courts twist in Escher patterns, confounding memory unless a local map‚Äîor luck‚Äîguides the way.' }
                ]
            },
            arctic: {
                skillChecks: [
                    { skill: 'Survival', purpose: 'charting paths through needle-sharp winds and sculpting snow shelters before nightfall' },
                    { skill: 'Athletics', purpose: 'hauling companions up glassy cliffs and muscling through waist-high drifts' },
                    { skill: 'Perception', purpose: 'catching the whisper-crack of a forming avalanche or the pale gleam of hidden crevasses' },
                    { skill: 'Nature', purpose: 'reading the sky‚Äôs bruised palette to predict storms and judging which ice will bear weight' },
                    { skill: 'Constitution Save', purpose: 'locking mind and muscle against the soul-numbing cold that gnaws exposed flesh' }
                ],
                traps: [
                    { name: 'Hidden Crevasse', description: 'A yawning maw of blue-black ice lies veiled beneath powder; one misstep and the earth swallows the unwary whole.' },
                    { name: 'Thin Ice Patch', description: 'Glass-clear ice glints invitingly over a freezing abyss, splintering the moment true weight tests it.' },
                    { name: 'Snow Shelf', description: 'A fragile cornice hangs over the slope, ready to thunder down in a roaring white avalanche at the slightest vibration.' }
                ],
                hazards: [
                    { name: 'Extreme Cold', description: 'The world itself bites, leeching warmth and vigor until fingers stiffen and thoughts slow to glacial pace.' },
                    { name: 'Whiteout Conditions', description: 'Snow and sky merge into a blank, howling void where orientation is swallowed and sound feels distant.' },
                    { name: 'Avalanche Zone', description: 'Brittle slopes hold their breath, ready to erupt into a roaring cascade that buries trails and travelers alike.' },
                    { name: 'Freezing Water', description: 'A single plunge into black brine steals breath and hope, icing armor and limbs with deadly speed.' }
                ],
                environmentalEffects: [
                    { name: 'Slippery Ice', description: 'Wind-polished ice sheets gleam treacherously, turning every stride into a battle for balance.' },
                    { name: 'Limited Visibility', description: 'Whirling snow halos each torchlight, shrinking the world to a handful of ghostly shapes ahead.' },
                    { name: 'Frostbite Risk', description: 'The cold patiently gnaws at fingertips and ears, inflicting pale wounds that bloom black without swift care.' }
                ]
            },
            ocean: {
                skillChecks: [
                    { skill: 'Athletics', purpose: 'cutting through surging currents and clawing back onto pitching decks' },
                    { skill: 'Survival', purpose: 'steering by star and swell while reading the sea‚Äôs temper' },
                    { skill: 'Perception', purpose: 'spying reef-shadows, distant sails, or leviathan silhouettes before they strike' },
                    { skill: 'Nature', purpose: 'interpreting the ocean‚Äôs tides, omens, and hungry ecosystems' },
                    { skill: 'Acrobatics', purpose: 'dancing across rain-slick rigging and rolling timbers with sailor‚Äôs grace' }
                ],
                traps: [
                    { name: 'Whirlpool', description: 'A maelstrom yawns open, dragging ships into a spiraling throat of foam and splintered masts.' },
                    { name: 'Submerged Reef', description: 'Knife-edged coral lurks inches below the waves, eager to gut hulls and spill holds to the deep.' },
                    { name: 'Rip Current', description: 'A hidden river of water races seaward, snatching swimmers and wreckage into the open blue.' }
                ],
                hazards: [
                    { name: 'Storm at Sea', description: 'Towering waves and knife-sharp rain hurl the vessel between boiling sky and hungry depths.' },
                    { name: 'Dehydration', description: 'Salt-cracked lips and parched throats demand fresh water that the endless sea refuses to provide.' },
                    { name: 'Drowning', description: 'The deep welcomes the weary, wrapping them in cold silence once strength falters.' },
                    { name: 'Dangerous Marine Life', description: 'Predatory fins circle below while territorial beasts strike with barnacled fury.' }
                ],
                environmentalEffects: [
                    { name: 'Waves and Swells', description: 'Decks rise and fall like living things, turning even simple tasks into perilous feats.' },
                    { name: 'Salt Corrosion', description: 'Spray crusts every surface with salt, eating steel and stiffening leather to brittle ruin.' },
                    { name: 'Sun Exposure', description: 'Blistering sun glares off endless water, draining vitality unless shade and salves are at hand.' }
                ]
            },
            space: {
                skillChecks: [
                    { skill: 'Investigation', purpose: 'decoding alien circuitry and reconstructing the story etched in starlit wreckage' },
                    { skill: 'Arcana', purpose: 'communing with cosmic ley lines and taming raw stellar sorcery' },
                    { skill: 'Survival', purpose: 'rationing air, heat, and hope within the void‚Äôs indifferent silence' },
                    { skill: 'Athletics', purpose: 'darting through zero-gravity corridors with practiced thrusts and tethers' },
                    { skill: 'Perception', purpose: 'tracking glimmers of motion against the abyss before they become lethal' }
                ],
                traps: [
                    { name: 'Hull Breach', description: 'Fractured plating screams under pressure; the slightest misstep tears it open, venting air and adventurers into the stars.' },
                    { name: 'Radiation Pocket', description: 'Invisible auroras of lethal light bathe the corridor, searing flesh and warping magic alike.' },
                    { name: 'Magnetic Anomaly', description: 'A rogue magnetosphere seizes metal, wrenching gear from grips and pinning explorers to bulkheads.' }
                ],
                hazards: [
                    { name: 'Vacuum Exposure', description: 'The emptiness beyond the hull sucks warmth and breath away in a heartbeat.' },
                    { name: 'Meteor Shower', description: 'Needle-fine meteoroids slash past like celestial shrapnel, riddling armor and hull alike.' },
                    { name: 'Cosmic Radiation', description: 'Starfire whispers through shielding, leaving sickness and mutations in its wake.' },
                    { name: 'Micro-Gravity', description: 'Every action sends bodies drifting, turning combat into a ballet of inertia and spin.' }
                ],
                environmentalEffects: [
                    { name: 'Weightlessness', description: 'Without gravity, even the smallest force propels bodies into slow-motion orbits.' },
                    { name: 'Temperature Extremes', description: 'Sunward plating sizzles while shadowed hull frosts instantly, stressing gear and flesh.' },
                    { name: 'Communication Lag', description: 'Signals crawl through the void, forcing crews to plan carefully lest instructions arrive too late.' }
                ]
            },
            crypt: {
                skillChecks: [
                    { skill: 'Investigation', purpose: 'reading funerary carvings for concealed mechanisms and forgotten doorways' },
                    { skill: 'Religion', purpose: 'interpreting warding rites to appease ancient spirits' },
                    { skill: 'Perception', purpose: 'catching the cold shuffle of undead or the click of hidden triggers' },
                    { skill: 'Arcana', purpose: 'unraveling necromantic sigils before they awaken slumbering guardians' },
                    { skill: 'History', purpose: 'remembering dynastic feuds and legends tied to the honored dead' }
                ],
                traps: [
                    { name: 'Poison Dart Mechanism', description: 'Stone mosaics hide patient darts steeped in tomb venoms that still burn after centuries.' },
                    { name: 'Collapsing Tomb', description: 'A misjudged pry bar releases ancient counterweights, dropping the vault in a hail of stone.' },
                    { name: 'Cursed Treasure', description: 'Jeweled reliquaries clutch their owners‚Äô spite, lashing thieves with wasting curses.' },
                    { name: 'Animated Guardians', description: 'Sarcophagi groan open as gilded statues or embalmed champions rise to enforce eternal vows.' }
                ],
                hazards: [
                    { name: 'Necrotic Aura', description: 'Every breath tastes of grave dust while necromantic energy gnaws at living flesh.' },
                    { name: 'Disease Vectors', description: 'Moldering wrappings and stagnant pools teem with forgotten plagues.' },
                    { name: 'Unstable Structure', description: 'Time-weakened pillars crumble at a touch, threatening to entomb intruders forever.' },
                    { name: 'Desecration Curse', description: 'Profaning burial rites calls forth wrathful spirits or hexes that linger long after the tomb.' }
                ],
                environmentalEffects: [
                    { name: 'Oppressive Darkness', description: 'Pitch blackness swallows torchlight, letting only whispers and cold drafts hint at vast chambers.' },
                    { name: 'Stale Air', description: 'Dust-choked stillness leaves lungs burning and torches guttering low.' },
                    { name: 'Unnerving Atmosphere', description: 'A chorus of remembered prayers and distant wails gnaws at courage and focus.' }
                ]
            },
            forest: {
                skillChecks: [
                    { skill: 'Survival', purpose: 'following faint tracks across moss and charting trails through tangled boughs' },
                    { skill: 'Nature', purpose: 'reading the language of leaves, spoor, and birdsong to gauge the forest mood' },
                    { skill: 'Stealth', purpose: 'slipping between fern fronds without stirring so much as a whisper' },
                    { skill: 'Perception', purpose: 'catching the flash of predator eyes or the creak of a rigged snare' },
                    { skill: 'Athletics', purpose: 'swinging across ravines and vaulting fallen trunks with rangerly ease' }
                ],
                traps: [
                    { name: 'Pit Trap', description: 'A leaf-draped pit yawns beneath the unwary, studded with sharpened stakes and damp earth.' },
                    { name: 'Snare Trap', description: 'A braided vine lashes tight around a limb, hoisting victims skyward amid snapping branches.' },
                    { name: 'Poisonous Plants', description: 'Glossy leaves conceal irritant oils and paralytic saps cultivated by territorial hunters.' }
                ],
                hazards: [
                    { name: 'Thick Undergrowth', description: 'Brambles and thorn-thick hedges clutch at boots, slowing progress to a crawl.' },
                    { name: 'Wild Beasts', description: 'The forest‚Äôs apex predators stalk intruders with cunning pack tactics.' },
                    { name: 'Quicksand', description: 'Mossy ground liquefies into sucking mire that drags down the panicked and unwary.' },
                    { name: 'Falling Branches', description: 'Storm-tossed limbs and widowmakers crash without warning, splintering armor and bone.' }
                ],
                environmentalEffects: [
                    { name: 'Limited Visibility', description: 'Sunlight filters in dappled shards, cloaking threats in emerald shadow.' },
                    { name: 'Disorientation', description: 'Every glade mirrors the last, turning compasses unreliable and paths into circles.' },
                    { name: 'Insect Swarms', description: 'Gnats and biting flies assail exposed skin, their droning hum fraying tempers.' }
                ]
            },
            desert: {
                skillChecks: [
                    { skill: 'Survival', purpose: 'charting wind-swept dunes and divining scarce water beneath cracked earth' },
                    { skill: 'Constitution Save', purpose: 'withstanding furnace heat and the desiccating bite of desert winds' },
                    { skill: 'Perception', purpose: 'separating mirage from oasis and spotting sandstorms before they loom' },
                    { skill: 'Nature', purpose: 'knowing which cactus heals and which hides scorpion nests' },
                    { skill: 'Athletics', purpose: 'cresting dune ridges and sprinting across searing sand before it swallows tracks' }
                ],
                traps: [
                    { name: 'Sinking Sand', description: 'A dune face collapses into a swirling pit, dragging prey beneath shimmering grains.' },
                    { name: 'Buried Hazards', description: 'Sun-warmed sand hides shattered masonry and glassy obsidian ready to slice boots and flesh.' },
                    { name: 'Scorpion Den', description: 'A seemingly lifeless hummock erupts with chittering stingers angered by careless footsteps.' }
                ],
                hazards: [
                    { name: 'Extreme Heat', description: 'The sun hammers from above while reflected glare cooks armor from below.' },
                    { name: 'Dehydration', description: 'Sweat evaporates before it forms, leaving throats raw and minds swimming.' },
                    { name: 'Sandstorm', description: 'A wall of grit roars across the dunes, flaying exposed skin and burying tracks in moments.' },
                    { name: 'Heat Mirages', description: 'Shimmering heat paints false rivers and phantom caravans on the horizon.' }
                ],
                environmentalEffects: [
                    { name: 'Difficult Terrain', description: 'Shifting dunes swallow footsteps and sap strength with every stride.' },
                    { name: 'Temperature Swings', description: 'Night plummets from blistering heat to knife-edged cold in the span of a sunset.' },
                    { name: 'Sun Glare', description: 'White sand and sky fuse into blinding brilliance, forcing eyes beneath hoods and veils.' }
                ]
            },
            mountain: {
                skillChecks: [
                    { skill: 'Athletics', purpose: 'hauling bodies up sheer cliffs and bracing against punishing grades' },
                    { skill: 'Survival', purpose: 'reading scree slopes and storm fronts to keep the path safe' },
                    { skill: 'Acrobatics', purpose: 'tiptoeing along knife-edge ridges with avalanches yawning below' },
                    { skill: 'Perception', purpose: 'noticing treacherous handholds or distant rockfalls before they strike' },
                    { skill: 'Constitution Save', purpose: 'fighting off altitude sickness and lung-searing chill' }
                ],
                traps: [
                    { name: 'Rockfall Trigger', description: 'A single dislodged stone cascades into a roaring avalanche of boulders.' },
                    { name: 'False Handhold', description: 'Seemingly sturdy outcroppings shear away, sending climbers pitching into the void.' },
                    { name: 'Ice Bridge', description: 'A frost-frosted span hides a yawning crevasse, fracturing under the weight of the unwary.' }
                ],
                hazards: [
                    { name: 'Thin Air', description: 'Each breath is a labor, leaving muscles weak and thoughts hazy.' },
                    { name: 'Rockslides', description: 'Mountains shrug off cloaks of stone, pelting climbers with jagged shards.' },
                    { name: 'Sudden Storms', description: 'Thunderheads roll in with little warning, hurling sleet, lightning, and gale-force winds.' },
                    { name: 'Long Falls', description: 'A misstep offers nothing but empty sky and the promise of a terminal landing.' }
                ],
                environmentalEffects: [
                    { name: 'Strong Winds', description: 'Knife-edged gusts buffet travelers, threatening to pluck them from the path.' },
                    { name: 'Cold Temperature', description: 'Thin air and perpetual frost sap warmth from fingers and gear alike.' },
                    { name: 'Echo and Noise', description: 'Booming echoes rebound through valleys, startling wildlife and loosening stones.' }
                ]
            },
            swamp: {
                skillChecks: [
                    { skill: 'Survival', purpose: 'picking safe routes along half-sunken causeways and root bridges' },
                    { skill: 'Nature', purpose: 'distinguishing healing herbs from venom-dripping flora' },
                    { skill: 'Perception', purpose: 'listening past croaking choruses for lurking predators and bubbles' },
                    { skill: 'Athletics', purpose: 'muscling through sucking bogs and dragging companions to firmer ground' },
                    { skill: 'Constitution Save', purpose: 'enduring miasma-laden air and biting disease clouds' }
                ],
                traps: [
                    { name: 'Bog Pit', description: 'A seemingly solid patch liquefies, sucking travelers into a tar-dark mire.' },
                    { name: 'Submerged Spikes', description: 'Rotten logs conceal jagged stakes that spear boots and skiffs alike.' },
                    { name: 'Poisonous Gas Pocket', description: 'A swirl of pale vapor erupts from the muck, choking lungs with toxic fumes.' }
                ],
                hazards: [
                    { name: 'Deep Mud', description: 'Every step becomes a struggle as mud clings like a living thing.' },
                    { name: 'Disease-Carrying Insects', description: 'Mosquito clouds descend in waves, delivering fevered dreams with every bite.' },
                    { name: 'Toxic Waters', description: 'Oily sheens and skeletal fish warn that the water itself carries poison.' },
                    { name: 'Quickmud', description: 'Seemingly shallow pools turn to grasping slurry that swallows prey whole.' }
                ],
                environmentalEffects: [
                    { name: 'Poor Visibility', description: 'Ghostly fog curls between gnarled trees, muting lantern light to a mere glow.' },
                    { name: 'Constant Wetness', description: 'Moisture seeps into every seam, rotting leather and swelling wood.' },
                    { name: 'Disorientation', description: 'The swamp‚Äôs mirrored pools and moss-draped trees erase sense of direction.' }
                ]
            },
            underground: {
                skillChecks: [
                    { skill: 'Investigation', purpose: 'reading striations and echoes to unmask secret tunnels and vaults' },
                    { skill: 'Survival', purpose: 'mapping labyrinthine passages by memory and stone cairns alone' },
                    { skill: 'Perception', purpose: 'listening for dripping water, skittering feet, or the groan of stressed stone' },
                    { skill: 'Athletics', purpose: 'scrambling over jagged scree and worming through narrow chimneys' },
                    { skill: 'Nature', purpose: 'deciphering subterranean ecosystems and predicting tremors' }
                ],
                traps: [
                    { name: 'Cave-In Trigger', description: 'Loose supports and fault lines await a careless touch to bury intruders in tons of rock.' },
                    { name: 'Poisonous Gas Vent', description: 'A fissure exhales sulfurous fumes, lulling trespassers into choking unconsciousness.' },
                    { name: 'Underground River', description: 'A sudden torrent erupts from a hidden channel, dragging explorers into lightless depths.' }
                ],
                hazards: [
                    { name: 'Total Darkness', description: 'Absolute blackness swallows vision, leaving only touch and sound to navigate.' },
                    { name: 'Unstable Passages', description: 'Ceilings groan and drip, ready to surrender boulders without warning.' },
                    { name: 'Underground Rivers', description: 'Raging currents thunder through narrow tunnels, smashing trespassers against jagged stone.' },
                    { name: 'Toxic Air', description: 'Stagnant pockets of foul air sap strength and smother flames.' }
                ],
                environmentalEffects: [
                    { name: 'Claustrophobia', description: 'Pressing walls and low ceilings gnaw at nerves, sparking panic in the unsteady.' },
                    { name: 'Echo and Reverb', description: 'Voices rebound in eerie chorus, disguising distance and direction.' },
                    { name: 'Temperature Variation', description: 'Chill, damp air clings to skin, numbing fingers and making gear slick.' }
                ]
            }
        };

        function getRandomElements(array, count) {
            // Fisher-Yates shuffle for proper randomization
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled.slice(0, count);
        }

        function calculateDC(partyLevel) {
            if (partyLevel <= 4) return 10 + Math.floor(Math.random() * 3);
            if (partyLevel <= 10) return 12 + Math.floor(Math.random() * 4);
            if (partyLevel <= 16) return 15 + Math.floor(Math.random() * 5);
            return 18 + Math.floor(Math.random() * 5);
        }

        function getScalingNotes(partyLevel) {
            const notes = [];
            
            if (partyLevel <= 4) {
                notes.push('Low-level party: Reduce trap damage by 50%, lower DCs by 2-3.');
                notes.push('Focus on exploration and puzzle-solving over combat danger.');
                notes.push('Provide more obvious clues and warning signs for hazards.');
            } else if (partyLevel <= 10) {
                notes.push('Mid-level party: Standard encounter difficulty as presented.');
                notes.push('Party has access to more resources and magical solutions.');
                notes.push('Can handle multiple simultaneous challenges.');
            } else if (partyLevel <= 16) {
                notes.push('High-level party: Increase trap damage by 50%, raise DCs by 2-3.');
                notes.push('Add magical components to hazards and environmental effects.');
                notes.push('Consider multiple layers of challenges requiring diverse skills.');
            } else {
                notes.push('Epic-level party: Double trap damage, raise DCs by 4-5.');
                notes.push('Incorporate legendary environmental effects and cosmic threats.');
                notes.push('Challenges should require creative use of high-level abilities.');
                notes.push('Standard hazards may be trivial - add supernatural elements.');
            }

            return notes;
        }

        const fallbackEncounterTitles = {
            urban: ['The Shadowed Alley', 'Rooftop Chase', 'The Abandoned Warehouse', 'Market District Mystery', 'Sewer Expedition'],
            arctic: ['Frozen Wasteland Trek', 'The Avalanche Path', 'Ice Cave Exploration', 'Blizzard Survival', 'Glacier Crossing'],
            ocean: ['Storm-Tossed Voyage', 'The Coral Labyrinth', 'Derelict Ship Discovery', 'Island Approach', 'Deep Water Descent'],
            space: ['Derelict Station', 'Asteroid Field Navigation', 'Void Walk', 'Alien Ruins', 'Cosmic Anomaly'],
            crypt: ['The Ancient Tomb', 'Forgotten Catacombs', 'Cursed Burial Chamber', 'The Silent Mausoleum', 'Necropolis Depths'],
            forest: ['Dense Woodland Trail', 'The Overgrown Ruins', 'Ancient Grove', 'Forest of Whispers', 'The Hidden Glade'],
            desert: ['Scorching Dunes', 'Oasis Mirage', 'The Buried Temple', 'Canyon of Winds', 'Desert Caravan Route'],
            mountain: ['Treacherous Peak', 'The Mountain Pass', 'Cliffside Trail', 'Summit Ascent', 'The Hidden Valley'],
            swamp: ['The Mire', 'Forgotten Wetlands', 'Bog of Despair', 'Murky Waters', 'The Dead Marsh'],
            underground: ['Cavern Depths', 'The Sunless Expanse', 'Crystal Caves', 'Underground River', 'The Forgotten Mine']
        };

        function selectEncounterTemplate(environment) {
            const entries = encounterTitles && encounterTitles[environment];
            if (entries && entries.length > 0) {
                const totalWeight = entries.reduce((sum, entry) => sum + (entry.weight ?? 1), 0);
                let roll = Math.random() * totalWeight;
                for (const entry of entries) {
                    roll -= (entry.weight ?? 1);
                    if (roll <= 0) {
                        return entry;
                    }
                }
                return entries[entries.length - 1];
            }

            const fallback = fallbackEncounterTitles[environment] || fallbackEncounterTitles.urban;
            const title = fallback[Math.floor(Math.random() * fallback.length)];
            return { title, description: null };
        }

        function buildEncounterDescription(environment, title, customDescription) {
            if (customDescription) {
                return customDescription;
            }

            const descriptions = {
                urban: `The party must navigate ${title.toLowerCase()}, where every alley hums with intrigue and the city itself plays kingmaker. Lantern light paints long shadows over ancient masonry, and the press of humanity can offer salvation or doom depending on which whispers they heed.`,
                arctic: `${title} hurls the party into a realm of grinding ice and razor winds. Only careful preparation, shared body heat, and unshakable resolve stand between the heroes and the endless white hunger of the north.`,
                ocean: `The party faces ${title.toLowerCase()}, with the sea rising like a living titan around them. Tempest winds, creaking timbers, and fathomless depths remind them that mortals are but guests upon the waves.`,
                space: `In ${title.toLowerCase()}, the party drifts between stars where silence is lethal and every glimmer could be salvation or an alien trap. The void judges all missteps harshly, yet rewards courage with wonders beyond imagination.`,
                crypt: `${title} beckons with the promise of forgotten relics and the wrath of those sworn to guard them. Dust-laden sarcophagi, echoing prayers, and lingering curses turn each footfall into a negotiation with the dead.`,
                forest: `The party must traverse ${title.toLowerCase()}, an emerald cathedral where roots clutch secrets and spirits watch from the boughs. Beauty and peril twine together as the living wood decides whether these travelers are welcome.`,
                desert: `${title} stretches in shimmering waves, testing endurance, faith, and resourcefulness. The desert buries the incautious beneath sand and legend alike, yet those who read its omens may claim treasures long hidden.`,
                mountain: `The party attempts ${title.toLowerCase()}, climbing into a realm of thin air, thunderous avalanches, and unyielding stone. Each switchback is a wager with gravity, and the summit offers glory only to those who endure.`,
                swamp: `${title} engulfs the party in fetid mists and half-sunken ruins. Murky waters conceal both relics and ravenous jaws, demanding keen senses and iron stomachs from any who dare wade within.`,
                underground: `The party descends into ${title.toLowerCase()}, surrendering sunlight for echoing caverns and subterranean mysteries. Down here, the stone remembers ancient wars, and every tunnel could unveil wonder or waking terror.`
            };

            return descriptions[environment] || descriptions.urban;
        }

        function generateEncounter() {
            const partyLevel = parseInt(document.getElementById('partyLevel').value);
            
            if (isNaN(partyLevel) || partyLevel < 1 || partyLevel > 20) {
                alert('Please enter a valid party level between 1 and 20.');
                return;
            }

            const data = encounterData[selectedEnvironment];
            const template = selectEncounterTemplate(selectedEnvironment);
            const title = template.title;
            const description = buildEncounterDescription(selectedEnvironment, title, template.description);

            // Select random elements
            const numSkills = 3 + Math.floor(Math.random() * 2); // 3-4 skills
            const numTraps = Math.floor(Math.random() * 3) + 1; // 1-3 traps
            const numHazards = Math.floor(Math.random() * 2) + 2; // 2-3 hazards
            const numEffects = Math.floor(Math.random() * 2) + 1; // 1-2 effects

            const selectedSkills = getRandomElements(data.skillChecks, numSkills);
            const selectedTraps = getRandomElements(data.traps, numTraps);
            const selectedHazards = getRandomElements(data.hazards, numHazards);
            const selectedEffects = getRandomElements(data.environmentalEffects, numEffects);
            const scalingNotes = getScalingNotes(partyLevel);

            // Build HTML
            let html = `
                <div class="encounter-section">
                    <h2>üìú ${title}</h2>
                    <p class="description">${description}</p>
                    <p class="description"><strong>Environment:</strong> ${selectedEnvironment.charAt(0).toUpperCase() + selectedEnvironment.slice(1)} | <strong>Recommended Party Level:</strong> ${partyLevel}</p>
                </div>

                <div class="encounter-section">
                    <h2>üéØ Skill Challenges</h2>
                    <p class="description">These skill checks form the core of the exploration encounter. Players must overcome these challenges to successfully navigate the environment.</p>
            `;

            selectedSkills.forEach(skill => {
                const dc = calculateDC(partyLevel);
                html += `
                    <div class="skill-check">
                        <div class="skill-check-header">
                            <span class="skill-name">${skill.skill}</span>
                            <span class="dc">DC ${dc}</span>
                        </div>
                        <p>Purpose: ${skill.purpose}</p>
                        <p><strong>Success:</strong> The party overcomes this obstacle and gains advantage on their next related check.</p>
                        <p><strong>Failure:</strong> The party takes longer, attracts attention, or suffers minor setbacks.</p>
                    </div>
                `;
            });

            html += `</div>`;

            // Traps
            if (selectedTraps.length > 0) {
                html += `
                    <div class="encounter-section">
                        <h2>‚ö†Ô∏è Traps</h2>
                        <p class="description">Hidden dangers that require careful detection and disarming.</p>
                `;

                selectedTraps.forEach(trap => {
                    const detectDC = calculateDC(partyLevel);
                    const disarmDC = detectDC + 2;
                    // Damage scales with party level: 1d6 per 2 levels (minimum 1d6)
                    const damageScale = Math.max(1, Math.floor(partyLevel / 2));
                    const damage = `${damageScale}d6`;
                    
                    html += `
                        <div class="trap">
                            <div class="trap-name">ü™§ ${trap.name}</div>
                            <p><strong>Description:</strong> ${trap.description}</p>
                            <p><strong>Detection:</strong> DC ${detectDC} Investigation or Perception check</p>
                            <p><strong>Disarm:</strong> DC ${disarmDC} Thieves' Tools check or appropriate skill</p>
                            <p><strong>Effect:</strong> ${damage} damage (type varies by trap nature) on trigger</p>
                        </div>
                    `;
                });

                html += `</div>`;
            }

            // Hazards
            html += `
                <div class="encounter-section">
                    <h2>üí• Environmental Hazards</h2>
                    <p class="description">Natural or environmental dangers that affect the encounter area.</p>
            `;

            selectedHazards.forEach(hazard => {
                const saveDC = calculateDC(partyLevel);
                html += `
                    <div class="hazard">
                        <div class="hazard-name">‚ò†Ô∏è ${hazard.name}</div>
                        <p><strong>Description:</strong> ${hazard.description}</p>
                        <p><strong>Save DC:</strong> ${saveDC} (ability varies by hazard)</p>
                        <p><strong>Mitigation:</strong> Proper preparation, magical protection, or environmental awareness can reduce or negate effects.</p>
                    </div>
                `;
            });

            html += `</div>`;

            // Environmental Effects
            html += `
                <div class="encounter-section">
                    <h2>üå™Ô∏è Environmental Effects</h2>
                    <p class="description">Persistent conditions that affect the entire encounter area.</p>
            `;

            selectedEffects.forEach(effect => {
                html += `
                    <div class="environmental-effect">
                        <div class="effect-name">üîÆ ${effect.name}</div>
                        <p>${effect.description}</p>
                    </div>
                `;
            });

            html += `</div>`;

            // Scaling Notes
            html += `
                <div class="encounter-section">
                    <h2>‚öñÔ∏è Level Scaling Guide</h2>
                    <p class="description">Adjust the encounter difficulty based on your party's level:</p>
            `;

            scalingNotes.forEach(note => {
                html += `
                    <div class="scaling-note">
                        <span class="level-badge">Level ${partyLevel}</span>
                        ${note}
                    </div>
                `;
            });

            html += `
                    <div class="scaling-note">
                        <strong>General Scaling Tips:</strong>
                        <ul>
                            <li>For parties below the recommended level, reduce DCs by 2-3 and halve damage values</li>
                            <li>For parties above the recommended level, increase DCs by 2-3 and add additional complications</li>
                            <li>Consider party composition - groups lacking certain skills may need alternative solutions</li>
                            <li>Time pressure can increase difficulty without changing numbers</li>
                        </ul>
                    </div>
                </div>
            `;

            // Rewards and Conclusion
            html += `
                <div class="encounter-section">
                    <h2>üèÜ Resolution & Rewards</h2>
                    <p class="description"><strong>Success Criteria:</strong> The party successfully navigates the primary hazards and completes the exploration objective.</p>
                    <p class="description"><strong>Rewards:</strong></p>
                    <ul>
                        <li>Experience points appropriate for a medium difficulty exploration encounter</li>
                        <li>Knowledge of the area that may prove useful later</li>
                        <li>Possible discovery of treasure, secrets, or story clues</li>
                        <li>Reputation or favor with relevant factions</li>
                    </ul>
                    <p class="description"><strong>DM Tips:</strong> Exploration encounters work best when players feel clever for overcoming challenges. Reward creative solutions and allow multiple approaches to obstacles. The journey itself should be memorable, not just the destination.</p>
                </div>
                
                <div style="text-align: center; margin-top: 30px; padding: 20px;">
                    <button onclick="exploreEncounterLocation()" style="background: linear-gradient(135deg, #2ecc71, #27ae60); color: white; border: none; padding: 15px 30px; font-size: 18px; border-radius: 8px; cursor: pointer; box-shadow: 0 4px 6px rgba(0,0,0,0.2); transition: all 0.3s ease;">
                        üó∫Ô∏è Explore Location
                    </button>
                    <p style="margin-top: 10px; color: #666; font-size: 14px;">Dive deeper into a contextual location within this environment</p>
                </div>
            `;

            document.getElementById('encounterContent').innerHTML = html;
            document.getElementById('encounterDisplay').classList.add('active');
            
            // Smooth scroll to encounter
            document.getElementById('encounterDisplay').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // Room exploration variables
        let currentRoomEnvironment = '';
        let currentRoomType = '';
        let currentRoomData = null;
        let exploredObjects = new Set();

        // Explore location from encounter
        function exploreEncounterLocation() {
            // Use current encounter environment or default to urban
            const environment = selectedEnvironment || 'urban';
            
            // Find matching location based on encounter tags if available
            const matchingLocations = [];
            
            for (const [locationType, locationData] of Object.entries(locationObjects[environment])) {
                matchingLocations.push({ type: locationType, data: locationData });
            }
            
            // Select random matching location
            const selectedLocation = matchingLocations[Math.floor(Math.random() * matchingLocations.length)];
            
            // Generate and display room
            generateRoom(environment, selectedLocation.type, selectedLocation.data);
        }

        // Generate room
        function generateRoom(environment, locationType, locationData) {
            currentRoomEnvironment = environment;
            currentRoomType = locationType;
            currentRoomData = locationData;
            exploredObjects = new Set();
            
            displayRoomView();
        }

        // Display room view
        function displayRoomView() {
            const envIcons = {
                urban: 'üèõÔ∏è', arctic: '‚ùÑÔ∏è', ocean: 'üåä', space: 'üåå',
                crypt: 'üíÄ', forest: 'üå≤', desert: 'üèúÔ∏è', mountain: '‚õ∞Ô∏è',
                swamp: 'üêä', underground: 'üï≥Ô∏è'
            };
            
            const icon = envIcons[currentRoomEnvironment] || 'üó∫Ô∏è';
            const locationName = currentRoomType.charAt(0).toUpperCase() + currentRoomType.slice(1);
            const environmentName = currentRoomEnvironment.charAt(0).toUpperCase() + currentRoomEnvironment.slice(1);
            
            let html = `
                <div class="encounter-section">
                    <h1 style="text-align: center; color: #27ae60; margin-bottom: 30px;">
                        ${icon} Exploring ${locationName} - ${environmentName}
                    </h1>
                    <p class="description" style="text-align: center; font-size: 18px; margin-bottom: 30px;">
                        You carefully examine this location, looking for anything of interest or value.
                    </p>
                </div>

                <div class="encounter-section">
                    <h2>üîç Primary Objects of Interest</h2>
                    <p class="description">These are the prominent features and objects that immediately catch your attention:</p>
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px; margin-top: 20px;">
            `;
            
            // Display primary objects
            currentRoomData.primary.forEach((obj, index) => {
                const isExplored = exploredObjects.has(`primary-${index}`);
                const buttonStyle = isExplored 
                    ? 'background: #95a5a6; cursor: not-allowed;' 
                    : 'background: linear-gradient(135deg, #3498db, #2980b9); cursor: pointer;';
                const buttonText = isExplored ? '‚úì Explored' : 'üîç Examine';
                
                html += `
                    <div style="border: 2px solid #3498db; border-radius: 8px; padding: 15px; background: rgba(52, 152, 219, 0.1);">
                        <div style="font-weight: bold; margin-bottom: 10px; color: #2c3e50;">${obj}</div>
                        <button onclick="exploreObject('primary', ${index})" 
                                style="${buttonStyle} color: white; border: none; padding: 8px 16px; border-radius: 5px; font-size: 14px; width: 100%;"
                                ${isExplored ? 'disabled' : ''}>
                            ${buttonText}
                        </button>
                    </div>
                `;
            });
            
            html += `
                    </div>
                </div>
            `;
            
            // Show explored secondary objects section if any exist
            if (exploredObjects.size > 0) {
                const secondaryObjects = Array.from(exploredObjects)
                    .filter(id => id.startsWith('primary-'))
                    .map(id => {
                        const index = parseInt(id.split('-')[1]);
                        return currentRoomData.secondary[index];
                    });
                
                if (secondaryObjects.length > 0) {
                    html += `
                        <div class="encounter-section">
                            <h2>üîé Secondary Details Discovered</h2>
                            <p class="description">Upon closer inspection, you've discovered these additional details:</p>
                            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px; margin-top: 20px;">
                    `;
                    
                    Array.from(exploredObjects)
                        .filter(id => id.startsWith('primary-'))
                        .forEach(id => {
                            const index = parseInt(id.split('-')[1]);
                            const secondaryObj = currentRoomData.secondary[index];
                            const isSecondaryExplored = exploredObjects.has(`secondary-${index}`);
                            const buttonStyle = isSecondaryExplored 
                                ? 'background: #95a5a6; cursor: not-allowed;' 
                                : 'background: linear-gradient(135deg, #9b59b6, #8e44ad); cursor: pointer;';
                            const buttonText = isSecondaryExplored ? '‚úì Explored' : 'üîç Examine Closely';
                            
                            html += `
                                <div style="border: 2px solid #9b59b6; border-radius: 8px; padding: 15px; background: rgba(155, 89, 182, 0.1);">
                                    <div style="font-weight: bold; margin-bottom: 10px; color: #2c3e50;">${secondaryObj}</div>
                                    <button onclick="exploreObject('secondary', ${index})" 
                                            style="${buttonStyle} color: white; border: none; padding: 8px 16px; border-radius: 5px; font-size: 14px; width: 100%;"
                                            ${isSecondaryExplored ? 'disabled' : ''}>
                                        ${buttonText}
                                    </button>
                                </div>
                            `;
                        });
                    
                    html += `
                            </div>
                        </div>
                    `;
                }
                
                // Show discovered tertiary objects
                const tertiaryObjects = Array.from(exploredObjects)
                    .filter(id => id.startsWith('secondary-'))
                    .map(id => {
                        const index = parseInt(id.split('-')[1]);
                        return currentRoomData.tertiary[index];
                    });
                
                if (tertiaryObjects.length > 0) {
                    html += `
                        <div class="encounter-section">
                            <h2>‚ú® Hidden Discoveries</h2>
                            <p class="description">Through careful investigation, you've uncovered these hidden elements:</p>
                            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; margin-top: 20px;">
                    `;
                    
                    tertiaryObjects.forEach(obj => {
                        html += `
                            <div style="border: 2px solid #f39c12; border-radius: 8px; padding: 15px; background: linear-gradient(135deg, rgba(243, 156, 18, 0.2), rgba(230, 126, 34, 0.1)); box-shadow: 0 0 15px rgba(243, 156, 18, 0.3);">
                                <div style="font-weight: bold; font-size: 16px; color: #d68910; margin-bottom: 10px;">üèÜ ${obj}</div>
                                <div style="font-size: 13px; color: #7f8c8d; font-style: italic;">Significant discovery! This could be valuable, dangerous, or story-relevant.</div>
                            </div>
                        `;
                    });
                    
                    html += `
                            </div>
                        </div>
                    `;
                }
            }
            
            document.getElementById('roomContent').innerHTML = html;
            document.getElementById('encounterDisplay').classList.remove('active');
            document.getElementById('roomDisplay').style.display = 'block';
            document.getElementById('roomDisplay').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // Explore object
        function exploreObject(level, index) {
            const objectId = `${level}-${index}`;
            
            if (exploredObjects.has(objectId)) {
                return; // Already explored
            }
            
            exploredObjects.add(objectId);
            displayRoomView(); // Refresh the view to show new discoveries
        }

        // Return to encounter
        function returnToEncounter() {
            document.getElementById('roomDisplay').style.display = 'none';
            document.getElementById('encounterDisplay').classList.add('active');
            document.getElementById('encounterDisplay').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // Generate NPC
        function generateNPC() {
            const selectedSpecies = document.getElementById('npcSpecies').value;
            
            // Choose species
            const speciesKeys = Object.keys(npcData.species);
            const species = selectedSpecies === 'random' 
                ? speciesKeys[Math.floor(Math.random() * speciesKeys.length)]
                : selectedSpecies;
            
            const speciesData = npcData.species[species];
            
            // Generate name
            const firstName = speciesData.firstNames[Math.floor(Math.random() * speciesData.firstNames.length)];
            const surname = speciesData.surnames[Math.floor(Math.random() * speciesData.surnames.length)];
            const fullName = `${firstName} ${surname}`;
            
            // Generate characteristics
            const alignment = npcData.alignments[Math.floor(Math.random() * npcData.alignments.length)];
            const personality = npcData.personalities[Math.floor(Math.random() * npcData.personalities.length)];
            const profession = npcData.professions[Math.floor(Math.random() * npcData.professions.length)];
            const secret = npcData.secrets[Math.floor(Math.random() * npcData.secrets.length)];
            const appearance = npcData.appearances[Math.floor(Math.random() * npcData.appearances.length)];
            
            // Build display HTML
            let html = `
                <div class="encounter-section">
                    <h2>üë§ ${fullName}</h2>
                    <p style="font-size: 1.2em; color: var(--text-secondary); margin-bottom: 20px;">
                        ${species.charAt(0).toUpperCase() + species.slice(1)} ${profession.name}
                    </p>
                </div>

                <div class="encounter-section">
                    <h3>Basic Information</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px;">
                        <div>
                            <strong style="color: var(--accent-blue);">Species:</strong>
                            <p class="description" style="margin-top: 5px;">${species.charAt(0).toUpperCase() + species.slice(1)}</p>
                            <div class="result-tags">
                                ${speciesData.tags.map(tag => `<span class="result-tag">${tag}</span>`).join('')}
                            </div>
                        </div>
                        <div>
                            <strong style="color: var(--accent-blue);">Alignment:</strong>
                            <p class="description" style="margin-top: 5px;">${alignment.name}</p>
                            <div class="result-tags">
                                ${alignment.tags.map(tag => `<span class="result-tag">${tag}</span>`).join('')}
                            </div>
                        </div>
                        <div>
                            <strong style="color: var(--accent-blue);">Profession:</strong>
                            <p class="description" style="margin-top: 5px;">${profession.name}</p>
                            <div class="result-tags">
                                ${profession.tags.map(tag => `<span class="result-tag">${tag}</span>`).join('')}
                            </div>
                        </div>
                    </div>
                </div>

                <div class="encounter-section">
                    <h3>Personality</h3>
                    <p class="description">${personality.trait}</p>
                    <div class="result-tags" style="margin-top: 10px;">
                        ${personality.tags.map(tag => `<span class="result-tag">${tag}</span>`).join('')}
                    </div>
                </div>

                <div class="encounter-section">
                    <h3>Appearance</h3>
                    <p class="description">${appearance.description}</p>
                    <div class="result-tags" style="margin-top: 10px;">
                        ${appearance.tags.map(tag => `<span class="result-tag">${tag}</span>`).join('')}
                    </div>
                </div>

                <div class="encounter-section" style="background: rgba(255, 149, 0, 0.05); border-left: 3px solid #ff9500;">
                    <h3 style="color: #ff9500;">üîí Secret (DM Only)</h3>
                    <p class="description">${secret.secret}</p>
                    <div class="result-tags" style="margin-top: 10px;">
                        ${secret.tags.map(tag => `<span class="result-tag">${tag}</span>`).join('')}
                    </div>
                </div>

                <div class="encounter-section">
                    <h3>Roleplaying Notes</h3>
                    <ul>
                        <li>Consider how their ${personality.trait.toLowerCase()} personality affects their interactions</li>
                        <li>Their profession as a ${profession.name.toLowerCase()} should influence their knowledge and contacts</li>
                        <li>The secret "${secret.secret.toLowerCase()}" could be revealed through careful questioning or investigation</li>
                        <li>Their ${appearance.description.toLowerCase()} makes them memorable to players</li>
                    </ul>
                </div>
            `;
            
            document.getElementById('npcDisplay').innerHTML = html;
            document.getElementById('npcDisplay').classList.add('active');
            document.getElementById('npcDisplay').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
    </script>
</body>
</html>
