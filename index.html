<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LoreWeaver - D&D Exploration Encounter Generator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --glass-bg: rgba(255, 255, 255, 0.08);
            --glass-border: rgba(255, 255, 255, 0.18);
            --glass-shadow: rgba(0, 0, 0, 0.1);
            --accent-blue: #007aff;
            --accent-light: #5ac8fa;
            --text-primary: #1d1d1f;
            --text-secondary: #86868b;
            --bg-primary: #f5f5f7;
            --bg-secondary: #ffffff;
            --hover-bg: rgba(0, 122, 255, 0.08);
        }

        [data-theme="dark"] {
            --glass-bg: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
            --glass-shadow: rgba(0, 0, 0, 0.3);
            --accent-blue: #0a84ff;
            --accent-light: #64d2ff;
            --text-primary: #f5f5f7;
            --text-secondary: #98989d;
            --bg-primary: #000000;
            --bg-secondary: #1c1c1e;
            --hover-bg: rgba(10, 132, 255, 0.15);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #e8f0fe 0%, #f8f9fa 50%, #fff5f5 100%);
            color: var(--text-primary);
            min-height: 100vh;
            padding: 20px;
            line-height: 1.6;
            transition: background 0.3s ease, color 0.3s ease;
        }

        /* Main content wrapper for sliding */
        .main-content {
            transition: margin-left 0.3s ease;
            margin-left: 0;
        }

        .main-content.nav-active {
            margin-left: 320px;
        }

        [data-theme="dark"] body {
            background: linear-gradient(135deg, #000000 0%, #1a1a2e 50%, #16213e 100%);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 40px;
            padding: 40px 20px;
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.06),
                        0 1px 3px rgba(0, 0, 0, 0.02);
        }

        [data-theme="dark"] header {
            background: rgba(28, 28, 30, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3),
                        0 1px 3px rgba(0, 0, 0, 0.2);
        }

        h1 {
            font-size: 3em;
            font-weight: 600;
            background: linear-gradient(135deg, #007aff 0%, #5ac8fa 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
            letter-spacing: -0.02em;
        }

        [data-theme="dark"] h1 {
            background: linear-gradient(135deg, #0a84ff 0%, #64d2ff 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            color: var(--text-secondary);
            font-size: 1.1em;
            font-weight: 400;
        }

        .controls {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            padding: 30px;
            border-radius: 20px;
            margin-bottom: 30px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.06),
                        0 1px 3px rgba(0, 0, 0, 0.02);
        }

        [data-theme="dark"] .controls {
            background: rgba(28, 28, 30, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3),
                        0 1px 3px rgba(0, 0, 0, 0.2);
        }

        .control-group {
            margin-bottom: 25px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-primary);
            font-weight: 500;
            font-size: 0.95em;
        }

        select, input[type="number"] {
            width: 100%;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 1em;
            font-family: inherit;
            transition: all 0.2s ease;
        }

        [data-theme="dark"] select,
        [data-theme="dark"] input[type="number"],
        [data-theme="dark"] input[type="text"] {
            background: rgba(58, 58, 60, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        select:focus, input:focus {
            outline: none;
            border-color: var(--accent-blue);
            background: #ffffff;
            box-shadow: 0 0 0 4px rgba(0, 122, 255, 0.1);
        }

        [data-theme="dark"] select:focus,
        [data-theme="dark"] input:focus {
            background: rgba(58, 58, 60, 0.8);
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 4px rgba(10, 132, 255, 0.2);
        }

        select option {
            background: #ffffff;
            color: var(--text-primary);
        }

        [data-theme="dark"] select option {
            background: #1c1c1e;
            color: var(--text-primary);
        }

        .environment-tags {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .tag {
            padding: 10px 15px;
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 12px;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s ease;
            font-weight: 500;
            font-size: 0.9em;
        }

        [data-theme="dark"] .tag {
            background: rgba(58, 58, 60, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .tag:hover {
            background: var(--hover-bg);
            border-color: var(--accent-blue);
            transform: translateY(-1px);
        }

        .tag.active {
            background: var(--accent-blue);
            border-color: var(--accent-blue);
            color: white;
            box-shadow: 0 4px 12px rgba(0, 122, 255, 0.3);
        }

        button {
            background: var(--accent-blue);
            color: white;
            border: none;
            padding: 14px 32px;
            font-size: 1.05em;
            font-weight: 500;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 4px 12px rgba(0, 122, 255, 0.3);
            width: 100%;
            margin-top: 10px;
            font-family: inherit;
        }

        button:hover {
            background: #0062cc;
            transform: translateY(-1px);
            box-shadow: 0 6px 16px rgba(0, 122, 255, 0.4);
        }

        [data-theme="dark"] button:hover {
            background: #0077ed;
        }

        button:active {
            transform: translateY(0);
        }

        /* Button Variants */
        .btn-success {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            box-shadow: 0 4px 12px rgba(46, 204, 113, 0.3);
        }

        .btn-success:hover {
            background: linear-gradient(135deg, #27ae60, #229954);
            box-shadow: 0 6px 16px rgba(46, 204, 113, 0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            box-shadow: 0 4px 12px rgba(231, 76, 60, 0.3);
        }

        .btn-danger:hover {
            background: linear-gradient(135deg, #c0392b, #a93226);
            box-shadow: 0 6px 16px rgba(231, 76, 60, 0.4);
        }

        .btn-primary {
            background: linear-gradient(135deg, #3498db, #2980b9);
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #2980b9, #21618c);
            box-shadow: 0 6px 16px rgba(52, 152, 219, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
            box-shadow: 0 4px 12px rgba(155, 89, 182, 0.3);
        }

        .btn-secondary:hover {
            background: linear-gradient(135deg, #8e44ad, #7d3c98);
            box-shadow: 0 6px 16px rgba(155, 89, 182, 0.4);
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 0.9em;
            width: auto;
        }

        .btn-medium {
            padding: 12px 24px;
            font-size: 1em;
            width: auto;
        }

        .btn-large {
            padding: 15px 30px;
            font-size: 1.1em;
        }

        button:disabled,
        button.disabled {
            background: #95a5a6 !important;
            cursor: not-allowed !important;
            opacity: 0.6;
            box-shadow: none !important;
        }

        button:disabled:hover,
        button.disabled:hover {
            transform: none !important;
        }

        .nav-tabs {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
            background: rgba(255, 255, 255, 0.5);
            padding: 6px;
            border-radius: 14px;
            backdrop-filter: blur(10px);
            width: fit-content;
            margin-left: auto;
            margin-right: auto;
        }

        [data-theme="dark"] .nav-tabs {
            background: rgba(58, 58, 60, 0.4);
        }

        .nav-tab {
            background: transparent;
            color: var(--text-primary);
            border: none;
            padding: 10px 24px;
            font-size: 1em;
            font-weight: 500;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            width: auto;
            margin: 0;
            box-shadow: none;
        }

        .nav-tab:hover {
            background: rgba(255, 255, 255, 0.6);
        }

        .nav-tab.active {
            background: #ffffff;
            color: var(--accent-blue);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        .page-content {
            animation: fadeIn 0.3s ease-in;
        }

        .search-controls {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            padding: 30px;
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.06);
            margin-bottom: 30px;
        }

        [data-theme="dark"] .search-controls {
            background: rgba(28, 28, 30, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .search-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
        }

        .search-bar input {
            flex: 1;
            padding: 14px 18px;
            font-size: 1em;
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 12px;
            color: var(--text-primary);
            font-family: inherit;
            transition: all 0.2s ease;
        }

        [data-theme="dark"] .search-bar input {
            background: rgba(58, 58, 60, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .search-bar input:focus {
            outline: none;
            border-color: var(--accent-blue);
            background: #ffffff;
            box-shadow: 0 0 0 4px rgba(0, 122, 255, 0.1);
        }

        [data-theme="dark"] .search-bar input:focus {
            background: rgba(58, 58, 60, 0.8);
            box-shadow: 0 0 0 4px rgba(10, 132, 255, 0.2);
        }

        .search-bar button {
            width: auto;
            padding: 14px 28px;
        }

        .filter-section h3 {
            color: var(--text-primary);
            margin-bottom: 16px;
            font-size: 1.2em;
            font-weight: 600;
        }

        .filter-group {
            margin-bottom: 20px;
        }

        .filter-group label {
            display: block;
            color: var(--text-secondary);
            margin-bottom: 10px;
            font-weight: 500;
            font-size: 0.9em;
        }

        .filter-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .filter-tag {
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.9em;
            font-weight: 500;
            color: var(--text-primary);
        }

        [data-theme="dark"] .filter-tag {
            background: rgba(58, 58, 60, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
        }

        .filter-tag:hover {
            background: var(--hover-bg);
            border-color: var(--accent-blue);
            transform: translateY(-1px);
        }

        .filter-tag.active {
            background: var(--accent-blue);
            border-color: var(--accent-blue);
            color: white !important;
            box-shadow: 0 2px 8px rgba(0, 122, 255, 0.3);
        }

        [data-theme="dark"] .filter-tag.active {
            box-shadow: 0 2px 8px rgba(10, 132, 255, 0.4);
        }

        /* Settings Page */
        .settings-section {
            background: rgba(255, 255, 255, 0.9);
            padding: 24px;
            border-radius: 16px;
            margin-bottom: 20px;
            border: 1px solid rgba(0, 0, 0, 0.06);
        }

        [data-theme="dark"] .settings-section {
            background: rgba(58, 58, 60, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .settings-section h2 {
            color: var(--text-primary);
            margin-bottom: 20px;
            font-size: 1.5em;
            font-weight: 600;
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 0;
            border-bottom: 1px solid rgba(0, 0, 0, 0.06);
        }

        [data-theme="dark"] .setting-item {
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .setting-item:last-child {
            border-bottom: none;
        }

        .setting-info h3 {
            color: var(--text-primary);
            font-size: 1.1em;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .setting-info p {
            color: var(--text-secondary);
            font-size: 0.9em;
        }

        .theme-switch {
            position: relative;
            width: 60px;
            height: 34px;
            background: rgba(0, 0, 0, 0.1);
            border-radius: 34px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        [data-theme="dark"] .theme-switch {
            background: rgba(255, 255, 255, 0.1);
        }

        .theme-switch.active {
            background: var(--accent-blue);
        }

        .theme-switch-slider {
            position: absolute;
            top: 3px;
            left: 3px;
            width: 28px;
            height: 28px;
            background: white;
            border-radius: 50%;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        .theme-switch.active .theme-switch-slider {
            transform: translateX(26px);
        }

        .search-results {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            padding: 30px;
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.06);
        }

        .result-card {
            background: rgba(255, 255, 255, 0.9);
            padding: 20px;
            border-radius: 16px;
            margin-bottom: 15px;
            border: 1px solid rgba(0, 0, 0, 0.06);
            transition: all 0.2s ease;
        }

        [data-theme="dark"] .result-card {
            background: rgba(28, 28, 30, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.15);
        }

        .result-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
            border-color: rgba(0, 122, 255, 0.2);
        }

        [data-theme="dark"] .result-card:hover {
            background: rgba(28, 28, 30, 0.95);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.6);
            border-color: rgba(10, 132, 255, 0.5);
        }

        .npc-card {
            background: rgba(58, 58, 60, 0.3);
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
            border: 1px solid rgba(0, 0, 0, 0.06);
        }

        [data-theme="dark"] .npc-card {
            background: rgba(28, 28, 30, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .location-card {
            background: rgba(58, 58, 60, 0.2);
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
            border: 1px solid rgba(0, 122, 255, 0.2);
        }

        [data-theme="dark"] .location-card {
            background: rgba(28, 28, 30, 0.5);
            border: 1px solid rgba(10, 132, 255, 0.3);
        }

        .flow-step {
            transition: all 0.3s ease;
        }

        .flow-step:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        [data-theme="dark"] .flow-step:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
        }

        .location-link {
            color: var(--accent-blue);
            text-decoration: underline;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .location-link:hover {
            color: #5ac8fa;
            text-decoration: none;
        }

        /* Sticky Location Detail Panel */
        .location-detail-panel {
            position: fixed;
            top: 80px;
            right: -450px;
            width: 420px;
            max-height: calc(100vh - 100px);
            background: var(--bg-secondary);
            border: 2px solid var(--accent-blue);
            border-radius: 12px;
            padding: 25px;
            box-shadow: -4px 0 20px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            transition: right 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            overflow-y: auto;
        }

        .location-detail-panel.active {
            right: 20px;
        }

        .location-detail-panel .close-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(255, 59, 48, 0.2);
            border: 1px solid #ff3b30;
            color: #ff3b30;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            line-height: 30px;
            text-align: center;
            transition: all 0.2s ease;
        }

        .location-detail-panel .close-btn:hover {
            background: rgba(255, 59, 48, 0.4);
            transform: rotate(90deg);
        }

        .location-detail-panel h3 {
            color: var(--accent-blue);
            margin-bottom: 15px;
            padding-right: 30px;
        }

        [data-theme="dark"] .location-detail-panel {
            background: rgba(28, 28, 30, 0.98);
            border-color: rgba(10, 132, 255, 0.5);
        }

        .location-section-header {
            cursor: pointer;
            user-select: none;
            padding: 10px;
            margin: -10px;
            border-radius: 6px;
            transition: background 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .location-section-header:hover {
            background: rgba(0, 122, 255, 0.1);
        }

        .location-section-header .expand-icon {
            font-size: 0.8em;
            transition: transform 0.3s ease;
            color: var(--accent-blue);
        }

        .location-section-header.expanded .expand-icon {
            transform: rotate(90deg);
        }

        .location-section-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .location-section-content.expanded {
            max-height: 1000px;
        }

        .location-breadcrumb {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 20px;
            padding: 10px;
            background: rgba(0, 122, 255, 0.05);
            border-radius: 6px;
            font-size: 0.9em;
        }

        .breadcrumb-item {
            color: var(--accent-blue);
            cursor: pointer;
            transition: all 0.2s ease;
            padding: 4px 8px;
            border-radius: 4px;
        }

        .breadcrumb-item:hover {
            background: rgba(0, 122, 255, 0.2);
        }

        .breadcrumb-item.active {
            color: var(--text-primary);
            font-weight: bold;
            cursor: default;
        }

        .breadcrumb-separator {
            color: var(--text-secondary);
        }

        .feature-item {
            cursor: pointer;
            padding: 8px 12px;
            margin: 6px 0;
            border-radius: 6px;
            transition: all 0.2s ease;
            border-left: 3px solid transparent;
        }

        .feature-item:hover {
            background: rgba(0, 122, 255, 0.1);
            border-left-color: var(--accent-blue);
            transform: translateX(5px);
        }

        .feature-item.primary-feature {
            background: rgba(52, 152, 219, 0.05);
        }

        .feature-item.secondary-feature {
            background: rgba(52, 152, 219, 0.08);
        }

        .feature-item.tertiary-feature {
            background: rgba(243, 156, 18, 0.08);
            color: #f39c12;
        }

        .back-button {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 12px;
            background: rgba(0, 122, 255, 0.1);
            border: 1px solid var(--accent-blue);
            border-radius: 6px;
            color: var(--accent-blue);
            cursor: pointer;
            transition: all 0.2s ease;
            margin-bottom: 15px;
            font-size: 0.9em;
        }

        .back-button:hover {
            background: rgba(0, 122, 255, 0.2);
            transform: translateX(-3px);
        }

        /* NPC link styling */
        .npc-link {
            color: #9b59b6;
            font-weight: 600;
            cursor: pointer;
            text-decoration: underline;
            text-decoration-style: dotted;
            text-underline-offset: 2px;
            transition: all 0.2s ease;
            position: relative;
        }

        .npc-link:hover {
            color: #8e44ad;
            text-decoration-style: solid;
        }

        /* NPC hover tooltip */
        .npc-tooltip {
            position: absolute;
            background: var(--card-bg);
            border: 2px solid #9b59b6;
            border-radius: 8px;
            padding: 15px;
            min-width: 280px;
            max-width: 350px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
            z-index: 10000;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .npc-tooltip.active {
            opacity: 1;
        }

        .npc-tooltip-header {
            font-size: 1.1em;
            font-weight: bold;
            color: #9b59b6;
            margin-bottom: 8px;
            border-bottom: 1px solid rgba(155, 89, 182, 0.3);
            padding-bottom: 5px;
        }

        .npc-tooltip-row {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
            font-size: 0.9em;
        }

        .npc-tooltip-label {
            color: var(--text-secondary);
            font-weight: 500;
        }

        .npc-tooltip-value {
            color: var(--text-primary);
            font-weight: 600;
        }

        .npc-tooltip-hint {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid rgba(155, 89, 182, 0.2);
            font-size: 0.85em;
            color: var(--text-secondary);
            font-style: italic;
            text-align: center;
        }

        /* Flow Navigator - Left Side Panel */
        .flow-navigator {
            position: fixed;
            left: -320px;
            top: 100px;
            width: 320px;
            max-height: calc(100vh - 120px);
            background: var(--card-bg);
            border: 2px solid var(--accent-blue);
            border-left: none;
            border-radius: 0 12px 12px 0;
            padding: 20px;
            overflow-y: auto;
            transition: left 0.3s ease;
            z-index: 999;
            box-shadow: 4px 0 16px rgba(0, 0, 0, 0.3);
        }

        .flow-navigator.active {
            left: 0;
        }

        .flow-navigator-toggle {
            position: fixed;
            left: 0;
            top: 120px;
            width: 40px;
            height: 50px;
            background: var(--accent-blue);
            border: 2px solid var(--accent-blue);
            border-left: none;
            border-radius: 0 8px 8px 0;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 998;
            color: white;
            font-size: 20px;
            font-weight: bold;
        }

        .flow-navigator-toggle:hover {
            background: rgba(0, 122, 255, 0.8);
            width: 45px;
        }

        .flow-navigator-toggle.active {
            left: 320px;
        }

        .flow-nav-header {
            font-size: 1.2em;
            font-weight: bold;
            color: var(--accent-blue);
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--accent-blue);
        }

        .flow-step {
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .flow-step-node {
            background: rgba(0, 122, 255, 0.1);
            border: 2px solid var(--accent-blue);
            border-radius: 8px;
            padding: 12px;
            position: relative;
            transition: all 0.2s ease;
        }

        .flow-step-node:hover {
            background: rgba(0, 122, 255, 0.2);
            transform: translateX(5px);
            box-shadow: 0 2px 8px rgba(0, 122, 255, 0.3);
        }

        .flow-step-number {
            position: absolute;
            top: -10px;
            left: -10px;
            width: 28px;
            height: 28px;
            background: var(--accent-blue);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            font-size: 0.9em;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .flow-step-title {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
            font-size: 0.95em;
        }

        .flow-step-location {
            font-size: 0.85em;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .flow-connector {
            width: 2px;
            height: 15px;
            background: linear-gradient(to bottom, var(--accent-blue), transparent);
            margin: 0 auto;
            margin-left: 12px;
        }

        .result-title {
            font-size: 1.3em;
            color: var(--text-primary);
            margin-bottom: 10px;
            font-weight: 600;
        }

        .result-type {
            display: inline-block;
            padding: 4px 12px;
            background: var(--accent-blue);
            color: white;
            border-radius: 8px;
            font-size: 0.85em;
            margin-right: 10px;
            margin-bottom: 10px;
            font-weight: 500;
        }

        .result-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 10px;
        }

        .result-tag {
            padding: 4px 10px;
            background: rgba(0, 122, 255, 0.1);
            border-radius: 6px;
            font-size: 0.8em;
            color: var(--accent-blue);
            font-weight: 500;
        }

        .result-description {
            color: var(--text-secondary);
            margin-top: 10px;
            line-height: 1.6;
        }

        .result-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .result-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s ease;
            font-size: 0.9em;
            font-family: inherit;
        }

        .preview-btn {
            background: rgba(0, 0, 0, 0.05);
            color: var(--text-primary);
        }

        [data-theme="dark"] .preview-btn {
            background: rgba(255, 255, 255, 0.1);
        }

        .preview-btn:hover {
            background: rgba(0, 122, 255, 0.1);
            color: var(--accent-blue);
        }

        [data-theme="dark"] .preview-btn:hover {
            background: rgba(10, 132, 255, 0.2);
        }

        .open-btn {
            background: var(--accent-blue);
            color: white;
        }

        .open-btn:hover {
            background: #0062cc;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 122, 255, 0.3);
        }

        .preview-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }

        .preview-modal.active {
            display: flex;
        }

        .preview-content {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(40px) saturate(180%);
            -webkit-backdrop-filter: blur(40px) saturate(180%);
            padding: 40px;
            border-radius: 20px;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
            animation: slideUp 0.3s ease;
        }

        [data-theme="dark"] .preview-content {
            background: rgba(28, 28, 30, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.6);
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .preview-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.1);
            color: var(--text-primary);
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2em;
            font-weight: 500;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        [data-theme="dark"] .preview-close {
            background: rgba(255, 255, 255, 0.1);
        }

        .preview-close:hover {
            background: rgba(0, 0, 0, 0.2);
            transform: scale(1.1);
        }

        [data-theme="dark"] .preview-close:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .preview-header {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }

        .preview-title {
            font-size: 1.8em;
            color: var(--text-primary);
            margin-bottom: 10px;
            font-weight: 600;
        }

        .preview-body {
            color: var(--text-secondary);
            line-height: 1.8;
        }

        .encounter-display {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            padding: 30px;
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.06);
            display: none;
            animation: fadeIn 0.5s ease-in;
        }

        [data-theme="dark"] .encounter-display {
            background: rgba(28, 28, 30, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .encounter-display.active {
            display: block;
        }

        .encounter-section {
            margin-bottom: 30px;
            padding: 24px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 16px;
            border: 1px solid rgba(0, 0, 0, 0.06);
        }

        [data-theme="dark"] .encounter-section {
            background: rgba(58, 58, 60, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .encounter-section h2 {
            color: var(--text-primary);
            margin-bottom: 15px;
            font-size: 1.6em;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            user-select: none;
            transition: all 0.2s ease;
        }

        .encounter-section h2:hover {
            color: var(--accent-blue);
        }

        .section-toggle {
            font-size: 0.8em;
            color: var(--text-secondary);
            transition: transform 0.3s ease;
        }

        .section-toggle.collapsed {
            transform: rotate(-90deg);
        }

        .section-content {
            max-height: 5000px;
            overflow: hidden;
            transition: max-height 0.3s ease, opacity 0.3s ease;
            opacity: 1;
        }

        .section-content.collapsed {
            max-height: 0;
            opacity: 0;
        }

        .encounter-section h3 {
            color: var(--accent-blue);
            margin-top: 20px;
            margin-bottom: 10px;
            font-size: 1.3em;
            font-weight: 600;
        }

        .skill-check {
            background: rgba(0, 122, 255, 0.05);
            padding: 15px;
            margin: 10px 0;
            border-radius: 12px;
            border-left: 3px solid var(--accent-blue);
        }

        .skill-check-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .skill-name {
            font-weight: 600;
            color: var(--accent-blue);
            font-size: 1.05em;
        }

        .dc {
            background: var(--accent-blue);
            padding: 4px 12px;
            border-radius: 10px;
            font-weight: 600;
            color: white;
            font-size: 0.9em;
        }

        .hazard {
            background: rgba(255, 59, 48, 0.05);
            padding: 15px;
            margin: 10px 0;
            border-radius: 12px;
            border-left: 3px solid #ff3b30;
        }

        .hazard-name {
            font-weight: 600;
            color: #ff3b30;
            font-size: 1.1em;
            margin-bottom: 8px;
        }

        .trap {
            background: rgba(255, 149, 0, 0.05);
            padding: 15px;
            margin: 10px 0;
            border-radius: 12px;
            border-left: 3px solid #ff9500;
        }

        .trap-name {
            font-weight: 600;
            color: #ff9500;
            font-size: 1.1em;
            margin-bottom: 8px;
        }

        .scaling-note {
            background: rgba(0, 122, 255, 0.05);
            padding: 15px;
            border-radius: 12px;
            margin: 10px 0;
            border: 1px solid rgba(0, 122, 255, 0.2);
        }

        .level-badge {
            display: inline-block;
            background: var(--accent-blue);
            padding: 4px 10px;
            border-radius: 8px;
            font-size: 0.85em;
            margin-right: 8px;
            font-weight: 600;
            color: white;
        }

        .environmental-effect {
            background: rgba(90, 200, 250, 0.05);
            padding: 15px;
            margin: 10px 0;
            border-radius: 12px;
            border-left: 3px solid var(--accent-light);
        }

        .effect-name {
            font-weight: 600;
            color: var(--accent-light);
            font-size: 1.05em;
            margin-bottom: 8px;
        }

        ul {
            margin-left: 20px;
            line-height: 1.8;
        }

        li {
            margin: 8px 0;
            color: var(--text-secondary);
        }

        .description {
            line-height: 1.8;
            color: var(--text-secondary);
            margin: 10px 0;
        }

        .room-display {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            padding: 30px;
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.06);
        }

        [data-theme="dark"] .room-display {
            background: rgba(28, 28, 30, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 2em;
            }

            .environment-tags {
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            }

            .controls, .encounter-display, .room-display {
                padding: 20px;
            }

            .preview-content {
                padding: 30px 20px;
                max-width: 95%;
            }

            .location-detail-panel {
                top: 0;
                right: -100%;
                width: 100%;
                max-width: 100%;
                max-height: 100vh;
                border-radius: 0;
            }

            .location-detail-panel.active {
                right: 0;
            }
        }
    </style>
</head>
<body>
    <div class="main-content" id="mainContent">
        <div class="container">
            <header>
                <h1>⚔️ LoreWeaver ⚔️</h1>
                <p class="subtitle">D&D Exploration Encounter Generator</p>
                
                <!-- Navigation Tabs -->
                <div class="nav-tabs">
                    <button class="nav-tab active" onclick="switchPage('generate')">🎲 Generate</button>
                    <button class="nav-tab" onclick="switchPage('npc')">👤 NPCs</button>
                    <button class="nav-tab" onclick="switchPage('search')">🔍 Search</button>
                    <button class="nav-tab" onclick="switchPage('settings')">⚙️ Settings</button>
                </div>
        </header>

        <!-- Generate Page -->
        <div id="generatePage" class="page-content">
            <div class="controls">
                <div class="control-group">
                    <label for="environment">Select Environment:</label>
                    <div class="environment-tags" id="environmentTags">
                        <div class="tag" data-env="urban">🏛️ Urban</div>
                        <div class="tag" data-env="arctic">❄️ Arctic</div>
                        <div class="tag" data-env="ocean">🌊 Ocean</div>
                        <div class="tag" data-env="space">🌌 Space</div>
                        <div class="tag" data-env="crypt">💀 Crypt</div>
                        <div class="tag" data-env="forest">🌲 Forest</div>
                        <div class="tag" data-env="desert">🏜️ Desert</div>
                        <div class="tag" data-env="mountain">⛰️ Mountain</div>
                        <div class="tag" data-env="swamp">🐊 Swamp</div>
                        <div class="tag" data-env="underground">🕳️ Underground</div>
                    </div>
                </div>

                <div class="control-group">
                    <label for="partyLevel">Party Level (1-20):</label>
                    <input type="number" id="partyLevel" min="1" max="20" value="5">
                </div>

                <button onclick="generateEncounter()">🎲 Generate Encounter</button>
            </div>

            <div class="encounter-display" id="encounterDisplay">
                <div id="encounterContent"></div>
            </div>

            <!-- Room Display -->
            <div class="room-display" id="roomDisplay" style="display: none;">
                <button onclick="returnToEncounter()" class="btn-danger btn-medium">
                    ← Back to Encounter
                </button>
                <div id="roomContent"></div>
            </div>
        </div>

        <!-- Location Detail Panel (Sticky) -->
        <div class="location-detail-panel" id="locationDetailPanel">
            <div class="close-btn" onclick="hideLocationDetail()">×</div>
            <div id="locationDetailContent"></div>
        </div>

        <!-- NPC Detail Panel (Sticky) -->
        <div class="location-detail-panel" id="npcDetailPanel">
            <div class="close-btn" onclick="hideNPCDetail()">×</div>
            <div id="npcDetailContent"></div>
        </div>

        <!-- NPC Hover Tooltip -->
        <div class="npc-tooltip" id="npcTooltip"></div>

        <!-- Flow Navigator (Left Side Panel) -->
        <div class="flow-navigator-toggle" id="flowNavigatorToggle" onclick="toggleFlowNavigator()">
            ▶
        </div>
        <div class="flow-navigator" id="flowNavigator">
            <div class="flow-nav-header">🗺️ Encounter Flow</div>
            <div id="flowNavigatorContent"></div>
        </div>

        <!-- NPC Generator Page -->
        <div id="npcPage" class="page-content" style="display: none;">
            <div class="controls">
                <h2 style="margin-bottom: 10px; color: var(--text-primary);">👤 NPC Generator</h2>
                <p style="color: var(--text-secondary); margin-bottom: 20px; font-size: 0.95em;">
                    Choose specific traits or leave as "Random" for a surprise character!
                </p>
                
                <div class="control-group">
                    <label for="npcSpecies">Species:</label>
                    <select id="npcSpecies">
                        <option value="random">Random</option>
                        <option value="human">Human</option>
                        <option value="elf">Elf</option>
                        <option value="dwarf">Dwarf</option>
                        <option value="halfling">Halfling</option>
                        <option value="dragonborn">Dragonborn</option>
                        <option value="tiefling">Tiefling</option>
                        <option value="gnome">Gnome</option>
                        <option value="half-elf">Half-Elf</option>
                        <option value="half-orc">Half-Orc</option>
                        <option value="genasi">Genasi</option>
                        <option value="aasimar">Aasimar</option>
                        <option value="goliath">Goliath</option>
                        <option value="kenku">Kenku</option>
                        <option value="kobold">Kobold</option>
                        <option value="harengon">Harengon</option>
                        <option value="satyr">Satyr</option>
                        <option value="shadow-fey">Shadow Fey</option>
                        <option value="shifter">Shifter</option>
                        <option value="yuan-ti">Yuan-Ti</option>
                    </select>
                </div>

                <div class="control-group">
                    <label for="npcProfession">Profession:</label>
                    <select id="npcProfession">
                        <option value="random">Random</option>
                        <option value="Blacksmith">Blacksmith</option>
                        <option value="Merchant">Merchant</option>
                        <option value="Innkeeper">Innkeeper</option>
                        <option value="Guard">Guard</option>
                        <option value="Farmer">Farmer</option>
                        <option value="Alchemist">Alchemist</option>
                        <option value="Cleric">Cleric</option>
                        <option value="Wizard">Wizard</option>
                        <option value="Thief">Thief</option>
                        <option value="Bard">Bard</option>
                        <option value="Sailor">Sailor</option>
                        <option value="Hunter">Hunter</option>
                        <option value="Scholar">Scholar</option>
                        <option value="Noble">Noble</option>
                        <option value="Beggar">Beggar</option>
                        <option value="Artisan">Artisan</option>
                        <option value="Soldier">Soldier</option>
                        <option value="Herbalist">Herbalist</option>
                        <option value="Gambler">Gambler</option>
                        <option value="Priest">Priest</option>
                        <option value="Assassin">Assassin</option>
                        <option value="Spy">Spy</option>
                        <option value="Gladiator">Gladiator</option>
                        <option value="Cartographer">Cartographer</option>
                        <option value="Fortune Teller">Fortune Teller</option>
                    </select>
                </div>

                <div class="control-group">
                    <label for="npcAlignment">Alignment:</label>
                    <select id="npcAlignment">
                        <option value="random">Random</option>
                        <option value="Lawful Good">Lawful Good</option>
                        <option value="Neutral Good">Neutral Good</option>
                        <option value="Chaotic Good">Chaotic Good</option>
                        <option value="Lawful Neutral">Lawful Neutral</option>
                        <option value="True Neutral">True Neutral</option>
                        <option value="Chaotic Neutral">Chaotic Neutral</option>
                        <option value="Lawful Evil">Lawful Evil</option>
                        <option value="Neutral Evil">Neutral Evil</option>
                        <option value="Chaotic Evil">Chaotic Evil</option>
                    </select>
                </div>

                <div class="control-group">
                    <label for="npcPersonality">Personality:</label>
                    <select id="npcPersonality">
                        <option value="random">Random</option>
                        <option value="Argumentative and stubborn">Argumentative and stubborn</option>
                        <option value="Cheerful and optimistic">Cheerful and optimistic</option>
                        <option value="Curious and inquisitive">Curious and inquisitive</option>
                        <option value="Cynical and distrustful">Cynical and distrustful</option>
                        <option value="Friendly and helpful">Friendly and helpful</option>
                        <option value="Greedy and materialistic">Greedy and materialistic</option>
                        <option value="Honest and forthright">Honest and forthright</option>
                        <option value="Humble and modest">Humble and modest</option>
                        <option value="Impulsive and reckless">Impulsive and reckless</option>
                        <option value="Lazy and unmotivated">Lazy and unmotivated</option>
                        <option value="Melancholic and brooding">Melancholic and brooding</option>
                        <option value="Nervous and anxious">Nervous and anxious</option>
                        <option value="Proud and arrogant">Proud and arrogant</option>
                        <option value="Quiet and observant">Quiet and observant</option>
                        <option value="Sarcastic and witty">Sarcastic and witty</option>
                        <option value="Secretive and mysterious">Secretive and mysterious</option>
                        <option value="Serious and stern">Serious and stern</option>
                        <option value="Superstitious and cautious">Superstitious and cautious</option>
                        <option value="Theatrical and dramatic">Theatrical and dramatic</option>
                        <option value="Violent and aggressive">Violent and aggressive</option>
                    </select>
                </div>

                <button onclick="generateNPC()">✨ Generate NPC</button>
            </div>

            <div class="encounter-display" id="npcDisplay">
                <div class="encounter-section">
                    <h2>🎲 Your NPC Will Appear Here</h2>
                    <p class="description">Click "Generate NPC" to create a diverse and interesting character for your campaign!</p>
                </div>
            </div>
        </div>

        <!-- Search Page -->
        <div id="searchPage" class="page-content" style="display: none;">
            <div class="search-controls">
                <div class="search-bar">
                    <input type="text" id="searchInput" placeholder="Search encounters and locations (e.g., 'tomb', 'ship', 'forest')..." />
                    <button onclick="performSearch()">🔍 Search</button>
                </div>

                <div class="filter-section">
                    <h3>Filter by Tags:</h3>
                    <div class="filter-group">
                        <label>Environment:</label>
                        <div class="filter-tags" id="envFilters"></div>
                    </div>
                    <div class="filter-group">
                        <label>Location Type:</label>
                        <div class="filter-tags" id="locationFilters"></div>
                    </div>
                    <div class="filter-group">
                        <label>Setting:</label>
                        <div class="filter-tags" id="settingFilters"></div>
                    </div>
                    <button onclick="clearFilters()" class="btn-small">Clear All Filters</button>
                </div>
            </div>

            <div class="search-results" id="searchResults">
                <p style="text-align: center; color: var(--text-dark); padding: 40px;">Enter a search term or select tags to find encounters and locations</p>
            </div>
        </div>

        <!-- Settings Page -->
        <div id="settingsPage" class="page-content" style="display: none;">
            <div class="controls">
                <h2 style="margin-bottom: 30px; color: var(--text-primary); font-size: 2em;">⚙️ Settings</h2>
                
                <div class="settings-section">
                    <h2>Appearance</h2>
                    
                    <div class="setting-item">
                        <div class="setting-info">
                            <h3>Dark Mode</h3>
                            <p>Toggle between light and dark theme</p>
                        </div>
                        <div class="theme-switch" id="themeSwitch" onclick="toggleTheme()">
                            <div class="theme-switch-slider">
                                <span class="theme-icon">🌙</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="settings-section">
                    <h2>Location Details Display</h2>
                    
                    <div class="setting-item">
                        <div class="setting-info">
                            <h3>Progressive Reveal</h3>
                            <p>When enabled, location details are revealed progressively (Primary → Secondary → Hidden). When disabled, all information is shown at once.</p>
                        </div>
                        <div class="theme-switch" id="progressiveRevealSwitch" onclick="toggleProgressiveReveal()">
                            <div class="theme-switch-slider">
                                <span class="theme-icon">🔍</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="settings-section">
                    <h2>About</h2>
                    <p style="color: var(--text-secondary); line-height: 1.8;">
                        <strong style="color: var(--text-primary);">LoreWeaver</strong> is a D&D exploration encounter generator designed to help Dungeon Masters create engaging and dynamic encounters across various environments.
                    </p>
                    <p style="color: var(--text-secondary); margin-top: 16px; line-height: 1.8;">
                        Generate random encounters and locations, or search through the library to find exactly what you need for your campaign.
                    </p>
                </div>
            </div>
        </div>

        <!-- Preview Modal -->
        <div id="previewModal" class="preview-modal">
            <div class="preview-content">
                <button class="preview-close" onclick="closePreview()">✕</button>
                <div id="previewBody"></div>
            </div>
        </div>
    </div>

    <script>
        let selectedEnvironment = 'urban';

        // Search page state
        let activeFilters = {
            environment: [],
            locationType: [],
            setting: []
        };

        // Data - if external JSON files fail to load, this embedded data is used as fallback
        // To update content: Edit encounters.json and locations.json files
        // The app will try to load from those files first, then fall back to this embedded data
        
        var encounterTitles = {};
        var locationObjects = {};
        var npcData = {};
        var skillChecksData = {};
        var dangersData = {};

        let dataLoaded = false;

        // Load data on page load (tries external files, falls back to embedded data)
        async function loadData() {
            try {
                console.log('Starting data load...');
                const [encountersResponse, locationsResponse, npcsResponse, skillChecksResponse, dangersResponse] = await Promise.all([
                    fetch('encounters.json').catch(err => { console.error('Failed to fetch encounters.json:', err); return null; }),
                    fetch('locations.json').catch(err => { console.error('Failed to fetch locations.json:', err); return null; }),
                    fetch('npcs.json').catch(err => { console.error('Failed to fetch npcs.json:', err); return null; }),
                    fetch('skillchecks.json').catch(err => { console.error('Failed to fetch skillchecks.json:', err); return null; }),
                    fetch('dangers.json').catch(err => { console.error('Failed to fetch dangers.json:', err); return null; })
                ]);

                if (encountersResponse && encountersResponse.ok) {
                    encounterTitles = await encountersResponse.json();
                    console.log('✓ Loaded encounters.json:', Object.keys(encounterTitles).length, 'environments');
                    console.log('✓ Urban encounters count:', encounterTitles.urban?.length);
                    if (encounterTitles.urban && encounterTitles.urban.length > 0) {
                        console.log('✓ Sample encounter:', encounterTitles.urban[0].title, '- Has description:', !!encounterTitles.urban[0].description);
                    }
                } else {
                    console.error('❌ Failed to load encounters.json - response:', encountersResponse?.status);
                }
                
                if (locationsResponse && locationsResponse.ok) {
                    locationObjects = await locationsResponse.json();
                    console.log('✓ Loaded locations.json');
                } else {
                    console.error('❌ Failed to load locations.json - response:', locationsResponse?.status);
                }
                
                if (npcsResponse && npcsResponse.ok) {
                    npcData = await npcsResponse.json();
                    console.log('✓ Loaded npcs.json');
                } else {
                    console.error('❌ Failed to load npcs.json - response:', npcsResponse?.status);
                }
                
                if (skillChecksResponse && skillChecksResponse.ok) {
                    skillChecksData = await skillChecksResponse.json();
                    console.log('✓ Loaded skillchecks.json:', skillChecksData.skillChecks?.length || 0, 'skill checks');
                } else {
                    console.error('❌ Failed to load skillchecks.json - response:', skillChecksResponse?.status);
                }
                
                if (dangersResponse && dangersResponse.ok) {
                    dangersData = await dangersResponse.json();
                    console.log('✓ Loaded dangers.json:', 
                        dangersData.traps?.length || 0, 'traps,',
                        dangersData.hazards?.length || 0, 'hazards,',
                        dangersData.environmentalEffects?.length || 0, 'effects');
                } else {
                    console.error('❌ Failed to load dangers.json - response:', dangersResponse?.status);
                }
                
                dataLoaded = true;
                console.log('✓ Data load complete. encounterTitles keys:', Object.keys(encounterTitles));
            } catch (error) {
                console.error('❌ Error during data load:', error);
                dataLoaded = false;
            }
        }

        // Call loadData and setup event listeners when page loads
        document.addEventListener('DOMContentLoaded', async function() {
            // Load saved theme
            loadTheme();
            
            // Load progressive reveal setting
            loadProgressiveReveal();
            
            // Load external data files
            await loadData();

            // Setup Enter key for search input
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        performSearch();
                    }
                });
            }
        });

        // REMOVED: Encounter titles now loaded from encounters.json
        
        // REMOVED: Location objects now loaded from locations.json

        // Theme toggle
        function toggleTheme() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            
            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            
            // Update icon and switch state
            updateThemeUI(newTheme);
        }

        // Update theme UI elements
        function updateThemeUI(theme) {
            const icons = document.querySelectorAll('.theme-icon');
            const themeSwitch = document.getElementById('themeSwitch');
            
            icons.forEach(icon => {
                icon.textContent = theme === 'dark' ? '☀️' : '🌙';
            });
            
            if (themeSwitch) {
                if (theme === 'dark') {
                    themeSwitch.classList.add('active');
                } else {
                    themeSwitch.classList.remove('active');
                }
            }
        }

        // Load saved theme on page load
        function loadTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            updateThemeUI(savedTheme);
        }

        // Progressive reveal toggle
        function toggleProgressiveReveal() {
            const currentSetting = localStorage.getItem('progressiveReveal') === 'true';
            const newSetting = !currentSetting;
            
            localStorage.setItem('progressiveReveal', newSetting);
            updateProgressiveRevealUI(newSetting);
        }

        // Update progressive reveal UI
        function updateProgressiveRevealUI(enabled) {
            const progressiveRevealSwitch = document.getElementById('progressiveRevealSwitch');
            const icon = progressiveRevealSwitch?.querySelector('.theme-icon');
            
            if (progressiveRevealSwitch) {
                if (enabled) {
                    progressiveRevealSwitch.classList.add('active');
                    if (icon) icon.textContent = '🔓';
                } else {
                    progressiveRevealSwitch.classList.remove('active');
                    if (icon) icon.textContent = '🔍';
                }
            }
        }

        // Load progressive reveal setting on page load
        function loadProgressiveReveal() {
            const savedSetting = localStorage.getItem('progressiveReveal') === 'true';
            updateProgressiveRevealUI(savedSetting);
        }

        // Page switching
        function switchPage(page) {
            document.getElementById('generatePage').style.display = 'none';
            document.getElementById('npcPage').style.display = 'none';
            document.getElementById('searchPage').style.display = 'none';

            document.getElementById('settingsPage').style.display = 'none';
            
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));

            if (page === 'generate') {
                document.getElementById('generatePage').style.display = 'block';
                document.querySelectorAll('.nav-tab')[0].classList.add('active');
            } else if (page === 'npc') {
                document.getElementById('npcPage').style.display = 'block';
                document.querySelectorAll('.nav-tab')[1].classList.add('active');
            } else if (page === 'search') {
                document.getElementById('searchPage').style.display = 'block';
                document.querySelectorAll('.nav-tab')[2].classList.add('active');
                initializeSearchFilters();
            } else if (page === 'settings') {
                document.getElementById('settingsPage').style.display = 'block';
                document.querySelectorAll('.nav-tab')[3].classList.add('active');
            }
        }

        // Initialize search filters
        function initializeSearchFilters() {
            if (document.getElementById('envFilters').children.length > 0) return;

            const envFilters = document.getElementById('envFilters');
            const environments = ['urban', 'arctic', 'ocean', 'space', 'crypt', 'forest', 'desert', 'mountain', 'swamp', 'underground'];
            const envIcons = { urban: '🏛️', arctic: '❄️', ocean: '🌊', space: '🌌', crypt: '💀', forest: '🌲', desert: '🏜️', mountain: '⛰️', swamp: '🐊', underground: '🕳️' };

            environments.forEach(env => {
                const tag = document.createElement('div');
                tag.className = 'filter-tag';
                tag.textContent = `${envIcons[env]} ${env.charAt(0).toUpperCase() + env.slice(1)}`;
                tag.dataset.filter = env;
                tag.dataset.type = 'environment';
                tag.onclick = () => toggleFilter(tag, 'environment', env);
                envFilters.appendChild(tag);
            });

            const locationFilters = document.getElementById('locationFilters');
            const locationTypes = ['indoor', 'outdoor', 'building', 'street', 'cave', 'ruins', 'ship', 'underwater', 'tunnel', 'chamber', 'wilderness', 'path'];

            locationTypes.forEach(type => {
                const tag = document.createElement('div');
                tag.className = 'filter-tag';
                tag.textContent = type.charAt(0).toUpperCase() + type.slice(1);
                tag.dataset.filter = type;
                tag.dataset.type = 'locationType';
                tag.onclick = () => toggleFilter(tag, 'locationType', type);
                locationFilters.appendChild(tag);
            });

            const settingFilters = document.getElementById('settingFilters');
            const settings = ['natural', 'manmade', 'magical', 'tomb', 'void', 'water', 'urban', 'wilderness'];

            settings.forEach(setting => {
                const tag = document.createElement('div');
                tag.className = 'filter-tag';
                tag.textContent = setting.charAt(0).toUpperCase() + setting.slice(1);
                tag.dataset.filter = setting;
                tag.dataset.type = 'setting';
                tag.onclick = () => toggleFilter(tag, 'setting', setting);
                settingFilters.appendChild(tag);
            });
        }

        // Toggle filter
        function toggleFilter(element, type, value) {
            element.classList.toggle('active');

            const index = activeFilters[type].indexOf(value);
            if (index > -1) {
                activeFilters[type].splice(index, 1);
            } else {
                activeFilters[type].push(value);
            }

            performSearch();
        }

        // Clear filters
        function clearFilters() {
            activeFilters = {
                environment: [],
                locationType: [],
                setting: []
            };

            document.querySelectorAll('.filter-tag').forEach(tag => {
                tag.classList.remove('active');
            });

            document.getElementById('searchInput').value = '';
            performSearch();
        }

        // Perform search
        function performSearch() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
            const results = [];

            // Search encounters
            for (const [environment, encounters] of Object.entries(encounterTitles)) {
                encounters.forEach(encounter => {
                    let matches = true;

                    if (activeFilters.environment.length > 0 && !activeFilters.environment.includes(environment)) {
                        matches = false;
                    }

                    if (activeFilters.locationType.length > 0) {
                        const hasMatchingTag = encounter.tags.some(tag => activeFilters.locationType.includes(tag));
                        if (!hasMatchingTag) matches = false;
                    }

                    if (activeFilters.setting.length > 0) {
                        const hasMatchingTag = encounter.tags.some(tag => activeFilters.setting.includes(tag));
                        if (!hasMatchingTag) matches = false;
                    }

                    if (searchTerm) {
                        const titleMatch = encounter.title.toLowerCase().includes(searchTerm);
                        const tagMatch = encounter.tags.some(tag => tag.toLowerCase().includes(searchTerm));
                        const envMatch = environment.toLowerCase().includes(searchTerm);

                        if (!titleMatch && !tagMatch && !envMatch) {
                            matches = false;
                        }
                    }

                    if (matches) {
                        results.push({
                            type: 'encounter',
                            title: encounter.title,
                            environment: environment,
                            tags: encounter.tags,
                            description: buildEncounterDescription(environment, encounter.title, encounter.description)
                        });
                    }
                });
            }

            // Search locations
            for (const [environment, locations] of Object.entries(locationObjects)) {
                for (const [locationType, locationData] of Object.entries(locations)) {
                    let matches = true;

                    if (activeFilters.environment.length > 0 && !activeFilters.environment.includes(environment)) {
                        matches = false;
                    }

                    if (activeFilters.locationType.length > 0) {
                        const hasMatchingTag = locationData.tags.some(tag => activeFilters.locationType.includes(tag));
                        if (!hasMatchingTag) matches = false;
                    }

                    if (activeFilters.setting.length > 0) {
                        const hasMatchingTag = locationData.tags.some(tag => activeFilters.setting.includes(tag));
                        if (!hasMatchingTag) matches = false;
                    }

                    if (searchTerm) {
                        const typeMatch = locationType.toLowerCase().includes(searchTerm);
                        const tagMatch = locationData.tags.some(tag => tag.toLowerCase().includes(searchTerm));
                        const envMatch = environment.toLowerCase().includes(searchTerm);
                        const primaryMatch = locationData.primary.some(obj => obj.toLowerCase().includes(searchTerm));
                        const secondaryMatch = locationData.secondary.some(obj => obj.toLowerCase().includes(searchTerm));
                        const tertiaryMatch = locationData.tertiary.some(obj => obj.toLowerCase().includes(searchTerm));

                        if (!typeMatch && !tagMatch && !envMatch && !primaryMatch && !secondaryMatch && !tertiaryMatch) {
                            matches = false;
                        }
                    }

                    if (matches) {
                        const totalObjects = locationData.primary.length + locationData.secondary.length + locationData.tertiary.length;
                        const locationDescription = locationData.description || `Explore ${totalObjects} interactable objects across 3 layers of detail`;
                        results.push({
                            type: 'location',
                            title: `${locationType.charAt(0).toUpperCase() + locationType.slice(1)} (${environment})`,
                            environment: environment,
                            locationType: locationType,
                            tags: locationData.tags,
                            description: locationDescription,
                            objects: locationData.primary.slice(0, 4).join(', ') + '...'
                        });
                    }
                }
            }

            displaySearchResults(results);
        }

        // Display search results
        function displaySearchResults(results) {
            const container = document.getElementById('searchResults');

            if (results.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 40px;">No results found. Try different keywords or filters.</p>';
                return;
            }

            let html = `<h2 style="color: var(--accent-blue); margin-bottom: 20px;">Found ${results.length} result${results.length !== 1 ? 's' : ''}</h2>`;

            results.forEach((result, index) => {
                const typeColor = result.type === 'encounter' ? '#3498db' : '#2ecc71';

                html += `
                    <div class="result-card">
                        <div class="result-title">${result.title}</div>
                        <span class="result-type" style="background: ${typeColor};">${result.type.toUpperCase()}</span>
                        <span class="result-type" style="background: var(--accent-blue);">${result.environment.toUpperCase()}</span>
                        <p class="result-description">${result.description}</p>
                        ${result.objects ? `<p class="result-description"><strong>Sample objects:</strong> ${result.objects}</p>` : ''}
                        <div class="result-tags">
                            ${result.tags.map(tag => `<span class="result-tag">${tag}</span>`).join('')}
                        </div>
                        <div class="result-actions">
                            <button class="result-btn preview-btn" onclick='previewResult(${index})'>👁️ Preview</button>
                            <button class="result-btn open-btn" onclick='openResult(${index})'>📂 Open</button>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
            window.searchResults = results;
        }

        // Preview result
        function previewResult(index) {
            const result = window.searchResults[index];
            const modal = document.getElementById('previewModal');
            const previewBody = document.getElementById('previewBody');

            let html = `
                <div class="preview-header">
                    <div class="preview-title">${result.title}</div>
                    <div style="display: flex; gap: 10px; margin-top: 10px;">
                        <span class="result-type" style="background: ${result.type === 'encounter' ? '#3498db' : '#2ecc71'};">${result.type.toUpperCase()}</span>
                        <span class="result-type" style="background: var(--accent-blue);">${result.environment.toUpperCase()}</span>
                    </div>
                </div>
                <div class="preview-body">
            `;

            if (result.type === 'encounter') {
                html += `
                    <h3 style="color: var(--accent-blue); margin-bottom: 15px;">📜 Encounter Overview</h3>
                    <p style="margin-bottom: 20px; color: var(--text-primary);">${result.description}</p>

                    <h3 style="color: #2ecc71; margin-bottom: 15px;">🏷️ Tags</h3>
                    <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 20px;">
                        ${result.tags.map(tag => `<span class="result-tag">${tag}</span>`).join('')}
                    </div>

                    <h3 style="color: #f39c12; margin-bottom: 15px;">🎲 What to Expect</h3>
                    <ul style="margin-left: 20px; line-height: 2; color: var(--text-primary);">
                        <li>Skill challenges themed to ${result.environment} exploration</li>
                        <li>Mechanical, magical, or environmental traps</li>
                        <li>Natural, supernatural, or creature-based hazards</li>
                        <li>Environmental effects unique to ${result.environment} settings</li>
                    </ul>

                    <div style="margin-top: 30px; text-align: center;">
                        <button class="open-btn" onclick='closePreview(); openResult(${index});' style="padding: 12px 30px; font-size: 1.1em;">
                            📂 Open Full Encounter
                        </button>
                    </div>
                `;
            } else {
                html += `
                    <h3 style="color: var(--accent-blue); margin-bottom: 15px;">📍 Location Overview</h3>
                    <p style="margin-bottom: 20px; color: var(--text-primary);">${result.description}</p>

                    <h3 style="color: #2ecc71; margin-bottom: 15px;">🏷️ Tags</h3>
                    <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 20px;">
                        ${result.tags.map(tag => `<span class="result-tag">${tag}</span>`).join('')}
                    </div>

                    <h3 style="color: #f39c12; margin-bottom: 15px;">🔍 Sample Objects</h3>
                    <p style="margin-left: 20px; line-height: 2; color: var(--text-primary);">${result.objects}</p>

                    <div style="margin-top: 30px; text-align: center;">
                        <button class="open-btn" onclick='closePreview(); openResult(${index});' style="padding: 12px 30px; font-size: 1.1em;">
                            📂 Generate This Location
                        </button>
                    </div>
                `;
            }

            html += `</div>`;
            previewBody.innerHTML = html;
            modal.classList.add('active');
        }

        // Close preview
        function closePreview() {
            document.getElementById('previewModal').classList.remove('active');
        }

        // Close modal when clicking outside
        document.addEventListener('click', function(e) {
            const modal = document.getElementById('previewModal');
            if (e.target === modal) {
                closePreview();
            }
        });

        // Open result
        function openResult(index) {
            const result = window.searchResults[index];

            if (result.type === 'encounter') {
                selectedEnvironment = result.environment;

                document.querySelectorAll('.tag').forEach(t => t.classList.remove('active'));
                const tag = document.querySelector(`.tag[data-env="${result.environment}"]`);
                if (tag) tag.classList.add('active');

                generateEncounter();
                switchPage('generate');

                setTimeout(() => {
                    document.getElementById('encounterDisplay').scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 100);
            } else if (result.type === 'location') {
                const locationData = locationObjects[result.environment][result.locationType];

                generateRoom(result.environment, result.locationType, locationData);
                switchPage('generate');

                setTimeout(() => {
                    document.getElementById('roomDisplay').scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 100);
            }
        }

        // Environment tag selection
        document.querySelectorAll('.tag').forEach(tag => {
            tag.addEventListener('click', function() {
                document.querySelectorAll('.tag').forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                selectedEnvironment = this.dataset.env;
            });
        });

        // Set default active tag
        document.querySelector('.tag[data-env="urban"]').classList.add('active');

        // Encounter data for skill checks, traps, hazards, and environmental effects
        const encounterData = {
            urban: {
                skillChecks: [
                    { skill: 'Stealth', purpose: 'ghosting through lantern-lit streets without drawing the eye of the watch or rival crews' },
                    { skill: 'Persuasion', purpose: 'coaxing gossip from tavern regulars or calming jittery witnesses' },
                    { skill: 'Insight', purpose: 'sussing out concealed motives behind polite smiles and officious decrees' },
                    { skill: 'Acrobatics', purpose: 'dancing across pitched rooftops and threadbare clotheslines with catlike balance' }
                ],
                traps: [
                    { name: 'Alley Ambush Setup', description: 'Broken barrels, dangling nets, and tripwires choke the narrow lane; triggering one cascades debris in a thunder of splinters and screams.' },
                    { name: 'Sewer Gas Pocket', description: 'A rancid swell of alchemical runoff waits beneath a loose grate, eager to blossom into hungry flame at the spark of a torch.' },
                    { name: 'Collapsing Scaffold', description: 'A mason\'s scaffold trembles with hidden faults - one incautious step sends timbers and tiles collapsing like a wooden avalanche.' },
                    { name: 'Guard Checkpoint', description: 'Steel helms and sharp eyes bar the way; without the right papers or a deft distraction, crossbow bolts and shackles follow.' }
                ],
                hazards: [
                    { name: 'Crowded Market', description: 'A sea of merchants and hawkers surges like a living tide, tangling cloaks and coin purses while unseen hands test every pocket.' },
                    { name: 'Crumbling Buildings', description: 'Abandoned tenements lean together in weary embrace; rotten beams creak underfoot before surrendering to sudden collapse.' },
                    { name: 'Polluted Waterways', description: 'Canals run slick with refuse and alchemical waste, promising fever dreams and gut-twisting curses to any who drink or fall within.' },
                    { name: 'Street Riots', description: 'Cobblestones become weapons as factions clash in a storm of banners, smoke, and hurled debris that swallows whole intersections.' }
                ],
                environmentalEffects: [
                    { name: 'City Noise', description: 'Bell towers, clattering hooves, and relentless gossip forge a constant din that drowns the softest warning or whispered spell.' },
                    { name: 'Smog and Smoke', description: 'Sooty chimneys cloak alleys in eye-stinging haze, stealing breath and weighing on the weary like a tangible shroud.' },
                    { name: 'Labyrinthine Streets', description: 'Switchback alleys and secret courts twist in Escher patterns, confounding memory unless a local map—or luck—guides the way.' }
                ]
            },
            arctic: {
                skillChecks: [
                    { skill: 'Survival', purpose: 'charting paths through needle-sharp winds and sculpting snow shelters before nightfall' },
                    { skill: 'Athletics', purpose: 'hauling companions up glassy cliffs and muscling through waist-high drifts' },
                    { skill: 'Perception', purpose: 'catching the whisper-crack of a forming avalanche or the pale gleam of hidden crevasses' },
                    { skill: 'Nature', purpose: 'reading the sky’s bruised palette to predict storms and judging which ice will bear weight' },
                    { skill: 'Constitution Save', purpose: 'locking mind and muscle against the soul-numbing cold that gnaws exposed flesh' }
                ],
                traps: [
                    { name: 'Hidden Crevasse', description: 'A yawning maw of blue-black ice lies veiled beneath powder; one misstep and the earth swallows the unwary whole.' },
                    { name: 'Thin Ice Patch', description: 'Glass-clear ice glints invitingly over a freezing abyss, splintering the moment true weight tests it.' },
                    { name: 'Snow Shelf', description: 'A fragile cornice hangs over the slope, ready to thunder down in a roaring white avalanche at the slightest vibration.' }
                ],
                hazards: [
                    { name: 'Extreme Cold', description: 'The world itself bites, leeching warmth and vigor until fingers stiffen and thoughts slow to glacial pace.' },
                    { name: 'Whiteout Conditions', description: 'Snow and sky merge into a blank, howling void where orientation is swallowed and sound feels distant.' },
                    { name: 'Avalanche Zone', description: 'Brittle slopes hold their breath, ready to erupt into a roaring cascade that buries trails and travelers alike.' },
                    { name: 'Freezing Water', description: 'A single plunge into black brine steals breath and hope, icing armor and limbs with deadly speed.' }
                ],
                environmentalEffects: [
                    { name: 'Slippery Ice', description: 'Wind-polished ice sheets gleam treacherously, turning every stride into a battle for balance.' },
                    { name: 'Limited Visibility', description: 'Whirling snow halos each torchlight, shrinking the world to a handful of ghostly shapes ahead.' },
                    { name: 'Frostbite Risk', description: 'The cold patiently gnaws at fingertips and ears, inflicting pale wounds that bloom black without swift care.' }
                ]
            },
            ocean: {
                skillChecks: [
                    { skill: 'Athletics', purpose: 'cutting through surging currents and clawing back onto pitching decks' },
                    { skill: 'Survival', purpose: 'steering by star and swell while reading the sea’s temper' },
                    { skill: 'Perception', purpose: 'spying reef-shadows, distant sails, or leviathan silhouettes before they strike' },
                    { skill: 'Nature', purpose: 'interpreting the ocean’s tides, omens, and hungry ecosystems' },
                    { skill: 'Acrobatics', purpose: 'dancing across rain-slick rigging and rolling timbers with sailor’s grace' }
                ],
                traps: [
                    { name: 'Whirlpool', description: 'A maelstrom yawns open, dragging ships into a spiraling throat of foam and splintered masts.' },
                    { name: 'Submerged Reef', description: 'Knife-edged coral lurks inches below the waves, eager to gut hulls and spill holds to the deep.' },
                    { name: 'Rip Current', description: 'A hidden river of water races seaward, snatching swimmers and wreckage into the open blue.' }
                ],
                hazards: [
                    { name: 'Storm at Sea', description: 'Towering waves and knife-sharp rain hurl the vessel between boiling sky and hungry depths.' },
                    { name: 'Dehydration', description: 'Salt-cracked lips and parched throats demand fresh water that the endless sea refuses to provide.' },
                    { name: 'Drowning', description: 'The deep welcomes the weary, wrapping them in cold silence once strength falters.' },
                    { name: 'Dangerous Marine Life', description: 'Predatory fins circle below while territorial beasts strike with barnacled fury.' }
                ],
                environmentalEffects: [
                    { name: 'Waves and Swells', description: 'Decks rise and fall like living things, turning even simple tasks into perilous feats.' },
                    { name: 'Salt Corrosion', description: 'Spray crusts every surface with salt, eating steel and stiffening leather to brittle ruin.' },
                    { name: 'Sun Exposure', description: 'Blistering sun glares off endless water, draining vitality unless shade and salves are at hand.' }
                ]
            },
            space: {
                skillChecks: [
                    { skill: 'Investigation', purpose: 'decoding alien circuitry and reconstructing the story etched in starlit wreckage' },
                    { skill: 'Arcana', purpose: 'communing with cosmic ley lines and taming raw stellar sorcery' },
                    { skill: 'Survival', purpose: 'rationing air, heat, and hope within the void’s indifferent silence' },
                    { skill: 'Athletics', purpose: 'darting through zero-gravity corridors with practiced thrusts and tethers' },
                    { skill: 'Perception', purpose: 'tracking glimmers of motion against the abyss before they become lethal' }
                ],
                traps: [
                    { name: 'Hull Breach', description: 'Fractured plating screams under pressure; the slightest misstep tears it open, venting air and adventurers into the stars.' },
                    { name: 'Radiation Pocket', description: 'Invisible auroras of lethal light bathe the corridor, searing flesh and warping magic alike.' },
                    { name: 'Magnetic Anomaly', description: 'A rogue magnetosphere seizes metal, wrenching gear from grips and pinning explorers to bulkheads.' }
                ],
                hazards: [
                    { name: 'Vacuum Exposure', description: 'The emptiness beyond the hull sucks warmth and breath away in a heartbeat.' },
                    { name: 'Meteor Shower', description: 'Needle-fine meteoroids slash past like celestial shrapnel, riddling armor and hull alike.' },
                    { name: 'Cosmic Radiation', description: 'Starfire whispers through shielding, leaving sickness and mutations in its wake.' },
                    { name: 'Micro-Gravity', description: 'Every action sends bodies drifting, turning combat into a ballet of inertia and spin.' }
                ],
                environmentalEffects: [
                    { name: 'Weightlessness', description: 'Without gravity, even the smallest force propels bodies into slow-motion orbits.' },
                    { name: 'Temperature Extremes', description: 'Sunward plating sizzles while shadowed hull frosts instantly, stressing gear and flesh.' },
                    { name: 'Communication Lag', description: 'Signals crawl through the void, forcing crews to plan carefully lest instructions arrive too late.' }
                ]
            },
            crypt: {
                skillChecks: [
                    { skill: 'Investigation', purpose: 'reading funerary carvings for concealed mechanisms and forgotten doorways' },
                    { skill: 'Religion', purpose: 'interpreting warding rites to appease ancient spirits' },
                    { skill: 'Perception', purpose: 'catching the cold shuffle of undead or the click of hidden triggers' },
                    { skill: 'Arcana', purpose: 'unraveling necromantic sigils before they awaken slumbering guardians' },
                    { skill: 'History', purpose: 'remembering dynastic feuds and legends tied to the honored dead' }
                ],
                traps: [
                    { name: 'Poison Dart Mechanism', description: 'Stone mosaics hide patient darts steeped in tomb venoms that still burn after centuries.' },
                    { name: 'Collapsing Tomb', description: 'A misjudged pry bar releases ancient counterweights, dropping the vault in a hail of stone.' },
                    { name: 'Cursed Treasure', description: 'Jeweled reliquaries clutch their owners’ spite, lashing thieves with wasting curses.' },
                    { name: 'Animated Guardians', description: 'Sarcophagi groan open as gilded statues or embalmed champions rise to enforce eternal vows.' }
                ],
                hazards: [
                    { name: 'Necrotic Aura', description: 'Every breath tastes of grave dust while necromantic energy gnaws at living flesh.' },
                    { name: 'Disease Vectors', description: 'Moldering wrappings and stagnant pools teem with forgotten plagues.' },
                    { name: 'Unstable Structure', description: 'Time-weakened pillars crumble at a touch, threatening to entomb intruders forever.' },
                    { name: 'Desecration Curse', description: 'Profaning burial rites calls forth wrathful spirits or hexes that linger long after the tomb.' }
                ],
                environmentalEffects: [
                    { name: 'Oppressive Darkness', description: 'Pitch blackness swallows torchlight, letting only whispers and cold drafts hint at vast chambers.' },
                    { name: 'Stale Air', description: 'Dust-choked stillness leaves lungs burning and torches guttering low.' },
                    { name: 'Unnerving Atmosphere', description: 'A chorus of remembered prayers and distant wails gnaws at courage and focus.' }
                ]
            },
            forest: {
                skillChecks: [
                    { skill: 'Survival', purpose: 'following faint tracks across moss and charting trails through tangled boughs' },
                    { skill: 'Nature', purpose: 'reading the language of leaves, spoor, and birdsong to gauge the forest mood' },
                    { skill: 'Stealth', purpose: 'slipping between fern fronds without stirring so much as a whisper' },
                    { skill: 'Perception', purpose: 'catching the flash of predator eyes or the creak of a rigged snare' },
                    { skill: 'Athletics', purpose: 'swinging across ravines and vaulting fallen trunks with rangerly ease' }
                ],
                traps: [
                    { name: 'Pit Trap', description: 'A leaf-draped pit yawns beneath the unwary, studded with sharpened stakes and damp earth.' },
                    { name: 'Snare Trap', description: 'A braided vine lashes tight around a limb, hoisting victims skyward amid snapping branches.' },
                    { name: 'Poisonous Plants', description: 'Glossy leaves conceal irritant oils and paralytic saps cultivated by territorial hunters.' }
                ],
                hazards: [
                    { name: 'Thick Undergrowth', description: 'Brambles and thorn-thick hedges clutch at boots, slowing progress to a crawl.' },
                    { name: 'Wild Beasts', description: 'The forest’s apex predators stalk intruders with cunning pack tactics.' },
                    { name: 'Quicksand', description: 'Mossy ground liquefies into sucking mire that drags down the panicked and unwary.' },
                    { name: 'Falling Branches', description: 'Storm-tossed limbs and widowmakers crash without warning, splintering armor and bone.' }
                ],
                environmentalEffects: [
                    { name: 'Limited Visibility', description: 'Sunlight filters in dappled shards, cloaking threats in emerald shadow.' },
                    { name: 'Disorientation', description: 'Every glade mirrors the last, turning compasses unreliable and paths into circles.' },
                    { name: 'Insect Swarms', description: 'Gnats and biting flies assail exposed skin, their droning hum fraying tempers.' }
                ]
            },
            desert: {
                skillChecks: [
                    { skill: 'Survival', purpose: 'charting wind-swept dunes and divining scarce water beneath cracked earth' },
                    { skill: 'Constitution Save', purpose: 'withstanding furnace heat and the desiccating bite of desert winds' },
                    { skill: 'Perception', purpose: 'separating mirage from oasis and spotting sandstorms before they loom' },
                    { skill: 'Nature', purpose: 'knowing which cactus heals and which hides scorpion nests' },
                    { skill: 'Athletics', purpose: 'cresting dune ridges and sprinting across searing sand before it swallows tracks' }
                ],
                traps: [
                    { name: 'Sinking Sand', description: 'A dune face collapses into a swirling pit, dragging prey beneath shimmering grains.' },
                    { name: 'Buried Hazards', description: 'Sun-warmed sand hides shattered masonry and glassy obsidian ready to slice boots and flesh.' },
                    { name: 'Scorpion Den', description: 'A seemingly lifeless hummock erupts with chittering stingers angered by careless footsteps.' }
                ],
                hazards: [
                    { name: 'Extreme Heat', description: 'The sun hammers from above while reflected glare cooks armor from below.' },
                    { name: 'Dehydration', description: 'Sweat evaporates before it forms, leaving throats raw and minds swimming.' },
                    { name: 'Sandstorm', description: 'A wall of grit roars across the dunes, flaying exposed skin and burying tracks in moments.' },
                    { name: 'Heat Mirages', description: 'Shimmering heat paints false rivers and phantom caravans on the horizon.' }
                ],
                environmentalEffects: [
                    { name: 'Difficult Terrain', description: 'Shifting dunes swallow footsteps and sap strength with every stride.' },
                    { name: 'Temperature Swings', description: 'Night plummets from blistering heat to knife-edged cold in the span of a sunset.' },
                    { name: 'Sun Glare', description: 'White sand and sky fuse into blinding brilliance, forcing eyes beneath hoods and veils.' }
                ]
            },
            mountain: {
                skillChecks: [
                    { skill: 'Athletics', purpose: 'hauling bodies up sheer cliffs and bracing against punishing grades' },
                    { skill: 'Survival', purpose: 'reading scree slopes and storm fronts to keep the path safe' },
                    { skill: 'Acrobatics', purpose: 'tiptoeing along knife-edge ridges with avalanches yawning below' },
                    { skill: 'Perception', purpose: 'noticing treacherous handholds or distant rockfalls before they strike' },
                    { skill: 'Constitution Save', purpose: 'fighting off altitude sickness and lung-searing chill' }
                ],
                traps: [
                    { name: 'Rockfall Trigger', description: 'A single dislodged stone cascades into a roaring avalanche of boulders.' },
                    { name: 'False Handhold', description: 'Seemingly sturdy outcroppings shear away, sending climbers pitching into the void.' },
                    { name: 'Ice Bridge', description: 'A frost-frosted span hides a yawning crevasse, fracturing under the weight of the unwary.' }
                ],
                hazards: [
                    { name: 'Thin Air', description: 'Each breath is a labor, leaving muscles weak and thoughts hazy.' },
                    { name: 'Rockslides', description: 'Mountains shrug off cloaks of stone, pelting climbers with jagged shards.' },
                    { name: 'Sudden Storms', description: 'Thunderheads roll in with little warning, hurling sleet, lightning, and gale-force winds.' },
                    { name: 'Long Falls', description: 'A misstep offers nothing but empty sky and the promise of a terminal landing.' }
                ],
                environmentalEffects: [
                    { name: 'Strong Winds', description: 'Knife-edged gusts buffet travelers, threatening to pluck them from the path.' },
                    { name: 'Cold Temperature', description: 'Thin air and perpetual frost sap warmth from fingers and gear alike.' },
                    { name: 'Echo and Noise', description: 'Booming echoes rebound through valleys, startling wildlife and loosening stones.' }
                ]
            },
            swamp: {
                skillChecks: [
                    { skill: 'Survival', purpose: 'picking safe routes along half-sunken causeways and root bridges' },
                    { skill: 'Nature', purpose: 'distinguishing healing herbs from venom-dripping flora' },
                    { skill: 'Perception', purpose: 'listening past croaking choruses for lurking predators and bubbles' },
                    { skill: 'Athletics', purpose: 'muscling through sucking bogs and dragging companions to firmer ground' },
                    { skill: 'Constitution Save', purpose: 'enduring miasma-laden air and biting disease clouds' }
                ],
                traps: [
                    { name: 'Bog Pit', description: 'A seemingly solid patch liquefies, sucking travelers into a tar-dark mire.' },
                    { name: 'Submerged Spikes', description: 'Rotten logs conceal jagged stakes that spear boots and skiffs alike.' },
                    { name: 'Poisonous Gas Pocket', description: 'A swirl of pale vapor erupts from the muck, choking lungs with toxic fumes.' }
                ],
                hazards: [
                    { name: 'Deep Mud', description: 'Every step becomes a struggle as mud clings like a living thing.' },
                    { name: 'Disease-Carrying Insects', description: 'Mosquito clouds descend in waves, delivering fevered dreams with every bite.' },
                    { name: 'Toxic Waters', description: 'Oily sheens and skeletal fish warn that the water itself carries poison.' },
                    { name: 'Quickmud', description: 'Seemingly shallow pools turn to grasping slurry that swallows prey whole.' }
                ],
                environmentalEffects: [
                    { name: 'Poor Visibility', description: 'Ghostly fog curls between gnarled trees, muting lantern light to a mere glow.' },
                    { name: 'Constant Wetness', description: 'Moisture seeps into every seam, rotting leather and swelling wood.' },
                    { name: 'Disorientation', description: 'The swamp’s mirrored pools and moss-draped trees erase sense of direction.' }
                ]
            },
            underground: {
                skillChecks: [
                    { skill: 'Investigation', purpose: 'reading striations and echoes to unmask secret tunnels and vaults' },
                    { skill: 'Survival', purpose: 'mapping labyrinthine passages by memory and stone cairns alone' },
                    { skill: 'Perception', purpose: 'listening for dripping water, skittering feet, or the groan of stressed stone' },
                    { skill: 'Athletics', purpose: 'scrambling over jagged scree and worming through narrow chimneys' },
                    { skill: 'Nature', purpose: 'deciphering subterranean ecosystems and predicting tremors' }
                ],
                traps: [
                    { name: 'Cave-In Trigger', description: 'Loose supports and fault lines await a careless touch to bury intruders in tons of rock.' },
                    { name: 'Poisonous Gas Vent', description: 'A fissure exhales sulfurous fumes, lulling trespassers into choking unconsciousness.' },
                    { name: 'Underground River', description: 'A sudden torrent erupts from a hidden channel, dragging explorers into lightless depths.' }
                ],
                hazards: [
                    { name: 'Total Darkness', description: 'Absolute blackness swallows vision, leaving only touch and sound to navigate.' },
                    { name: 'Unstable Passages', description: 'Ceilings groan and drip, ready to surrender boulders without warning.' },
                    { name: 'Underground Rivers', description: 'Raging currents thunder through narrow tunnels, smashing trespassers against jagged stone.' },
                    { name: 'Toxic Air', description: 'Stagnant pockets of foul air sap strength and smother flames.' }
                ],
                environmentalEffects: [
                    { name: 'Claustrophobia', description: 'Pressing walls and low ceilings gnaw at nerves, sparking panic in the unsteady.' },
                    { name: 'Echo and Reverb', description: 'Voices rebound in eerie chorus, disguising distance and direction.' },
                    { name: 'Temperature Variation', description: 'Chill, damp air clings to skin, numbing fingers and making gear slick.' }
                ]
            }
        };

        function getRandomElements(array, count) {
            // Fisher-Yates shuffle for proper randomization
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled.slice(0, count);
        }

        function calculateDC(partyLevel) {
            if (partyLevel <= 4) return 10 + Math.floor(Math.random() * 3);
            if (partyLevel <= 10) return 12 + Math.floor(Math.random() * 4);
            if (partyLevel <= 16) return 15 + Math.floor(Math.random() * 5);
            return 18 + Math.floor(Math.random() * 5);
        }

        function getScalingNotes(partyLevel) {
            const notes = [];
            
            if (partyLevel <= 4) {
                notes.push('Low-level party: Reduce trap damage by 50%, lower DCs by 2-3.');
                notes.push('Focus on exploration and puzzle-solving over combat danger.');
                notes.push('Provide more obvious clues and warning signs for hazards.');
            } else if (partyLevel <= 10) {
                notes.push('Mid-level party: Standard encounter difficulty as presented.');
                notes.push('Party has access to more resources and magical solutions.');
                notes.push('Can handle multiple simultaneous challenges.');
            } else if (partyLevel <= 16) {
                notes.push('High-level party: Increase trap damage by 50%, raise DCs by 2-3.');
                notes.push('Add magical components to hazards and environmental effects.');
                notes.push('Consider multiple layers of challenges requiring diverse skills.');
            } else {
                notes.push('Epic-level party: Double trap damage, raise DCs by 4-5.');
                notes.push('Incorporate legendary environmental effects and cosmic threats.');
                notes.push('Challenges should require creative use of high-level abilities.');
                notes.push('Standard hazards may be trivial - add supernatural elements.');
            }

            return notes;
        }

        const fallbackEncounterTitles = {
            urban: ['The Shadowed Alley', 'Rooftop Chase', 'The Abandoned Warehouse', 'Market District Mystery', 'Sewer Expedition'],
            arctic: ['Frozen Wasteland Trek', 'The Avalanche Path', 'Ice Cave Exploration', 'Blizzard Survival', 'Glacier Crossing'],
            ocean: ['Storm-Tossed Voyage', 'The Coral Labyrinth', 'Derelict Ship Discovery', 'Island Approach', 'Deep Water Descent'],
            space: ['Derelict Station', 'Asteroid Field Navigation', 'Void Walk', 'Alien Ruins', 'Cosmic Anomaly'],
            crypt: ['The Ancient Tomb', 'Forgotten Catacombs', 'Cursed Burial Chamber', 'The Silent Mausoleum', 'Necropolis Depths'],
            forest: ['Dense Woodland Trail', 'The Overgrown Ruins', 'Ancient Grove', 'Forest of Whispers', 'The Hidden Glade'],
            desert: ['Scorching Dunes', 'Oasis Mirage', 'The Buried Temple', 'Canyon of Winds', 'Desert Caravan Route'],
            mountain: ['Treacherous Peak', 'The Mountain Pass', 'Cliffside Trail', 'Summit Ascent', 'The Hidden Valley'],
            swamp: ['The Mire', 'Forgotten Wetlands', 'Bog of Despair', 'Murky Waters', 'The Dead Marsh'],
            underground: ['Cavern Depths', 'The Sunless Expanse', 'Crystal Caves', 'Underground River', 'The Forgotten Mine']
        };

        function selectEncounterTemplate(environment) {
            const entries = encounterTitles && encounterTitles[environment];
            console.log('Selecting encounter for environment:', environment);
            console.log('Available entries:', entries ? entries.length : 'none');
            
            if (entries && entries.length > 0) {
                const totalWeight = entries.reduce((sum, entry) => sum + (entry.weight ?? 1), 0);
                let roll = Math.random() * totalWeight;
                for (const entry of entries) {
                    roll -= (entry.weight ?? 1);
                    if (roll <= 0) {
                        console.log('Selected encounter:', entry.title, 'Has description:', !!entry.description);
                        return entry;
                    }
                }
                const selected = entries[entries.length - 1];
                console.log('Selected last encounter:', selected.title, 'Has description:', !!selected.description);
                return selected;
            }

            console.log('Using fallback encounter title');
            const fallback = fallbackEncounterTitles[environment] || fallbackEncounterTitles.urban;
            const title = fallback[Math.floor(Math.random() * fallback.length)];
            return { title, description: null };
        }

        function getProfessionRoleTip(profession) {
            const tips = {
                'Blacksmith': 'provide information about weapons, armor, or recent travelers',
                'Merchant': 'offer trade opportunities or gossip about local events',
                'Innkeeper': 'share rumors, provide lodging, or know about local happenings',
                'Guard': 'enforce laws, provide directions, or warn about dangers',
                'Farmer': 'know the local wilderness, weather patterns, or recent disturbances',
                'Alchemist': 'sell potions, identify substances, or explain magical phenomena',
                'Cleric': 'offer healing, spiritual guidance, or knowledge of undead',
                'Wizard': 'provide arcane knowledge, decipher runes, or identify magical items',
                'Thief': 'know secret passages, sell illegal goods, or provide underworld contacts',
                'Bard': 'share stories, perform for information, or know local legends',
                'Sailor': 'provide nautical knowledge, tell tales of distant lands, or know the docks',
                'Hunter': 'track creatures, provide survival tips, or know the wilderness',
                'Scholar': 'offer historical knowledge, translate languages, or research topics',
                'Noble': 'provide political connections, offer quests, or grant favors',
                'Beggar': 'share street information, spy for coin, or know hidden places',
                'Artisan': 'craft items, repair equipment, or appreciate quality work',
                'Soldier': 'provide tactical advice, share war stories, or enforce military law',
                'Herbalist': 'identify plants, brew remedies, or warn of poisonous flora',
                'Gambler': 'provide risky opportunities, share tips for coin, or know shady contacts',
                'Priest': 'perform ceremonies, offer blessings, or provide sanctuary',
                'Assassin': 'offer deadly services, know targets, or eliminate problems',
                'Spy': 'sell information, provide contacts, or reveal secrets for a price',
                'Gladiator': 'offer combat training, share arena knowledge, or intimidate foes',
                'Cartographer': 'provide maps, explain geography, or plan expeditions',
                'Fortune Teller': 'offer cryptic predictions, read omens, or hint at futures'
            };
            return tips[profession] || 'provide information relevant to their profession';
        }

        function buildEncounterDescription(environment, title, customDescription) {
            // If a custom description is provided (from encounters.json), use it
            if (customDescription) {
                return customDescription;
            }

            // Fallback descriptions for encounters without JSON descriptions
            const descriptions = {
                urban: `The party must navigate ${title.toLowerCase()}, where every alley hums with intrigue and the city itself plays kingmaker. Lantern light paints long shadows over ancient masonry, and the press of humanity can offer salvation or doom depending on which whispers they heed.`,
                arctic: `${title} hurls the party into a realm of grinding ice and razor winds. Only careful preparation, shared body heat, and unshakable resolve stand between the heroes and the endless white hunger of the north.`,
                ocean: `The party faces ${title.toLowerCase()}, with the sea rising like a living titan around them. Tempest winds, creaking timbers, and fathomless depths remind them that mortals are but guests upon the waves.`,
                space: `In ${title.toLowerCase()}, the party drifts between stars where silence is lethal and every glimmer could be salvation or an alien trap. The void judges all missteps harshly, yet rewards courage with wonders beyond imagination.`,
                crypt: `${title} beckons with the promise of forgotten relics and the wrath of those sworn to guard them. Dust-laden sarcophagi, echoing prayers, and lingering curses turn each footfall into a negotiation with the dead.`,
                forest: `The party must traverse ${title.toLowerCase()}, an emerald cathedral where roots clutch secrets and spirits watch from the boughs. Beauty and peril twine together as the living wood decides whether these travelers are welcome.`,
                desert: `${title} stretches in shimmering waves, testing endurance, faith, and resourcefulness. The desert buries the incautious beneath sand and legend alike, yet those who read its omens may claim treasures long hidden.`,
                mountain: `The party attempts ${title.toLowerCase()}, climbing into a realm of thin air, thunderous avalanches, and unyielding stone. Each switchback is a wager with gravity, and the summit offers glory only to those who endure.`,
                swamp: `${title} engulfs the party in fetid mists and half-sunken ruins. Murky waters conceal both relics and ravenous jaws, demanding keen senses and iron stomachs from any who dare wade within.`,
                underground: `The party descends into ${title.toLowerCase()}, surrendering sunlight for echoing caverns and subterranean mysteries. Down here, the stone remembers ancient wars, and every tunnel could unveil wonder or waking terror.`
            };

            return descriptions[environment] || descriptions.urban;
        }

        // Smart selection function for skill checks based on tag matching
        function selectSkillChecks(encounterTags, locationTags, npcTags, numChecks = null) {
            if (!skillChecksData || !skillChecksData.skillChecks || skillChecksData.skillChecks.length === 0) {
                console.warn('No skill checks data available');
                return [];
            }

            // Determine number of skill checks (3-4)
            if (numChecks === null) {
                numChecks = Math.random() < 0.6 ? 3 : 4;
            }

            // Combine all tags for matching
            const allTags = [...encounterTags, ...locationTags, ...npcTags];

            // Score each skill check based on tag matching
            const scoredChecks = skillChecksData.skillChecks.map(check => {
                let score = 0;
                
                // Count matching tags
                for (const tag of check.tags) {
                    if (allTags.includes(tag)) {
                        score += 1;
                    }
                }

                // Bonus for matching specific encounter tags (more relevant)
                for (const tag of check.tags) {
                    if (encounterTags.includes(tag)) {
                        score += 0.5;
                    }
                }

                // Add small random variance for variety
                score += Math.random() * 0.3;

                return { check, score };
            });

            // Sort by score and select top candidates
            scoredChecks.sort((a, b) => b.score - a.score);

            // Take from top-scoring checks with some randomization
            const topCandidates = scoredChecks.slice(0, Math.min(15, scoredChecks.length));
            const selected = [];
            const usedSkills = new Set();

            // Prefer diverse skills
            for (let i = 0; i < numChecks && topCandidates.length > 0; i++) {
                // Try to find check with unused skill
                let selectedCheck = null;
                for (let j = 0; j < topCandidates.length; j++) {
                    if (!usedSkills.has(topCandidates[j].check.skill)) {
                        selectedCheck = topCandidates.splice(j, 1)[0];
                        break;
                    }
                }
                
                // If all skills used, just take highest scored
                if (!selectedCheck && topCandidates.length > 0) {
                    selectedCheck = topCandidates.shift();
                }

                if (selectedCheck) {
                    selected.push(selectedCheck.check);
                    usedSkills.add(selectedCheck.check.skill);
                }
            }

            // If we didn't get enough, fill with random
            while (selected.length < numChecks && skillChecksData.skillChecks.length > selected.length) {
                const randomCheck = skillChecksData.skillChecks[Math.floor(Math.random() * skillChecksData.skillChecks.length)];
                if (!selected.includes(randomCheck)) {
                    selected.push(randomCheck);
                }
            }

            return selected;
        }

        // Smart selection function for traps based on location tags
        function selectTraps(locationTags, numTraps = null) {
            if (!dangersData || !dangersData.traps || dangersData.traps.length === 0) {
                return [];
            }

            // Determine number of traps (0-2, weighted toward 1)
            if (numTraps === null) {
                const roll = Math.random();
                if (roll < 0.3) numTraps = 0;      // 30% chance of no traps
                else if (roll < 0.8) numTraps = 1; // 50% chance of 1 trap
                else numTraps = 2;                 // 20% chance of 2 traps
            }

            if (numTraps === 0) return [];

            // Score traps based on tag matching
            const scoredTraps = dangersData.traps.map(trap => {
                let score = 0;
                
                for (const tag of trap.tags) {
                    if (locationTags.includes(tag)) {
                        score += 1;
                    }
                }

                score += Math.random() * 0.5;
                return { trap, score };
            });

            scoredTraps.sort((a, b) => b.score - a.score);

            // Select top scoring traps
            const selected = [];
            const topCandidates = scoredTraps.slice(0, Math.min(10, scoredTraps.length));

            for (let i = 0; i < numTraps && topCandidates.length > 0; i++) {
                const index = Math.floor(Math.random() * Math.min(5, topCandidates.length));
                selected.push(topCandidates.splice(index, 1)[0].trap);
            }

            return selected;
        }

        // Smart selection function for hazards based on environment
        function selectHazards(environmentTag, locationTags, numHazards = null) {
            if (!dangersData || !dangersData.hazards || dangersData.hazards.length === 0) {
                return [];
            }

            // Determine number of hazards (1-2)
            if (numHazards === null) {
                numHazards = Math.random() < 0.6 ? 1 : 2;
            }

            const allTags = [environmentTag, ...locationTags];

            // Score hazards
            const scoredHazards = dangersData.hazards.map(hazard => {
                let score = 0;
                
                for (const tag of hazard.tags) {
                    if (allTags.includes(tag)) {
                        score += 1;
                    }
                }

                // Extra weight for environment match
                if (hazard.tags.includes(environmentTag)) {
                    score += 1;
                }

                score += Math.random() * 0.5;
                return { hazard, score };
            });

            scoredHazards.sort((a, b) => b.score - a.score);

            const selected = [];
            const topCandidates = scoredHazards.slice(0, Math.min(10, scoredHazards.length));

            for (let i = 0; i < numHazards && topCandidates.length > 0; i++) {
                const index = Math.floor(Math.random() * Math.min(5, topCandidates.length));
                selected.push(topCandidates.splice(index, 1)[0].hazard);
            }

            return selected;
        }

        // Smart selection function for environmental effects
        function selectEnvironmentalEffects(environmentTag, encounterTags, numEffects = null) {
            if (!dangersData || !dangersData.environmentalEffects || dangersData.environmentalEffects.length === 0) {
                return [];
            }

            // Determine number of effects (0-1, 40% chance of 1)
            if (numEffects === null) {
                numEffects = Math.random() < 0.4 ? 1 : 0;
            }

            if (numEffects === 0) return [];

            const allTags = [environmentTag, ...encounterTags];

            // Score effects
            const scoredEffects = dangersData.environmentalEffects.map(effect => {
                let score = 0;
                
                for (const tag of effect.tags) {
                    if (allTags.includes(tag)) {
                        score += 1;
                    }
                }

                // Extra weight for environment match
                if (effect.tags.includes(environmentTag)) {
                    score += 1;
                }

                score += Math.random() * 0.5;
                return { effect, score };
            });

            scoredEffects.sort((a, b) => b.score - a.score);

            const selected = [];
            const topCandidates = scoredEffects.slice(0, Math.min(10, scoredEffects.length));

            for (let i = 0; i < numEffects && topCandidates.length > 0; i++) {
                const index = Math.floor(Math.random() * Math.min(3, topCandidates.length));
                selected.push(topCandidates.splice(index, 1)[0].effect);
            }

            return selected;
        }

        function generateEncounter() {
            const partyLevel = parseInt(document.getElementById('partyLevel').value);
            
            if (isNaN(partyLevel) || partyLevel < 1 || partyLevel > 20) {
                alert('Please enter a valid party level between 1 and 20.');
                return;
            }

            // Check if data is loaded
            if (!dataLoaded) {
                alert('Data is still loading. Please wait a moment and try again.');
                return;
            }

            const template = selectEncounterTemplate(selectedEnvironment);
            console.log('Selected template:', template);
            console.log('Template description:', template.description);
            
            const title = template.title;
            const description = buildEncounterDescription(selectedEnvironment, title, template.description);
            console.log('Final description:', description.substring(0, 100) + '...');

            // Generate NPCs and Locations based on encounter tags FIRST
            const encounterNPCs = selectNPCsForEncounter(template.tags);
            const encounterLocations = selectLocationsForEncounter(template.tags, selectedEnvironment);
            
            // Collect all tags for smart content selection
            const encounterTags = template.tags || [];
            const locationTags = encounterLocations.flatMap(loc => loc.data.tags || []);
            const npcTags = encounterNPCs.flatMap(npc => [
                ...(npc.profession?.tags || []),
                ...(npc.personality?.tags || []),
                ...(npc.secret?.tags || [])
            ]);

            // Smart selection based on combined context
            const selectedSkills = selectSkillChecks(encounterTags, locationTags, npcTags);
            const selectedTraps = selectTraps(locationTags);
            const selectedHazards = selectHazards(selectedEnvironment, locationTags);
            const selectedEffects = selectEnvironmentalEffects(selectedEnvironment, encounterTags);
            const scalingNotes = getScalingNotes(partyLevel);
            
            // Generate encounter flow
            const encounterFlow = generateEncounterFlow(encounterLocations, encounterNPCs, title);

            console.log('📊 Content Selection Summary:');
            console.log('  Skill Checks:', selectedSkills.length);
            console.log('  Traps:', selectedTraps.length);
            console.log('  Hazards:', selectedHazards.length);
            console.log('  Effects:', selectedEffects.length);

            // Build HTML
            let html = `
                <div class="encounter-section">
                    <h2 onclick="toggleSection(event)">📜 ${title} <span class="section-toggle">▼</span></h2>
                    <div class="section-content">
                        <p class="description">${description}</p>
                        <p class="description"><strong>Environment:</strong> ${selectedEnvironment.charAt(0).toUpperCase() + selectedEnvironment.slice(1)} | <strong>Recommended Party Level:</strong> ${partyLevel}</p>
                    </div>
                </div>
            `;

            // Store location and NPC data globally for the detail panels
            // Also store skill checks, traps, and hazards per location
            window.encounterLocationsData = encounterLocations;
            window.encounterNPCsData = encounterNPCs;
            window.encounterSkillChecks = selectedSkills;
            window.encounterTraps = selectedTraps;
            window.encounterHazards = selectedHazards;
            window.encounterEffects = selectedEffects;
            window.encounterPartyLevel = partyLevel;

            // Encounter Flow
            if (encounterFlow && encounterFlow.length > 0) {
                
                // Populate the flow navigator
                populateFlowNavigator(encounterFlow);
                
                html += `
                    <div class="encounter-section">
                        <h2 onclick="toggleSection(event)">🔄 Encounter Flow & Narrative Path <span class="section-toggle">▼</span></h2>
                        <div class="section-content">
                            <p class="description">This suggested flow helps guide the party through the encounter. <strong>Click any location name</strong> to view its details in the side panel.</p>
                            <div style="position: relative; margin-top: 25px;">
                `;

                encounterFlow.forEach((step, index) => {
                    const isLastStep = index === encounterFlow.length - 1;
                    const isBranching = step.title === "Branching Paths & Optional Areas";
                    
                    if (isBranching) {
                        // Special display for branching paths
                        html += `
                            <div id="flow-step-${step.step}" class="flow-step" style="background: linear-gradient(135deg, rgba(155, 89, 182, 0.15), rgba(142, 68, 173, 0.1)); border-left: 4px solid #9b59b6; padding: 20px; margin: 20px 0; border-radius: 8px; position: relative;">
                                <div style="display: flex; align-items: center; margin-bottom: 15px;">
                                    <div style="background: #9b59b6; color: white; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; margin-right: 15px; flex-shrink: 0;">
                                        ${step.step}
                                    </div>
                                    <h3 style="margin: 0; color: #9b59b6;">🔀 ${step.title}</h3>
                                </div>
                                
                                <p class="description" style="margin: 15px 0; font-style: italic;">${step.description}</p>
                                
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin: 15px 0;">
                                    ${step.branches.map(branch => `
                                        <div style="background: rgba(155, 89, 182, 0.1); border: 1px dashed #9b59b6; border-radius: 6px; padding: 12px;">
                                            <strong><span class="location-link" onclick="showLocationDetail('${branch.location.key}')">→ ${branch.location.name}</span></strong>
                                            <p style="margin: 8px 0 0 0; font-size: 0.9em; color: var(--text-secondary);">${branch.reason}</p>
                                        </div>
                                    `).join('')}
                                </div>
                                
                                <div style="background: rgba(155, 89, 182, 0.08); border-radius: 6px; padding: 12px; margin-top: 15px;">
                                    <strong style="color: var(--accent-blue);">💡 DM Tips:</strong>
                                    <ul style="margin: 8px 0 0 0; padding-left: 20px; font-size: 0.95em;">
                                        ${step.dmTips.map(tip => `<li>${tip}</li>`).join('')}
                                    </ul>
                                </div>
                            </div>
                        `;
                    } else if (step.title === "Resolution") {
                        // Special display for resolution
                        html += `
                            <div id="flow-step-${step.step}" class="flow-step" style="background: linear-gradient(135deg, rgba(39, 174, 96, 0.15), rgba(46, 204, 113, 0.1)); border-left: 4px solid #27ae60; padding: 20px; margin: 20px 0; border-radius: 8px; position: relative;">
                                <div style="display: flex; align-items: center; margin-bottom: 15px;">
                                    <div style="background: #27ae60; color: white; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; margin-right: 15px; flex-shrink: 0;">
                                        ✓
                                    </div>
                                    <h3 style="margin: 0; color: #27ae60;">🎯 ${step.title}</h3>
                                </div>
                                
                                <p class="description" style="margin: 15px 0; font-style: italic;">${step.description}</p>
                                
                                <div style="background: rgba(39, 174, 96, 0.08); border-radius: 6px; padding: 12px; margin-top: 15px;">
                                    <strong style="color: var(--accent-blue);">💡 DM Tips:</strong>
                                    <ul style="margin: 8px 0 0 0; padding-left: 20px; font-size: 0.95em;">
                                        ${step.dmTips.map(tip => `<li>${tip}</li>`).join('')}
                                    </ul>
                                </div>
                            </div>
                        `;
                    } else {
                        // Normal flow step
                        html += `
                            <div id="flow-step-${step.step}" class="flow-step" style="background: rgba(52, 152, 219, 0.1); border-left: 4px solid var(--accent-blue); padding: 20px; margin: 20px 0; border-radius: 8px; position: relative;">
                                <div style="display: flex; align-items: center; margin-bottom: 15px;">
                                    <div style="background: var(--accent-blue); color: white; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; margin-right: 15px; flex-shrink: 0;">
                                        ${step.step}
                                    </div>
                                    <h3 style="margin: 0; color: var(--accent-blue);">${step.title}</h3>
                                </div>
                                
                                <div style="background: rgba(52, 152, 219, 0.15); border-radius: 6px; padding: 12px; margin-bottom: 15px;">
                                    <strong style="color: var(--accent-blue);">📍 Location: <span class="location-link" onclick="showLocationDetail('${step.location.key}')">${step.location.name}</span></strong>
                                </div>
                                
                                <p class="description" style="margin: 15px 0; font-style: italic;">${step.description}</p>
                                
                                ${step.connections ? `
                                    <div style="margin: 15px 0;">
                                        <strong style="color: var(--accent-blue);">🔗 How the party arrives here:</strong>
                                        <ul style="margin: 8px 0 0 0; padding-left: 20px; font-size: 0.95em;">
                                            ${step.connections.map(conn => `<li>${conn}</li>`).join('')}
                                        </ul>
                                    </div>
                                ` : ''}
                                
                                <div style="background: rgba(52, 152, 219, 0.08); border-radius: 6px; padding: 12px; margin-top: 15px;">
                                    <strong style="color: var(--accent-blue);">💡 DM Tips:</strong>
                                    <ul style="margin: 8px 0 0 0; padding-left: 20px; font-size: 0.95em;">
                                        ${step.dmTips.map(tip => `<li>${tip}</li>`).join('')}
                                    </ul>
                                </div>
                            </div>
                        `;
                    }
                    
                    // Add connector arrow between steps (except after last step)
                    if (!isLastStep) {
                        html += `
                            <div style="text-align: center; margin: 10px 0; color: var(--accent-blue); font-size: 24px;">
                                ↓
                            </div>
                        `;
                    }
                });

                html += `
                        </div>
                    </div></div>
                `;
            }

            // NPCs
            if (encounterNPCs.length > 0) {
                html += `
                    <div class="encounter-section">
                        <h2 onclick="toggleSection(event)">👥 NPCs in this Encounter <span class="section-toggle">▼</span></h2>
                        <div class="section-content">
                            <p class="description">These NPCs are present in this location and may interact with the party. They can provide information, assistance, or complications depending on how the party approaches them.</p>
                `;

                encounterNPCs.forEach((npc, index) => {
                    html += `
                        <div class="npc-card" style="background: rgba(58, 58, 60, 0.3); border-radius: 8px; padding: 20px; margin: 15px 0;">
                            <h3 style="margin-top: 0; color: var(--accent-blue);">${npc.name}</h3>
                            <p style="font-size: 1.1em; color: var(--text-secondary); margin: 5px 0;">
                                ${npc.species.charAt(0).toUpperCase() + npc.species.slice(1)} ${npc.profession.name}
                            </p>
                            
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin: 15px 0;">
                                <div>
                                    <strong style="color: var(--accent-blue);">Alignment:</strong>
                                    <p class="description" style="margin: 5px 0;">${npc.alignment.name}</p>
                                </div>
                                <div>
                                    <strong style="color: var(--accent-blue);">Personality:</strong>
                                    <p class="description" style="margin: 5px 0;">${npc.personality.trait}</p>
                                </div>
                            </div>
                            
                            <div style="margin: 10px 0;">
                                <strong style="color: var(--accent-blue);">Appearance:</strong>
                                <p class="description" style="margin: 5px 0;">${npc.appearance.description}</p>
                            </div>
                            
                            <div style="background: rgba(255, 149, 0, 0.1); border-left: 3px solid #ff9500; padding: 10px; margin: 10px 0; border-radius: 4px;">
                                <strong style="color: #ff9500;">🔒 Secret (DM Only):</strong>
                                <p class="description" style="margin: 5px 0;">${npc.secret.secret}</p>
                            </div>
                            
                            <div style="margin-top: 10px;">
                                <strong style="color: var(--accent-blue);">Roleplaying Tips:</strong>
                                <ul style="margin: 5px 0; padding-left: 20px;">
                                    <li>As a ${npc.profession.name.toLowerCase()}, they may ${getProfessionRoleTip(npc.profession.name)}</li>
                                    <li>Their ${npc.personality.trait.toLowerCase()} personality will affect how they respond to the party</li>
                                    <li>They could provide information about ${template.tags[0] || 'the area'} if properly approached</li>
                                </ul>
                            </div>
                        </div>
                    `;
                });

                html += `</div></div>`;
            }

            // Scaling Notes
            html += `
                <div class="encounter-section">
                    <h2 onclick="toggleSection(event)">⚖️ Level Scaling Guide <span class="section-toggle">▼</span></h2>
                    <div class="section-content">
                        <p class="description">Adjust the encounter difficulty based on your party's level:</p>
            `;

            scalingNotes.forEach(note => {
                html += `
                    <div class="scaling-note">
                        <span class="level-badge">Level ${partyLevel}</span>
                        ${note}
                    </div>
                `;
            });

            html += `
                    <div class="scaling-note">
                        <strong>General Scaling Tips:</strong>
                        <ul>
                            <li>For parties below the recommended level, reduce DCs by 2-3 and halve damage values</li>
                            <li>For parties above the recommended level, increase DCs by 2-3 and add additional complications</li>
                            <li>Consider party composition - groups lacking certain skills may need alternative solutions</li>
                            <li>Time pressure can increase difficulty without changing numbers</li>
                        </ul>
                    </div>
                </div></div>
            `;

            // Rewards and Conclusion
            html += `
                <div class="encounter-section">
                    <h2 onclick="toggleSection(event)">🏆 Resolution & Rewards <span class="section-toggle">▼</span></h2>
                    <div class="section-content">
                        <p class="description"><strong>Success Criteria:</strong> The party successfully navigates the primary hazards and completes the exploration objective.</p>
                        <p class="description"><strong>Rewards:</strong></p>
                        <ul>
                            <li>Experience points appropriate for a medium difficulty exploration encounter</li>
                            <li>Knowledge of the area that may prove useful later</li>
                            <li>Possible discovery of treasure, secrets, or story clues</li>
                            <li>Reputation or favor with relevant factions</li>
                        </ul>
                        <p class="description"><strong>DM Tips:</strong> Exploration encounters work best when players feel clever for overcoming challenges. Reward creative solutions and allow multiple approaches to obstacles. The journey itself should be memorable, not just the destination.</p>
                    </div>
                </div>
                
                <div style="text-align: center; margin-top: 30px; padding: 20px;">
                    <button onclick="exploreEncounterLocation()" class="btn-success btn-large">
                        🗺️ Explore Location
                    </button>
                    <p style="margin-top: 10px; color: var(--text-secondary); font-size: 14px;">Dive deeper into a contextual location within this environment</p>
                </div>
            `;

            document.getElementById('encounterContent').innerHTML = html;
            document.getElementById('encounterDisplay').classList.add('active');
            
            // Smooth scroll to encounter
            document.getElementById('encounterDisplay').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // Room exploration variables
        let currentRoomEnvironment = '';
        let currentRoomType = '';
        let currentRoomData = null;
        let exploredObjects = new Set();

        // Explore location from encounter
        function exploreEncounterLocation() {
            // Use current encounter environment or default to urban
            const environment = selectedEnvironment || 'urban';
            
            // Find matching location based on encounter tags if available
            const matchingLocations = [];
            
            for (const [locationType, locationData] of Object.entries(locationObjects[environment])) {
                matchingLocations.push({ type: locationType, data: locationData });
            }
            
            // Select random matching location
            const selectedLocation = matchingLocations[Math.floor(Math.random() * matchingLocations.length)];
            
            // Generate and display room
            generateRoom(environment, selectedLocation.type, selectedLocation.data);
        }

        // Generate room
        function generateRoom(environment, locationType, locationData) {
            currentRoomEnvironment = environment;
            currentRoomType = locationType;
            currentRoomData = locationData;
            exploredObjects = new Set();
            
            displayRoomView();
        }

        // Display room view
        function displayRoomView() {
            const envIcons = {
                urban: '🏛️', arctic: '❄️', ocean: '🌊', space: '🌌',
                crypt: '💀', forest: '🌲', desert: '🏜️', mountain: '⛰️',
                swamp: '🐊', underground: '🕳️'
            };
            
            const icon = envIcons[currentRoomEnvironment] || '🗺️';
            const locationName = currentRoomType.charAt(0).toUpperCase() + currentRoomType.slice(1);
            const environmentName = currentRoomEnvironment.charAt(0).toUpperCase() + currentRoomEnvironment.slice(1);
            
            let html = `
                <div class="encounter-section">
                    <h1 style="text-align: center; color: #27ae60; margin-bottom: 30px;">
                        ${icon} Exploring ${locationName} - ${environmentName}
                    </h1>
                    <p class="description" style="text-align: center; font-size: 18px; margin-bottom: 30px;">
                        You carefully examine this location, looking for anything of interest or value.
                    </p>
                </div>

                <div class="encounter-section">
                    <h2>🔍 Primary Objects of Interest</h2>
                    <p class="description">These are the prominent features and objects that immediately catch your attention:</p>
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px; margin-top: 20px;">
            `;
            
            // Display primary objects
            currentRoomData.primary.forEach((obj, index) => {
                const isExplored = exploredObjects.has(`primary-${index}`);
                const buttonClass = isExplored 
                    ? 'disabled' 
                    : 'btn-primary';
                const buttonText = isExplored ? '✓ Explored' : '🔍 Examine';
                
                html += `
                    <div style="border: 2px solid var(--accent-blue); border-radius: 8px; padding: 15px; background: rgba(52, 152, 219, 0.1);">
                        <div style="font-weight: bold; margin-bottom: 10px; color: var(--text-primary);">${obj}</div>
                        <button onclick="exploreObject('primary', ${index})" 
                                class="${buttonClass} btn-small"
                                style="width: 100%;"
                                ${isExplored ? 'disabled' : ''}>
                            ${buttonText}
                        </button>
                    </div>
                `;
            });
            
            html += `
                    </div>
                </div>
            `;
            
            // Show explored secondary objects section if any exist
            if (exploredObjects.size > 0) {
                const secondaryObjects = Array.from(exploredObjects)
                    .filter(id => id.startsWith('primary-'))
                    .map(id => {
                        const index = parseInt(id.split('-')[1]);
                        return currentRoomData.secondary[index];
                    });
                
                if (secondaryObjects.length > 0) {
                    html += `
                        <div class="encounter-section">
                            <h2>🔎 Secondary Details Discovered</h2>
                            <p class="description">Upon closer inspection, you've discovered these additional details:</p>
                            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px; margin-top: 20px;">
                    `;
                    
                    Array.from(exploredObjects)
                        .filter(id => id.startsWith('primary-'))
                        .forEach(id => {
                            const index = parseInt(id.split('-')[1]);
                            const secondaryObj = currentRoomData.secondary[index];
                            const isSecondaryExplored = exploredObjects.has(`secondary-${index}`);
                            const buttonClass = isSecondaryExplored 
                                ? 'disabled' 
                                : 'btn-secondary';
                            const buttonText = isSecondaryExplored ? '✓ Explored' : '🔍 Examine Closely';
                            
                            html += `
                                <div style="border: 2px solid #9b59b6; border-radius: 8px; padding: 15px; background: rgba(155, 89, 182, 0.1);">
                                    <div style="font-weight: bold; margin-bottom: 10px; color: var(--text-primary);">${secondaryObj}</div>
                                    <button onclick="exploreObject('secondary', ${index})" 
                                            class="${buttonClass} btn-small"
                                            style="width: 100%;"
                                            ${isSecondaryExplored ? 'disabled' : ''}>
                                        ${buttonText}
                                    </button>
                                </div>
                            `;
                        });
                    
                    html += `
                            </div>
                        </div>
                    `;
                }
                
                // Show discovered tertiary objects
                const tertiaryObjects = Array.from(exploredObjects)
                    .filter(id => id.startsWith('secondary-'))
                    .map(id => {
                        const index = parseInt(id.split('-')[1]);
                        return currentRoomData.tertiary[index];
                    });
                
                if (tertiaryObjects.length > 0) {
                    html += `
                        <div class="encounter-section">
                            <h2>✨ Hidden Discoveries</h2>
                            <p class="description">Through careful investigation, you've uncovered these hidden elements:</p>
                            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; margin-top: 20px;">
                    `;
                    
                    tertiaryObjects.forEach(obj => {
                        html += `
                            <div style="border: 2px solid #f39c12; border-radius: 8px; padding: 15px; background: linear-gradient(135deg, rgba(243, 156, 18, 0.2), rgba(230, 126, 34, 0.1)); box-shadow: 0 0 15px rgba(243, 156, 18, 0.3);">
                                <div style="font-weight: bold; font-size: 16px; color: #d68910; margin-bottom: 10px;">🏆 ${obj}</div>
                                <div style="font-size: 13px; color: #7f8c8d; font-style: italic;">Significant discovery! This could be valuable, dangerous, or story-relevant.</div>
                            </div>
                        `;
                    });
                    
                    html += `
                            </div>
                        </div>
                    `;
                }
            }
            
            document.getElementById('roomContent').innerHTML = html;
            document.getElementById('encounterDisplay').classList.remove('active');
            document.getElementById('roomDisplay').style.display = 'block';
            document.getElementById('roomDisplay').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // Explore object
        function exploreObject(level, index) {
            const objectId = `${level}-${index}`;
            
            if (exploredObjects.has(objectId)) {
                return; // Already explored
            }
            
            exploredObjects.add(objectId);
            displayRoomView(); // Refresh the view to show new discoveries
        }

        // Return to encounter
        function returnToEncounter() {
            document.getElementById('roomDisplay').style.display = 'none';
            document.getElementById('encounterDisplay').classList.add('active');
            document.getElementById('encounterDisplay').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // Helper function: Get skill checks relevant to a specific location
        function getSkillChecksForLocation(locationTags) {
            if (!window.encounterSkillChecks || !locationTags) return [];
            
            // Score each skill check against location tags
            const scoredChecks = window.encounterSkillChecks.map(check => {
                let score = 0;
                for (const tag of check.tags) {
                    if (locationTags.includes(tag)) score += 1;
                }
                score += Math.random() * 0.3; // Add slight randomness
                return { check, score };
            });
            
            // Sort by score and return top 2-3 checks
            scoredChecks.sort((a, b) => b.score - a.score);
            const numChecks = scoredChecks[0].score > 0 ? Math.min(3, Math.ceil(Math.random() * 2) + 1) : 0;
            return scoredChecks.slice(0, numChecks).map(s => s.check);
        }

        // Helper function: Get traps relevant to a specific location
        function getTrapsForLocation(locationTags) {
            if (!window.encounterTraps || !locationTags) return [];
            
            // Score each trap against location tags
            const scoredTraps = window.encounterTraps.map(trap => {
                let score = 0;
                for (const tag of trap.tags) {
                    if (locationTags.includes(tag)) score += 1;
                }
                score += Math.random() * 0.5;
                return { trap, score };
            });
            
            // Sort by score and maybe return 0-1 trap
            scoredTraps.sort((a, b) => b.score - a.score);
            const hasTrap = scoredTraps[0] && scoredTraps[0].score > 0 && Math.random() < 0.4;
            return hasTrap ? [scoredTraps[0].trap] : [];
        }

        // Helper function: Get hazards relevant to a specific location
        function getHazardsForLocation(locationTags) {
            if (!window.encounterHazards || !locationTags) return [];
            
            // Score each hazard against location tags
            const scoredHazards = window.encounterHazards.map(hazard => {
                let score = 0;
                for (const tag of hazard.tags) {
                    if (locationTags.includes(tag)) score += 1;
                }
                score += Math.random() * 0.5;
                return { hazard, score };
            });
            
            // Sort by score and maybe return 0-1 hazard
            scoredHazards.sort((a, b) => b.score - a.score);
            const hasHazard = scoredHazards[0] && scoredHazards[0].score > 0 && Math.random() < 0.5;
            return hasHazard ? [scoredHazards[0].hazard] : [];
        }

        // Show location detail in side panel
        function showLocationDetail(locationKey, viewLevel = 'primary', selectedIndex = null) {
            const location = window.encounterLocationsData.find(loc => loc.key === locationKey);
            
            if (!location) {
                console.error('Location not found:', locationKey);
                return;
            }

            const panel = document.getElementById('locationDetailPanel');
            const content = document.getElementById('locationDetailContent');
            const progressiveReveal = localStorage.getItem('progressiveReveal') === 'true';
            
            // Get contextual content for this location
            const locationSkillChecks = getSkillChecksForLocation(location.data.tags || []);
            const locationTraps = getTrapsForLocation(location.data.tags || []);
            const locationHazards = getHazardsForLocation(location.data.tags || []);
            
            let html = `
                <h3 style="margin-top: 0;">🗺️ ${location.name}</h3>
                <p style="color: var(--text-secondary); font-style: italic; margin-bottom: 20px;">
                    ${location.data.description || 'A location of interest in the encounter.'}
                </p>
            `;
            
            // Show hazards at the top as warnings if present
            if (locationHazards.length > 0) {
                locationHazards.forEach(hazard => {
                    const saveDC = calculateDC(window.encounterPartyLevel || 5);
                    html += `
                        <div style="background: rgba(255, 149, 0, 0.15); border-left: 3px solid #ff9500; padding: 12px; margin-bottom: 15px; border-radius: 6px;">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
                                <span style="font-size: 1.2em;">⚠️</span>
                                <strong style="color: #ff9500;">${hazard.name}</strong>
                            </div>
                            <p style="margin: 5px 0; font-size: 0.9em;">${hazard.description}</p>
                            <p style="margin: 5px 0; font-size: 0.85em; color: var(--text-secondary);">
                                <strong>Save:</strong> ${hazard.saveAbility} DC ${saveDC} | <strong>Effect:</strong> ${hazard.effect}
                            </p>
                        </div>
                    `;
                });
            }
            
            
            if (progressiveReveal) {
                // Progressive reveal mode - interactive drill-down
                
                // Breadcrumb navigation
                html += `
                    <div class="location-breadcrumb">
                        <span class="breadcrumb-item ${viewLevel === 'primary' ? 'active' : ''}" 
                              onclick="showLocationDetail('${locationKey}', 'primary')">
                            🔍 Primary
                        </span>
                `;
                
                if (viewLevel === 'secondary' || viewLevel === 'tertiary') {
                    html += `
                        <span class="breadcrumb-separator">→</span>
                        <span class="breadcrumb-item ${viewLevel === 'secondary' ? 'active' : ''}" 
                              onclick="showLocationDetail('${locationKey}', 'secondary', ${selectedIndex})">
                            🔎 Secondary
                        </span>
                    `;
                }
                
                if (viewLevel === 'tertiary') {
                    html += `
                        <span class="breadcrumb-separator">→</span>
                        <span class="breadcrumb-item active">
                            ✨ Discovery
                        </span>
                    `;
                }
                
                html += `</div>`;
                
                // Content based on current view level
                if (viewLevel === 'primary') {
                    // Show all primary features as clickable items
                    if (location.data.primary && location.data.primary.length > 0) {
                        html += `
                            <div style="margin-bottom: 20px;">
                                <h4 style="color: var(--accent-blue); margin-bottom: 15px;">
                                    🔍 Primary Features
                                </h4>
                                <p style="color: var(--text-secondary); font-size: 0.9em; margin-bottom: 10px; font-style: italic;">
                                    Click a feature to investigate further...
                                </p>
                        `;
                        
                        location.data.primary.forEach((item, index) => {
                            html += `
                                <div class="feature-item primary-feature" 
                                     onclick="showLocationDetail('${locationKey}', 'secondary', ${index})">
                                    ${item}
                                </div>
                            `;
                        });
                        
                        html += `</div>`;
                    }
                    
                    // Show skill checks relevant to this location
                    if (locationSkillChecks.length > 0) {
                        html += `
                            <div style="margin-bottom: 20px;">
                                <h4 style="color: var(--accent-blue); margin-bottom: 10px;">
                                    🎯 Possible Skill Checks
                                </h4>
                                <p style="color: var(--text-secondary); font-size: 0.85em; margin-bottom: 10px; font-style: italic;">
                                    Suggested checks for interacting with this location...
                                </p>
                        `;
                        
                        locationSkillChecks.forEach(skill => {
                            const dc = calculateDC(window.encounterPartyLevel || 5);
                            html += `
                                <div style="background: rgba(52, 152, 219, 0.1); border-left: 3px solid var(--accent-blue); padding: 10px; margin: 8px 0; border-radius: 4px;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                                        <strong style="color: var(--accent-blue);">${skill.skill}</strong>
                                        <span style="background: var(--accent-blue); color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.85em; font-weight: bold;">DC ${dc}</span>
                                    </div>
                                    <p style="margin: 4px 0; font-size: 0.9em;"><strong>${skill.challenge}</strong></p>
                                    <p style="margin: 4px 0; font-size: 0.85em; color: var(--text-secondary);">
                                        <strong>Success:</strong> ${skill.success}
                                    </p>
                                    <p style="margin: 4px 0; font-size: 0.85em; color: var(--text-secondary);">
                                        <strong>Failure:</strong> ${skill.failure}
                                    </p>
                                </div>
                            `;
                        });
                        
                        html += `</div>`;
                    }
                } else if (viewLevel === 'secondary' && selectedIndex !== null) {
                    // Show specific secondary detail with back button
                    if (location.data.secondary && location.data.secondary[selectedIndex]) {
                        html += `
                            <div class="back-button" onclick="showLocationDetail('${locationKey}', 'primary')">
                                ← Back to Primary Features
                            </div>
                            <div style="margin-bottom: 20px;">
                                <h4 style="color: var(--accent-blue); margin-bottom: 10px;">
                                    � Investigating: ${location.data.primary[selectedIndex]}
                                </h4>
                                <div class="feature-item secondary-feature" 
                                     onclick="showLocationDetail('${locationKey}', 'tertiary', ${selectedIndex})"
                                     style="margin-top: 15px;">
                                    <strong>🔎 What you discover:</strong><br>
                                    ${location.data.secondary[selectedIndex]}
                                    <div style="margin-top: 10px; font-size: 0.85em; color: var(--text-secondary); font-style: italic;">
                                        Click to investigate deeper...
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                } else if (viewLevel === 'tertiary' && selectedIndex !== null) {
                    // Show hidden discovery with back button
                    // Randomly decide if this discovery is a trap (30% chance if traps available)
                    const isTrap = locationTraps.length > 0 && Math.random() < 0.3;
                    
                    if (isTrap) {
                        const trap = locationTraps[0];
                        const detectDC = calculateDC(window.encounterPartyLevel || 5);
                        const disarmDC = detectDC + 2;
                        
                        html += `
                            <div class="back-button" onclick="showLocationDetail('${locationKey}', 'secondary', ${selectedIndex})">
                                ← Back to Secondary Details
                            </div>
                            <div style="margin-bottom: 20px;">
                                <h4 style="color: var(--accent-blue); margin-bottom: 10px;">
                                    🔍 ${location.data.primary[selectedIndex]}
                                </h4>
                                <div style="background: rgba(52, 152, 219, 0.08); padding: 12px; border-radius: 6px; margin-bottom: 15px;">
                                    <strong>🔎 Secondary Details:</strong><br>
                                    ${location.data.secondary[selectedIndex]}
                                </div>
                                <div class="feature-item tertiary-feature" style="border: 2px solid #ff3b30; background: rgba(255, 59, 48, 0.1); cursor: default;">
                                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                        <span style="font-size: 1.3em;">⚠️</span>
                                        <strong style="color: #ff3b30;">TRAP: ${trap.name}</strong>
                                    </div>
                                    <p style="margin: 6px 0;"><strong>Description:</strong> ${trap.description}</p>
                                    <p style="margin: 6px 0;"><strong>Detect:</strong> ${trap.detectMethod} (DC ${detectDC})</p>
                                    <p style="margin: 6px 0;"><strong>Disarm:</strong> ${trap.disarmMethod} (DC ${disarmDC})</p>
                                    <p style="margin: 6px 0;"><strong>Damage:</strong> ${trap.damageType} | <strong>Severity:</strong> ${trap.severity}</p>
                                    <div style="margin-top: 10px; font-size: 0.85em; opacity: 0.8; font-style: italic; color: #ff3b30;">
                                        🪤 Hidden danger! Players investigating this area trigger the trap unless they actively search for it first.
                                    </div>
                                </div>
                            </div>
                        `;
                    } else if (location.data.tertiary && location.data.tertiary[selectedIndex]) {
                        html += `
                            <div class="back-button" onclick="showLocationDetail('${locationKey}', 'secondary', ${selectedIndex})">
                                ← Back to Secondary Details
                            </div>
                            <div style="margin-bottom: 20px;">
                                <h4 style="color: var(--accent-blue); margin-bottom: 10px;">
                                    🔍 ${location.data.primary[selectedIndex]}
                                </h4>
                                <div style="background: rgba(52, 152, 219, 0.08); padding: 12px; border-radius: 6px; margin-bottom: 15px;">
                                    <strong>🔎 Secondary Details:</strong><br>
                                    ${location.data.secondary[selectedIndex]}
                                </div>
                                <div class="feature-item tertiary-feature" style="border: 2px solid #f39c12; cursor: default;">
                                    <strong>✨ Hidden Discovery:</strong><br>
                                    ${location.data.tertiary[selectedIndex]}
                                    <div style="margin-top: 10px; font-size: 0.85em; opacity: 0.8; font-style: italic;">
                                        💎 This could be valuable, dangerous, or story-relevant!
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                }
            } else {
                // Show all mode - everything expanded
                
                // Primary Features
                if (location.data.primary && location.data.primary.length > 0) {
                    html += `
                        <div style="margin-bottom: 20px;">
                            <h4 style="color: var(--accent-blue); margin-bottom: 10px; border-bottom: 1px solid rgba(0, 122, 255, 0.3); padding-bottom: 5px;">
                                🔍 Primary Features
                            </h4>
                            <ul style="margin: 10px 0; padding-left: 20px;">
                                ${location.data.primary.map(item => `<li style="margin: 8px 0;">${item}</li>`).join('')}
                            </ul>
                        </div>
                    `;
                }
                
                // Skill Checks for this location
                if (locationSkillChecks.length > 0) {
                    html += `
                        <div style="margin-bottom: 20px;">
                            <h4 style="color: var(--accent-blue); margin-bottom: 10px; border-bottom: 1px solid rgba(0, 122, 255, 0.3); padding-bottom: 5px;">
                                🎯 Possible Skill Checks
                            </h4>
                    `;
                    
                    locationSkillChecks.forEach(skill => {
                        const dc = calculateDC(window.encounterPartyLevel || 5);
                        html += `
                            <div style="background: rgba(52, 152, 219, 0.1); border-left: 3px solid var(--accent-blue); padding: 10px; margin: 8px 0; border-radius: 4px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                                    <strong style="color: var(--accent-blue);">${skill.skill}</strong>
                                    <span style="background: var(--accent-blue); color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.85em; font-weight: bold;">DC ${dc}</span>
                                </div>
                                <p style="margin: 4px 0; font-size: 0.9em;"><strong>${skill.challenge}</strong></p>
                                <p style="margin: 4px 0; font-size: 0.85em; color: var(--text-secondary);">
                                    <strong>Success:</strong> ${skill.success}
                                </p>
                                <p style="margin: 4px 0; font-size: 0.85em; color: var(--text-secondary);">
                                    <strong>Failure:</strong> ${skill.failure}
                                </p>
                            </div>
                        `;
                    });
                    
                    html += `</div>`;
                }
                
                // Secondary Details
                if (location.data.secondary && location.data.secondary.length > 0) {
                    html += `
                        <div style="margin-bottom: 20px;">
                            <h4 style="color: var(--accent-blue); margin-bottom: 10px; border-bottom: 1px solid rgba(0, 122, 255, 0.3); padding-bottom: 5px;">
                                🔎 Secondary Details
                            </h4>
                            <ul style="margin: 10px 0; padding-left: 20px;">
                                ${location.data.secondary.map(item => `<li style="margin: 8px 0;">${item}</li>`).join('')}
                            </ul>
                        </div>
                    `;
                }
                
                // Tertiary Discoveries
                if (location.data.tertiary && location.data.tertiary.length > 0) {
                    html += `
                        <div style="margin-bottom: 20px;">
                            <h4 style="color: #f39c12; margin-bottom: 10px; border-bottom: 1px solid rgba(243, 156, 18, 0.3); padding-bottom: 5px;">
                                ✨ Hidden Discoveries
                            </h4>
                            <ul style="margin: 10px 0; padding-left: 20px;">
                                ${location.data.tertiary.map(item => `<li style="margin: 8px 0; color: #f39c12;">${item}</li>`).join('')}
                            </ul>
                        </div>
                    `;
                }
                
                // Traps in this location (if any)
                if (locationTraps.length > 0) {
                    html += `
                        <div style="margin-bottom: 20px;">
                            <h4 style="color: #ff3b30; margin-bottom: 10px; border-bottom: 1px solid rgba(255, 59, 48, 0.3); padding-bottom: 5px;">
                                ⚠️ Possible Traps
                            </h4>
                    `;
                    
                    locationTraps.forEach(trap => {
                        const detectDC = calculateDC(window.encounterPartyLevel || 5);
                        const disarmDC = detectDC + 2;
                        html += `
                            <div style="background: rgba(255, 59, 48, 0.1); border-left: 3px solid #ff3b30; padding: 10px; margin: 8px 0; border-radius: 4px;">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
                                    <span style="font-size: 1.1em;">🪤</span>
                                    <strong style="color: #ff3b30;">${trap.name}</strong>
                                </div>
                                <p style="margin: 4px 0; font-size: 0.9em;">${trap.description}</p>
                                <p style="margin: 4px 0; font-size: 0.85em;"><strong>Detect:</strong> ${trap.detectMethod} (DC ${detectDC})</p>
                                <p style="margin: 4px 0; font-size: 0.85em;"><strong>Disarm:</strong> ${trap.disarmMethod} (DC ${disarmDC})</p>
                                <p style="margin: 4px 0; font-size: 0.85em;"><strong>Damage:</strong> ${trap.damageType} | <strong>Severity:</strong> ${trap.severity}</p>
                            </div>
                        `;
                    });
                    
                    html += `</div>`;
                }
            }
            
            // Tags
            if (location.data.tags && location.data.tags.length > 0) {
                html += `
                    <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid rgba(255, 255, 255, 0.1);">
                        <div style="display: flex; flex-wrap: wrap; gap: 6px;">
                            ${location.data.tags.map(tag => `
                                <span style="background: rgba(0, 122, 255, 0.2); color: var(--accent-blue); padding: 4px 10px; border-radius: 12px; font-size: 0.85em;">
                                    ${tag}
                                </span>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            content.innerHTML = html;
            panel.classList.add('active');
        }

        // Toggle location section expansion
        function toggleLocationSection(sectionId) {
            const content = document.getElementById(sectionId);
            const header = content.previousElementSibling;
            
            if (content.classList.contains('expanded')) {
                content.classList.remove('expanded');
                header.classList.remove('expanded');
            } else {
                content.classList.add('expanded');
                header.classList.add('expanded');
            }
        }

        // Hide location detail panel
        function hideLocationDetail() {
            const panel = document.getElementById('locationDetailPanel');
            panel.classList.remove('active');
        }

        // Close panel when clicking outside
        document.addEventListener('click', function(e) {
            const panel = document.getElementById('locationDetailPanel');
            // Don't close if clicking inside the panel or on interactive elements
            const isInteractive = e.target.classList.contains('location-link') ||
                                  e.target.classList.contains('feature-item') ||
                                  e.target.classList.contains('back-button') ||
                                  e.target.classList.contains('breadcrumb-item') ||
                                  e.target.closest('.feature-item') ||
                                  e.target.closest('.back-button') ||
                                  e.target.closest('.breadcrumb-item');
            
            if (panel.classList.contains('active') && !panel.contains(e.target) && !isInteractive) {
                hideLocationDetail();
            }

            // Also check NPC panel
            const npcPanel = document.getElementById('npcDetailPanel');
            const isNPCInteractive = e.target.classList.contains('npc-link') ||
                                     e.target.closest('.npc-link');
            
            if (npcPanel.classList.contains('active') && !npcPanel.contains(e.target) && !isNPCInteractive) {
                hideNPCDetail();
            }
        });

        // Flow Navigator Functions
        function toggleFlowNavigator() {
            const navigator = document.getElementById('flowNavigator');
            const toggle = document.getElementById('flowNavigatorToggle');
            const mainContent = document.getElementById('mainContent');
            
            navigator.classList.toggle('active');
            toggle.classList.toggle('active');
            mainContent.classList.toggle('nav-active');
            
            // Update toggle icon
            toggle.textContent = navigator.classList.contains('active') ? '◀' : '▶';
        }

        // Section collapse/expand functionality
        function toggleSection(event) {
            // Get the h2 element that was clicked
            const header = event.currentTarget;
            const section = header.closest('.encounter-section');
            const content = section.querySelector('.section-content');
            const toggle = header.querySelector('.section-toggle');
            
            if (content) {
                content.classList.toggle('collapsed');
                toggle.classList.toggle('collapsed');
            }
        }

        function populateFlowNavigator(flowSteps) {
            const content = document.getElementById('flowNavigatorContent');
            
            if (!flowSteps || flowSteps.length === 0) {
                content.innerHTML = '<p style="color: var(--text-secondary); font-size: 0.9em;">No encounter flow available</p>';
                return;
            }
            
            let html = '';
            
            flowSteps.forEach((step, index) => {
                const isLastStep = index === flowSteps.length - 1;
                const stepId = `flow-step-${step.step}`;
                
                html += `
                    <div class="flow-step" onclick="scrollToFlowStep(${step.step})">
                        <div class="flow-step-node">
                            <div class="flow-step-number">${step.step}</div>
                            <div class="flow-step-title">${step.title}</div>
                `;
                
                // Show location(s)
                if (step.location) {
                    html += `
                            <div class="flow-step-location">
                                📍 ${step.location.name}
                            </div>
                    `;
                } else if (step.locations && step.locations.length > 0) {
                    html += `
                            <div class="flow-step-location">
                                📍 ${step.locations.length} optional locations
                            </div>
                    `;
                }
                
                html += `
                        </div>
                    </div>
                `;
                
                // Add connector between steps
                if (!isLastStep) {
                    html += `<div class="flow-connector"></div>`;
                }
            });
            
            content.innerHTML = html;
        }

        function scrollToFlowStep(stepNumber) {
            const stepElement = document.getElementById(`flow-step-${stepNumber}`);
            if (stepElement) {
                stepElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }

        // NPC Detail Panel Functions
        function showNPCDetail(npcIndex) {
            const npc = window.encounterNPCsData[npcIndex];
            
            if (!npc) {
                console.error('NPC not found at index:', npcIndex);
                return;
            }

            const panel = document.getElementById('npcDetailPanel');
            const content = document.getElementById('npcDetailContent');
            
            // Debug: Log NPC data structure
            console.log('NPC Data:', npc);
            
            let html = `
                <h3 style="margin-top: 0; color: #9b59b6;">👤 ${npc.name}</h3>
                <p style="color: var(--text-secondary); font-style: italic; margin-bottom: 20px;">
                    ${npc.species} ${npc.profession?.name || npc.profession}
                </p>

                <div style="margin-bottom: 20px;">
                    <h4 style="color: #9b59b6; margin-bottom: 10px; border-bottom: 1px solid rgba(155, 89, 182, 0.3); padding-bottom: 5px;">
                        📋 Basic Information
                    </h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
                        <div>
                            <strong style="color: var(--text-secondary);">Species:</strong>
                            <div style="color: var(--text-primary);">${npc.species || 'Unknown'}</div>
                        </div>
                        <div>
                            <strong style="color: var(--text-secondary);">Profession:</strong>
                            <div style="color: var(--text-primary);">${npc.profession?.name || npc.profession || 'Unknown'}</div>
                        </div>
                        <div>
                            <strong style="color: var(--text-secondary);">Alignment:</strong>
                            <div style="color: var(--text-primary);">${npc.alignment?.name || npc.alignment || 'Unknown'}</div>
                        </div>
                        <div>
                            <strong style="color: var(--text-secondary);">Personality:</strong>
                            <div style="color: var(--text-primary);">${npc.personality?.trait || npc.personality || 'Unknown'}</div>
                        </div>
                    </div>
                </div>

                <div style="margin-bottom: 20px;">
                    <h4 style="color: #9b59b6; margin-bottom: 10px; border-bottom: 1px solid rgba(155, 89, 182, 0.3); padding-bottom: 5px;">
                        👁️ Appearance
                    </h4>
                    <p style="color: var(--text-secondary); font-style: italic;">${npc.appearance || 'No description available'}</p>
                </div>

                <div style="margin-bottom: 20px;">
                    <h4 style="color: #9b59b6; margin-bottom: 10px; border-bottom: 1px solid rgba(155, 89, 182, 0.3); padding-bottom: 5px;">
                        🎭 Role in Encounter
                    </h4>
                    <p style="color: var(--text-secondary);">${npc.profession?.description || 'A ' + (npc.profession?.name || npc.profession) + ' in the area.'}</p>
                    <p style="color: var(--text-secondary); margin-top: 8px;"><strong>Can:</strong> ${getProfessionRoleTip(npc.profession?.name || npc.profession)}</p>
                </div>

                <div style="background: rgba(255, 149, 0, 0.1); border-left: 3px solid #ff9500; padding: 12px; border-radius: 6px; margin-bottom: 20px;">
                    <h4 style="color: #ff9500; margin: 0 0 8px 0;">
                        🤫 Secret (DM Only)
                    </h4>
                    <p style="color: var(--text-secondary); margin: 0; font-style: italic;">${npc.secret || 'No secret revealed'}</p>
                </div>

                <div style="background: rgba(155, 89, 182, 0.1); border-radius: 6px; padding: 12px;">
                    <h4 style="color: #9b59b6; margin: 0 0 8px 0;">
                        ⚖️ Alignment
                    </h4>
                    <p style="color: var(--text-secondary); margin: 0;">${npc.alignment?.description || 'Alignment: ' + (npc.alignment?.name || npc.alignment || 'Unknown')}</p>
                </div>
            `;
            
            content.innerHTML = html;
            panel.classList.add('active');
        }

        function hideNPCDetail() {
            const panel = document.getElementById('npcDetailPanel');
            panel.classList.remove('active');
        }

        // NPC Tooltip Functions
        function showNPCTooltip(event, npcIndex) {
            const npc = window.encounterNPCsData[npcIndex];
            
            if (!npc) return;

            const tooltip = document.getElementById('npcTooltip');
            
            tooltip.innerHTML = `
                <div class="npc-tooltip-header">👤 ${npc.name}</div>
                <div class="npc-tooltip-row">
                    <span class="npc-tooltip-label">Species:</span>
                    <span class="npc-tooltip-value">${npc.species || 'Unknown'}</span>
                </div>
                <div class="npc-tooltip-row">
                    <span class="npc-tooltip-label">Profession:</span>
                    <span class="npc-tooltip-value">${npc.profession?.name || npc.profession || 'Unknown'}</span>
                </div>
                <div class="npc-tooltip-row">
                    <span class="npc-tooltip-label">Alignment:</span>
                    <span class="npc-tooltip-value">${npc.alignment?.name || npc.alignment || 'Unknown'}</span>
                </div>
                <div class="npc-tooltip-row">
                    <span class="npc-tooltip-label">Personality:</span>
                    <span class="npc-tooltip-value">${npc.personality?.trait || npc.personality || 'Unknown'}</span>
                </div>
                <div class="npc-tooltip-hint">Click for full details</div>
            `;
            
            // Position tooltip near the cursor
            const x = event.clientX + 15;
            const y = event.clientY + 15;
            
            tooltip.style.left = x + 'px';
            tooltip.style.top = y + 'px';
            tooltip.classList.add('active');
        }

        function hideNPCTooltip() {
            const tooltip = document.getElementById('npcTooltip');
            tooltip.classList.remove('active');
        }

        // Generate Locations for Encounter
        function selectLocationsForEncounter(encounterTags, environment, numLocations = null) {
            // Determine number of locations (3-5 based on random distribution)
            if (numLocations === null) {
                // Weighted toward 3-4 locations
                const roll = Math.random();
                if (roll < 0.4) numLocations = 3;      // 40%
                else if (roll < 0.75) numLocations = 4; // 35%
                else numLocations = 5;                  // 25%
            }
            
            const environmentLocations = locationObjects[environment];
            if (!environmentLocations) {
                console.warn('No locations found for environment:', environment);
                return [];
            }
            
            const locations = [];
            const locationKeys = Object.keys(environmentLocations);
            const usedLocations = new Set();
            
            for (let i = 0; i < numLocations && locationKeys.length > 0; i++) {
                // Score each location based on tag matching
                const locationScores = locationKeys
                    .filter(key => !usedLocations.has(key))
                    .map(key => {
                        const location = environmentLocations[key];
                        let score = 0;
                        
                        // Count matching tags
                        for (const tag of encounterTags) {
                            if (location.tags && location.tags.includes(tag)) {
                                score += 2; // Higher weight for direct matches
                            }
                        }
                        
                        // Bonus for environmental tags matching
                        if (location.tags) {
                            for (const tag of location.tags) {
                                if (encounterTags.includes(tag)) {
                                    score += 1;
                                }
                            }
                        }
                        
                        // Add small random variance for interesting variety
                        score += Math.random() * 0.5;
                        
                        return { key, location, score };
                    });
                
                // If no locations have matching tags, use random distribution
                if (locationScores.every(l => l.score < 0.5)) {
                    const availableKeys = locationKeys.filter(k => !usedLocations.has(k));
                    if (availableKeys.length === 0) break;
                    
                    const randomKey = availableKeys[Math.floor(Math.random() * availableKeys.length)];
                    usedLocations.add(randomKey);
                    locations.push({
                        key: randomKey,
                        name: formatLocationName(randomKey),
                        data: environmentLocations[randomKey]
                    });
                    continue;
                }
                
                // Sort by score and use weighted random selection
                locationScores.sort((a, b) => b.score - a.score);
                
                // Weighted selection: higher scores more likely, but not guaranteed
                const totalScore = locationScores.reduce((sum, l) => sum + Math.max(0.1, l.score), 0);
                let random = Math.random() * totalScore;
                
                let selectedLocation = null;
                for (const scored of locationScores) {
                    random -= Math.max(0.1, scored.score);
                    if (random <= 0) {
                        selectedLocation = scored;
                        break;
                    }
                }
                
                // Fallback to highest scored
                if (!selectedLocation) {
                    selectedLocation = locationScores[0];
                }
                
                usedLocations.add(selectedLocation.key);
                locations.push({
                    key: selectedLocation.key,
                    name: formatLocationName(selectedLocation.key),
                    data: selectedLocation.location
                });
            }
            
            return locations;
        }

        function formatLocationName(key) {
            // Convert snake_case or single words to Title Case
            return key
                .split('_')
                .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                .join(' ');
        }

        function generateEncounterFlow(locations, npcs, encounterTitle) {
            if (locations.length === 0) return null;
            
            // Helper function to wrap NPC name with interactive elements
            function wrapNPCName(npc, index) {
                return `<span class="npc-link" 
                             onclick="showNPCDetail(${index})" 
                             onmouseenter="showNPCTooltip(event, ${index})"
                             onmouseleave="hideNPCTooltip()">${npc.name}</span>`;
            }
            
            const flowSteps = [];
            
            // Step 1: Initial encounter setup
            flowSteps.push({
                step: 1,
                title: "Initial Discovery",
                location: locations[0],
                description: `The party first encounters ${encounterTitle.toLowerCase()}. They arrive at ${locations[0].name}, where the situation begins to unfold.`,
                dmTips: [
                    "Set the atmosphere with sensory details from the location description",
                    "Introduce environmental effects or hazards to establish tension",
                    npcs.length > 0 ? `Consider having ${wrapNPCName(npcs[0], 0)} (${npcs[0].profession.name}) present here` : "Consider adding ambient sounds or NPC activity"
                ]
            });
            
            // Step 2: Investigation/Complication (if there's a second location)
            if (locations.length > 1) {
                flowSteps.push({
                    step: 2,
                    title: "Investigation & Complications",
                    location: locations[1],
                    description: `Clues, encounters, or circumstances lead the party to ${locations[1].name}. The situation deepens as they uncover more details.`,
                    dmTips: [
                        `Primary features from ${locations[0].name} can provide hints or connections to this location`,
                        "Introduce skill challenges or traps as the party moves between locations",
                        npcs.length > 1 ? `${wrapNPCName(npcs[1], 1)} might provide information, create obstacles, or offer assistance` : "Add tension through environmental effects"
                    ],
                    connections: [
                        `Evidence at ${locations[0].name} points to activity here`,
                        `NPCs or witnesses mention this location`,
                        `A discovered map, key, or clue leads directly here`
                    ]
                });
            }
            
            // Step 3: Escalation (if there's a third location)
            if (locations.length > 2) {
                flowSteps.push({
                    step: 3,
                    title: "Escalation Point",
                    location: locations[2],
                    description: `The encounter intensifies at ${locations[2].name}. Stakes are raised and the party must make crucial decisions.`,
                    dmTips: [
                        "This is where major conflict, revelations, or challenges should occur",
                        "Combine multiple hazards or environmental effects for maximum drama",
                        npcs.length > 2 ? `${wrapNPCName(npcs[2], 2)}'s secret or motivations might be revealed here` : "Consider adding a time-pressure element"
                    ],
                    connections: [
                        `Chase, pursuit, or urgency drives the party from ${locations[1].name}`,
                        `A discovered tertiary object reveals the true nature of the situation`,
                        `Environmental hazards force movement to this location`
                    ]
                });
            }
            
            // Step 4: Additional locations become optional branches or parallel events
            if (locations.length > 3) {
                const remainingLocations = locations.slice(3);
                flowSteps.push({
                    step: 4,
                    title: "Branching Paths & Optional Areas",
                    locations: remainingLocations,
                    description: `The encounter can branch to these additional locations based on party choices, investigation results, or NPC interactions.`,
                    dmTips: [
                        "These locations can be explored in any order or skipped entirely",
                        "Use them as rewards for good investigation or clever thinking",
                        "They can provide alternative solutions, shortcuts, or additional complications"
                    ],
                    branches: remainingLocations.map((loc, i) => ({
                        location: loc,
                        reason: [
                            "Party splits up to cover more ground",
                            "Following a specific NPC or lead",
                            "Seeking additional resources or information",
                            "Avoiding danger in the main path"
                        ][i % 4]
                    }))
                });
            }
            
            // Final step: Resolution
            const finalLocation = locations.length > 2 ? locations[2] : locations[locations.length - 1];
            flowSteps.push({
                step: flowSteps.length + 1,
                title: "Resolution",
                location: finalLocation,
                description: `The encounter concludes, typically at ${finalLocation.name} or wherever the party's investigation leads them.`,
                dmTips: [
                    "Tie up loose threads and reveal the outcome of the party's choices",
                    "Tertiary discoveries here can provide significant rewards or plot hooks",
                    "NPCs react to how the party handled the situation",
                    "Set up future adventures or consequences based on the resolution"
                ]
            });
            
            return flowSteps;
        }

        // Generate NPC
        function selectNPCsForEncounter(encounterTags, numNPCs = null) {
            // Safety check: ensure npcData is loaded
            if (!npcData || !npcData.professions || !npcData.species) {
                console.error('NPC data not loaded yet!');
                return [];
            }
            
            // Determine number of NPCs (1-3 based on encounter context)
            if (numNPCs === null) {
                numNPCs = Math.floor(Math.random() * 3) + 1;
            }
            
            console.log('selectNPCsForEncounter - npcData available:', !!npcData);
            console.log('npcData keys:', npcData ? Object.keys(npcData) : 'npcData is null/undefined');
            console.log('Appearances count:', npcData?.appearances?.length || 0);
            console.log('Secrets count:', npcData?.secrets?.length || 0);
            console.log('Personalities count:', npcData?.personalities?.length || 0);
            console.log('Alignments count:', npcData?.alignments?.length || 0);
            
            const npcs = [];
            const usedProfessions = new Set();
            
            for (let i = 0; i < numNPCs; i++) {
                // Score each profession based on tag matching
                const professionScores = npcData.professions.map(profession => {
                    // Don't reuse professions
                    if (usedProfessions.has(profession.name)) {
                        return { profession, score: -1 };
                    }
                    
                    // Count matching tags
                    let score = 0;
                    for (const tag of encounterTags) {
                        if (profession.tags.includes(tag)) {
                            score++;
                        }
                    }
                    
                    return { profession, score };
                });
                
                // Filter out professions with no matching tags and already used ones
                const validProfessions = professionScores.filter(p => p.score > 0);
                
                // If no matches, pick a random profession
                let selectedProfession;
                if (validProfessions.length === 0) {
                    const availableProfessions = npcData.professions.filter(p => !usedProfessions.has(p.name));
                    selectedProfession = availableProfessions[Math.floor(Math.random() * availableProfessions.length)];
                } else {
                    // Weight selection by score - higher scores more likely
                    const maxScore = Math.max(...validProfessions.map(p => p.score));
                    const topProfessions = validProfessions.filter(p => p.score >= maxScore - 1);
                    selectedProfession = topProfessions[Math.floor(Math.random() * topProfessions.length)].profession;
                }
                
                usedProfessions.add(selectedProfession.name);
                
                // Generate the NPC
                const speciesKeys = Object.keys(npcData.species);
                const species = speciesKeys[Math.floor(Math.random() * speciesKeys.length)];
                const speciesData = npcData.species[species];
                
                const firstName = speciesData.firstNames[Math.floor(Math.random() * speciesData.firstNames.length)];
                const surname = speciesData.surnames[Math.floor(Math.random() * speciesData.surnames.length)];
                const fullName = `${firstName} ${surname}`;
                
                const alignment = npcData.alignments?.[Math.floor(Math.random() * npcData.alignments.length)] || { name: 'Neutral', description: 'Acts according to circumstance' };
                const personalityObj = npcData.personalities?.[Math.floor(Math.random() * npcData.personalities.length)] || { trait: 'Reserved', description: 'Keeps to themselves' };
                const secretObj = npcData.secrets?.[Math.floor(Math.random() * npcData.secrets.length)] || { secret: 'Has a hidden past', tags: [] };
                const appearanceObj = npcData.appearances?.[Math.floor(Math.random() * npcData.appearances.length)] || { description: 'Unremarkable appearance', tags: [] };
                
                // Extract the actual string values from the objects
                const personality = personalityObj; // Keep as object for trait and description access
                const secret = secretObj.secret || secretObj;
                const appearance = appearanceObj.description || appearanceObj;
                
                console.log(`Generated NPC ${i+1}:`, {
                    name: fullName,
                    alignment: alignment,
                    personality: personality,
                    secretObj: secretObj,
                    secret: secret,
                    appearanceObj: appearanceObj,
                    appearance: appearance
                });
                
                npcs.push({
                    name: fullName,
                    species,
                    speciesData,
                    profession: selectedProfession,
                    alignment,
                    personality,
                    appearance,
                    secret
                });
            }
            
            return npcs;
        }

        function generateNPC() {
            const selectedSpecies = document.getElementById('npcSpecies').value;
            const selectedProfession = document.getElementById('npcProfession').value;
            const selectedAlignment = document.getElementById('npcAlignment').value;
            const selectedPersonality = document.getElementById('npcPersonality').value;
            
            // Choose species
            const speciesKeys = Object.keys(npcData.species);
            const species = selectedSpecies === 'random' 
                ? speciesKeys[Math.floor(Math.random() * speciesKeys.length)]
                : selectedSpecies;
            
            const speciesData = npcData.species[species];
            
            // Generate name
            const firstName = speciesData.firstNames[Math.floor(Math.random() * speciesData.firstNames.length)];
            const surname = speciesData.surnames[Math.floor(Math.random() * speciesData.surnames.length)];
            const fullName = `${firstName} ${surname}`;
            
            // Generate characteristics based on filters
            const alignment = selectedAlignment === 'random'
                ? npcData.alignments[Math.floor(Math.random() * npcData.alignments.length)]
                : npcData.alignments.find(a => a.name === selectedAlignment);
            
            const personality = selectedPersonality === 'random'
                ? npcData.personalities[Math.floor(Math.random() * npcData.personalities.length)]
                : npcData.personalities.find(p => p.trait === selectedPersonality);
            
            const profession = selectedProfession === 'random'
                ? npcData.professions[Math.floor(Math.random() * npcData.professions.length)]
                : npcData.professions.find(p => p.name === selectedProfession);
            
            const secret = npcData.secrets[Math.floor(Math.random() * npcData.secrets.length)];
            const appearance = npcData.appearances[Math.floor(Math.random() * npcData.appearances.length)];
            
            // Build display HTML
            let html = `
                <div class="encounter-section">
                    <h2>👤 ${fullName}</h2>
                    <p style="font-size: 1.2em; color: var(--text-secondary); margin-bottom: 20px;">
                        ${species.charAt(0).toUpperCase() + species.slice(1)} ${profession.name}
                    </p>
                </div>

                <div class="encounter-section">
                    <h3>Basic Information</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px;">
                        <div>
                            <strong style="color: var(--accent-blue);">Species:</strong>
                            <p class="description" style="margin-top: 5px;">${species.charAt(0).toUpperCase() + species.slice(1)}</p>
                            <div class="result-tags">
                                ${speciesData.tags.map(tag => `<span class="result-tag">${tag}</span>`).join('')}
                            </div>
                        </div>
                        <div>
                            <strong style="color: var(--accent-blue);">Alignment:</strong>
                            <p class="description" style="margin-top: 5px;">${alignment.name}</p>
                            <div class="result-tags">
                                ${alignment.tags.map(tag => `<span class="result-tag">${tag}</span>`).join('')}
                            </div>
                        </div>
                        <div>
                            <strong style="color: var(--accent-blue);">Profession:</strong>
                            <p class="description" style="margin-top: 5px;">${profession.name}</p>
                            <div class="result-tags">
                                ${profession.tags.map(tag => `<span class="result-tag">${tag}</span>`).join('')}
                            </div>
                        </div>
                    </div>
                </div>

                <div class="encounter-section">
                    <h3>Personality</h3>
                    <p class="description">${personality.trait}</p>
                    <div class="result-tags" style="margin-top: 10px;">
                        ${personality.tags.map(tag => `<span class="result-tag">${tag}</span>`).join('')}
                    </div>
                </div>

                <div class="encounter-section">
                    <h3>Appearance</h3>
                    <p class="description">${appearance.description}</p>
                    <div class="result-tags" style="margin-top: 10px;">
                        ${appearance.tags.map(tag => `<span class="result-tag">${tag}</span>`).join('')}
                    </div>
                </div>

                <div class="encounter-section" style="background: rgba(255, 149, 0, 0.05); border-left: 3px solid #ff9500;">
                    <h3 style="color: #ff9500;">🔒 Secret (DM Only)</h3>
                    <p class="description">${secret.secret}</p>
                    <div class="result-tags" style="margin-top: 10px;">
                        ${secret.tags.map(tag => `<span class="result-tag">${tag}</span>`).join('')}
                    </div>
                </div>

                <div class="encounter-section">
                    <h3>Roleplaying Notes</h3>
                    <ul>
                        <li>Consider how their ${personality.trait.toLowerCase()} personality affects their interactions</li>
                        <li>Their profession as a ${profession.name.toLowerCase()} should influence their knowledge and contacts</li>
                        <li>The secret "${secret.secret.toLowerCase()}" could be revealed through careful questioning or investigation</li>
                        <li>Their ${appearance.description.toLowerCase()} makes them memorable to players</li>
                    </ul>
                </div>
            `;
            
            document.getElementById('npcDisplay').innerHTML = html;
            document.getElementById('npcDisplay').classList.add('active');
            document.getElementById('npcDisplay').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
    </script>
    </div> <!-- End main-content -->
</body>
</html>
