<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LoreWeaver - D&D Exploration Encounter Generator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #8b5cf6;
            --secondary-color: #6366f1;
            --accent-color: #f59e0b;
            --bg-dark: #1a1a2e;
            --bg-medium: #16213e;
            --bg-light: #0f3460;
            --text-light: #eee;
            --text-dark: #aaa;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--bg-dark) 0%, var(--bg-medium) 100%);
            color: var(--text-light);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 40px;
            padding: 20px;
            background: var(--bg-light);
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        h1 {
            font-size: 3em;
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
        }

        .subtitle {
            color: var(--text-dark);
            font-size: 1.2em;
        }

        .controls {
            background: var(--bg-light);
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .control-group {
            margin-bottom: 25px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-light);
            font-weight: 600;
            font-size: 1.1em;
        }

        select, input[type="number"] {
            width: 100%;
            padding: 12px;
            background: var(--bg-medium);
            border: 2px solid var(--primary-color);
            border-radius: 8px;
            color: var(--text-light);
            font-size: 1em;
            transition: all 0.3s ease;
        }

        select:focus, input:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.2);
        }

        select option {
            background: var(--bg-medium);
            color: var(--text-light);
        }

        .environment-tags {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .tag {
            padding: 10px 15px;
            background: var(--bg-medium);
            border: 2px solid var(--primary-color);
            border-radius: 25px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .tag:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.4);
        }

        .tag.active {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            border-color: var(--accent-color);
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.6);
        }

        button {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 1.2em;
            font-weight: bold;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(139, 92, 246, 0.4);
            width: 100%;
            margin-top: 10px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(139, 92, 246, 0.6);
        }

        button:active {
            transform: translateY(0);
        }

        .nav-tabs {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }

        .nav-tab {
            background: var(--bg-medium);
            color: var(--text-dark);
            border: 2px solid transparent;
            padding: 12px 30px;
            font-size: 1.1em;
            font-weight: bold;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            width: auto;
        }

        .nav-tab:hover {
            border-color: var(--primary-color);
            color: var(--text-light);
        }

        .nav-tab.active {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border-color: var(--accent-color);
        }

        .page-content {
            animation: fadeIn 0.3s ease-in;
        }

        .search-controls {
            background: var(--bg-light);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            margin-bottom: 30px;
        }

        .search-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
        }

        .search-bar input {
            flex: 1;
            padding: 15px;
            font-size: 1.1em;
            background: var(--bg-medium);
            border: 2px solid var(--bg-dark);
            border-radius: 10px;
            color: var(--text-light);
            transition: border-color 0.3s ease;
        }

        .search-bar input:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .search-bar button {
            width: auto;
            padding: 15px 30px;
        }

        .filter-section h3 {
            color: var(--accent-color);
            margin-bottom: 20px;
            font-size: 1.3em;
        }

        .filter-group {
            margin-bottom: 20px;
        }

        .filter-group label {
            display: block;
            color: var(--text-dark);
            margin-bottom: 10px;
            font-weight: bold;
        }

        .filter-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .filter-tag {
            padding: 8px 16px;
            background: var(--bg-medium);
            border: 2px solid var(--bg-dark);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9em;
        }

        .filter-tag:hover {
            border-color: var(--primary-color);
            transform: translateY(-2px);
        }

        .filter-tag.active {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            border-color: var(--accent-color);
            color: white;
        }

        .search-results {
            background: var(--bg-light);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .result-card {
            background: var(--bg-medium);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 4px solid var(--accent-color);
            transition: all 0.3s ease;
        }

        .result-card:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 15px rgba(139, 92, 246, 0.3);
        }

        .result-title {
            font-size: 1.3em;
            color: var(--accent-color);
            margin-bottom: 10px;
            font-weight: bold;
        }

        .result-type {
            display: inline-block;
            padding: 4px 12px;
            background: var(--primary-color);
            color: white;
            border-radius: 5px;
            font-size: 0.85em;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .result-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 10px;
        }

        .result-tag {
            padding: 4px 10px;
            background: var(--bg-dark);
            border-radius: 5px;
            font-size: 0.8em;
            color: var(--text-dark);
        }

        .result-description {
            color: var(--text-dark);
            margin-top: 10px;
            line-height: 1.6;
        }

        .result-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .result-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            font-size: 0.9em;
        }

        .preview-btn {
            background: var(--bg-dark);
            color: var(--text-light);
        }

        .preview-btn:hover {
            background: var(--primary-color);
        }

        .open-btn {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
        }

        .open-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.5);
        }

        .preview-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }

        .preview-modal.active {
            display: flex;
        }

        .preview-content {
            background: var(--bg-light);
            padding: 40px;
            border-radius: 15px;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .preview-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: var(--danger);
            color: white;
            border: none;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2em;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .preview-close:hover {
            transform: rotate(90deg);
            background: #dc2626;
        }

        .preview-header {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--accent-color);
        }

        .preview-title {
            font-size: 1.8em;
            color: var(--accent-color);
            margin-bottom: 10px;
        }

        .preview-body {
            color: var(--text-light);
            line-height: 1.8;
        }

        .encounter-display {
            background: var(--bg-light);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            display: none;
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .encounter-display.active {
            display: block;
        }

        .encounter-section {
            margin-bottom: 30px;
            padding: 20px;
            background: var(--bg-medium);
            border-radius: 10px;
            border-left: 4px solid var(--primary-color);
        }

        .encounter-section h2 {
            color: var(--accent-color);
            margin-bottom: 15px;
            font-size: 1.8em;
        }

        .encounter-section h3 {
            color: var(--primary-color);
            margin-top: 20px;
            margin-bottom: 10px;
            font-size: 1.4em;
        }

        .skill-check {
            background: var(--bg-dark);
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 3px solid var(--success);
        }

        .skill-check-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .skill-name {
            font-weight: bold;
            color: var(--success);
            font-size: 1.1em;
        }

        .dc {
            background: var(--primary-color);
            padding: 4px 12px;
            border-radius: 15px;
            font-weight: bold;
        }

        .hazard {
            background: var(--bg-dark);
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 3px solid var(--danger);
        }

        .hazard-name {
            font-weight: bold;
            color: var(--danger);
            font-size: 1.2em;
            margin-bottom: 8px;
        }

        .trap {
            background: var(--bg-dark);
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 3px solid var(--warning);
        }

        .trap-name {
            font-weight: bold;
            color: var(--warning);
            font-size: 1.2em;
            margin-bottom: 8px;
        }

        .scaling-note {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.2), rgba(99, 102, 241, 0.2));
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border: 1px solid var(--primary-color);
        }

        .level-badge {
            display: inline-block;
            background: var(--secondary-color);
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.9em;
            margin-right: 8px;
            font-weight: bold;
        }

        .environmental-effect {
            background: var(--bg-dark);
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 3px solid var(--accent-color);
        }

        .effect-name {
            font-weight: bold;
            color: var(--accent-color);
            font-size: 1.1em;
            margin-bottom: 8px;
        }

        ul {
            margin-left: 20px;
            line-height: 1.8;
        }

        li {
            margin: 8px 0;
        }

        .description {
            line-height: 1.8;
            color: var(--text-dark);
            margin: 10px 0;
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 2em;
            }

            .environment-tags {
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            }

            .controls, .encounter-display {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>‚öîÔ∏è LoreWeaver ‚öîÔ∏è</h1>
            <p class="subtitle">D&D Exploration Encounter Generator</p>
            
            <!-- Navigation Tabs -->
            <div class="nav-tabs">
                <button class="nav-tab active" onclick="switchPage('generate')">üé≤ Generate</button>
                <button class="nav-tab" onclick="switchPage('search')">üîç Search</button>
            </div>
        </header>

        <!-- Generate Page -->
        <div id="generatePage" class="page-content">
            <div class="controls">
                <div class="control-group">
                    <label for="environment">Select Environment:</label>
                    <div class="environment-tags" id="environmentTags">
                        <div class="tag" data-env="urban">üèõÔ∏è Urban</div>
                        <div class="tag" data-env="arctic">‚ùÑÔ∏è Arctic</div>
                        <div class="tag" data-env="ocean">üåä Ocean</div>
                        <div class="tag" data-env="space">üåå Space</div>
                        <div class="tag" data-env="crypt">üíÄ Crypt</div>
                        <div class="tag" data-env="forest">üå≤ Forest</div>
                        <div class="tag" data-env="desert">üèúÔ∏è Desert</div>
                        <div class="tag" data-env="mountain">‚õ∞Ô∏è Mountain</div>
                        <div class="tag" data-env="swamp">üêä Swamp</div>
                        <div class="tag" data-env="underground">üï≥Ô∏è Underground</div>
                    </div>
                </div>

                <div class="control-group">
                    <label for="partyLevel">Party Level (1-20):</label>
                    <input type="number" id="partyLevel" min="1" max="20" value="5">
                </div>

                <button onclick="generateEncounter()">üé≤ Generate Encounter</button>
            </div>

            <div class="encounter-display" id="encounterDisplay">
                <div id="encounterContent"></div>
            </div>

            <!-- Room Display -->
            <div class="room-display" id="roomDisplay" style="display: none;">
                <button onclick="returnToEncounter()" style="background: linear-gradient(135deg, #e74c3c, #c0392b); color: white; border: none; padding: 12px 24px; margin: 20px; font-size: 16px; border-radius: 8px; cursor: pointer; box-shadow: 0 4px 6px rgba(0,0,0,0.2);">
                    ‚Üê Back to Encounter
                </button>
                <div id="roomContent"></div>
            </div>
        </div>

        <!-- Search Page -->
        <div id="searchPage" class="page-content" style="display: none;">
            <div class="search-controls">
                <div class="search-bar">
                    <input type="text" id="searchInput" placeholder="Search encounters and locations (e.g., 'tomb', 'ship', 'forest')..." />
                    <button onclick="performSearch()">üîç Search</button>
                </div>

                <div class="filter-section">
                    <h3>Filter by Tags:</h3>
                    <div class="filter-group">
                        <label>Environment:</label>
                        <div class="filter-tags" id="envFilters"></div>
                    </div>
                    <div class="filter-group">
                        <label>Location Type:</label>
                        <div class="filter-tags" id="locationFilters"></div>
                    </div>
                    <div class="filter-group">
                        <label>Setting:</label>
                        <div class="filter-tags" id="settingFilters"></div>
                    </div>
                    <button onclick="clearFilters()" style="margin-top: 10px; width: auto; padding: 8px 20px;">Clear All Filters</button>
                </div>
            </div>

            <div class="search-results" id="searchResults">
                <p style="text-align: center; color: var(--text-dark); padding: 40px;">Enter a search term or select tags to find encounters and locations</p>
            </div>
        </div>

        <!-- Preview Modal -->
        <div id="previewModal" class="preview-modal">
            <div class="preview-content">
                <button class="preview-close" onclick="closePreview()">‚úï</button>
                <div id="previewBody"></div>
            </div>
        </div>
    </div>

    <script>
        let selectedEnvironment = 'urban';

        // Search page state
        let activeFilters = {
            environment: [],
            locationType: [],
            setting: []
        };

        // Data loaded from external files
        let encounterTitles = {};
        let locationObjects = {};

        // Load data on page load
        async function loadData() {
            try {
                const [encountersResponse, locationsResponse] = await Promise.all([
                    fetch('encounters.json'),
                    fetch('locations.json')
                ]);
                
                encounterTitles = await encountersResponse.json();
                locationObjects = await locationsResponse.json();
                
                console.log('Data loaded successfully');
            } catch (error) {
                console.error('Error loading data:', error);
                alert('Failed to load encounter and location data. Please refresh the page.');
            }
        }

        // Call loadData and setup event listeners when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Load external data files
            loadData();
            
            // Setup Enter key for search input
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        performSearch();
                    }
                });
            }
        });

        // REMOVED: Encounter titles now loaded from encounters.json
        
        // REMOVED: Location objects now loaded from locations.json

        // Page switching
        function switchPage(page) {
            document.getElementById('generatePage').style.display = 'none';
            document.getElementById('searchPage').style.display = 'none';
            
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            
            if (page === 'generate') {
                document.getElementById('generatePage').style.display = 'block';
                document.querySelectorAll('.nav-tab')[0].classList.add('active');
            } else if (page === 'search') {
                document.getElementById('searchPage').style.display = 'block';
                document.querySelectorAll('.nav-tab')[1].classList.add('active');
                initializeSearchFilters();
            }
        }

        // Initialize search filters
        function initializeSearchFilters() {
            if (document.getElementById('envFilters').children.length > 0) return;

            const envFilters = document.getElementById('envFilters');
            const environments = ['urban', 'arctic', 'ocean', 'space', 'crypt', 'forest', 'desert', 'mountain', 'swamp', 'underground'];
            const envIcons = { urban: 'üèõÔ∏è', arctic: '‚ùÑÔ∏è', ocean: 'üåä', space: 'üåå', crypt: 'üíÄ', forest: 'üå≤', desert: 'üèúÔ∏è', mountain: '‚õ∞Ô∏è', swamp: 'üêä', underground: 'üï≥Ô∏è' };
            
            environments.forEach(env => {
                const tag = document.createElement('div');
                tag.className = 'filter-tag';
                tag.textContent = `${envIcons[env]} ${env.charAt(0).toUpperCase() + env.slice(1)}`;
                tag.dataset.filter = env;
                tag.dataset.type = 'environment';
                tag.onclick = () => toggleFilter(tag, 'environment', env);
                envFilters.appendChild(tag);
            });

            const locationFilters = document.getElementById('locationFilters');
            const locationTypes = ['indoor', 'outdoor', 'building', 'street', 'cave', 'ruins', 'ship', 'underwater', 'tunnel', 'chamber', 'wilderness', 'path'];
            
            locationTypes.forEach(type => {
                const tag = document.createElement('div');
                tag.className = 'filter-tag';
                tag.textContent = type.charAt(0).toUpperCase() + type.slice(1);
                tag.dataset.filter = type;
                tag.dataset.type = 'locationType';
                tag.onclick = () => toggleFilter(tag, 'locationType', type);
                locationFilters.appendChild(tag);
            });

            const settingFilters = document.getElementById('settingFilters');
            const settings = ['natural', 'manmade', 'magical', 'tomb', 'void', 'water', 'urban', 'wilderness'];
            
            settings.forEach(setting => {
                const tag = document.createElement('div');
                tag.className = 'filter-tag';
                tag.textContent = setting.charAt(0).toUpperCase() + setting.slice(1);
                tag.dataset.filter = setting;
                tag.dataset.type = 'setting';
                tag.onclick = () => toggleFilter(tag, 'setting', setting);
                settingFilters.appendChild(tag);
            });
        }

        // Toggle filter
        function toggleFilter(element, type, value) {
            element.classList.toggle('active');
            
            const index = activeFilters[type].indexOf(value);
            if (index > -1) {
                activeFilters[type].splice(index, 1);
            } else {
                activeFilters[type].push(value);
            }
            
            performSearch();
        }

        // Clear filters
        function clearFilters() {
            activeFilters = {
                environment: [],
                locationType: [],
                setting: []
            };
            
            document.querySelectorAll('.filter-tag').forEach(tag => {
                tag.classList.remove('active');
            });
            
            document.getElementById('searchInput').value = '';
            performSearch();
        }

        // Perform search
        function performSearch() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
            const results = [];

            // Search encounters
            for (const [environment, encounters] of Object.entries(encounterTitles)) {
                encounters.forEach(encounter => {
                    let matches = true;

                    if (activeFilters.environment.length > 0 && !activeFilters.environment.includes(environment)) {
                        matches = false;
                    }

                    if (activeFilters.locationType.length > 0) {
                        const hasMatchingTag = encounter.tags.some(tag => activeFilters.locationType.includes(tag));
                        if (!hasMatchingTag) matches = false;
                    }

                    if (activeFilters.setting.length > 0) {
                        const hasMatchingTag = encounter.tags.some(tag => activeFilters.setting.includes(tag));
                        if (!hasMatchingTag) matches = false;
                    }

                    if (searchTerm) {
                        const titleMatch = encounter.title.toLowerCase().includes(searchTerm);
                        const tagMatch = encounter.tags.some(tag => tag.toLowerCase().includes(searchTerm));
                        const envMatch = environment.toLowerCase().includes(searchTerm);
                        
                        if (!titleMatch && !tagMatch && !envMatch) {
                            matches = false;
                        }
                    }

                    if (matches) {
                        results.push({
                            type: 'encounter',
                            title: encounter.title,
                            environment: environment,
                            tags: encounter.tags,
                            description: `An exploration encounter in a ${environment} setting`
                        });
                    }
                });
            }

            // Search locations
            for (const [environment, locations] of Object.entries(locationObjects)) {
                for (const [locationType, locationData] of Object.entries(locations)) {
                    let matches = true;

                    if (activeFilters.environment.length > 0 && !activeFilters.environment.includes(environment)) {
                        matches = false;
                    }

                    if (activeFilters.locationType.length > 0) {
                        const hasMatchingTag = locationData.tags.some(tag => activeFilters.locationType.includes(tag));
                        if (!hasMatchingTag) matches = false;
                    }

                    if (activeFilters.setting.length > 0) {
                        const hasMatchingTag = locationData.tags.some(tag => activeFilters.setting.includes(tag));
                        if (!hasMatchingTag) matches = false;
                    }

                    if (searchTerm) {
                        const typeMatch = locationType.toLowerCase().includes(searchTerm);
                        const tagMatch = locationData.tags.some(tag => tag.toLowerCase().includes(searchTerm));
                        const envMatch = environment.toLowerCase().includes(searchTerm);
                        const primaryMatch = locationData.primary.some(obj => obj.toLowerCase().includes(searchTerm));
                        const secondaryMatch = locationData.secondary.some(obj => obj.toLowerCase().includes(searchTerm));
                        const tertiaryMatch = locationData.tertiary.some(obj => obj.toLowerCase().includes(searchTerm));
                        
                        if (!typeMatch && !tagMatch && !envMatch && !primaryMatch && !secondaryMatch && !tertiaryMatch) {
                            matches = false;
                        }
                    }

                    if (matches) {
                        const totalObjects = locationData.primary.length + locationData.secondary.length + locationData.tertiary.length;
                        results.push({
                            type: 'location',
                            title: `${locationType.charAt(0).toUpperCase() + locationType.slice(1)} (${environment})`,
                            environment: environment,
                            locationType: locationType,
                            tags: locationData.tags,
                            description: `Explore ${totalObjects} interactable objects across 3 layers of detail`,
                            objects: locationData.primary.slice(0, 4).join(', ') + '...'
                        });
                    }
                }
            }

            displaySearchResults(results);
        }

        // Display search results
        function displaySearchResults(results) {
            const container = document.getElementById('searchResults');
            
            if (results.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--text-dark); padding: 40px;">No results found. Try different keywords or filters.</p>';
                return;
            }

            let html = `<h2 style="color: var(--accent-color); margin-bottom: 20px;">Found ${results.length} result${results.length !== 1 ? 's' : ''}</h2>`;
            
            results.forEach((result, index) => {
                const typeColor = result.type === 'encounter' ? 'var(--primary-color)' : 'var(--success)';
                
                html += `
                    <div class="result-card">
                        <div class="result-title">${result.title}</div>
                        <span class="result-type" style="background: ${typeColor};">${result.type.toUpperCase()}</span>
                        <span class="result-type" style="background: var(--bg-dark);">${result.environment.toUpperCase()}</span>
                        <p class="result-description">${result.description}</p>
                        ${result.objects ? `<p class="result-description"><strong>Sample objects:</strong> ${result.objects}</p>` : ''}
                        <div class="result-tags">
                            ${result.tags.map(tag => `<span class="result-tag">${tag}</span>`).join('')}
                        </div>
                        <div class="result-actions">
                            <button class="result-btn preview-btn" onclick='previewResult(${index})'>üëÅÔ∏è Preview</button>
                            <button class="result-btn open-btn" onclick='openResult(${index})'>üìÇ Open</button>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            window.searchResults = results;
        }

        // Preview result
        function previewResult(index) {
            const result = window.searchResults[index];
            const modal = document.getElementById('previewModal');
            const previewBody = document.getElementById('previewBody');
            
            let html = `
                <div class="preview-header">
                    <div class="preview-title">${result.title}</div>
                    <div style="display: flex; gap: 10px; margin-top: 10px;">
                        <span class="result-type" style="background: ${result.type === 'encounter' ? 'var(--primary-color)' : 'var(--success)'};">${result.type.toUpperCase()}</span>
                        <span class="result-type" style="background: var(--bg-dark);">${result.environment.toUpperCase()}</span>
                    </div>
                </div>
                <div class="preview-body">
            `;
            
            if (result.type === 'encounter') {
                html += `
                    <h3 style="color: var(--accent-color); margin-bottom: 15px;">üìú Encounter Overview</h3>
                    <p style="margin-bottom: 20px;">${result.description}</p>
                    
                    <h3 style="color: var(--success); margin-bottom: 15px;">üè∑Ô∏è Tags</h3>
                    <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 20px;">
                        ${result.tags.map(tag => `<span class="result-tag">${tag}</span>`).join('')}
                    </div>
                    
                    <h3 style="color: var(--warning); margin-bottom: 15px;">üé≤ What to Expect</h3>
                    <ul style="margin-left: 20px; line-height: 2;">
                        <li>Skill challenges themed to ${result.environment} exploration</li>
                        <li>Mechanical, magical, or environmental traps</li>
                        <li>Natural, supernatural, or creature-based hazards</li>
                        <li>Environmental effects unique to ${result.environment} settings</li>
                    </ul>
                    
                    <div style="margin-top: 30px; text-align: center;">
                        <button class="open-btn" onclick='closePreview(); openResult(${index});' style="padding: 12px 30px; font-size: 1.1em;">
                            üìÇ Open Full Encounter
                        </button>
                    </div>
                `;
            } else {
                html += `
                    <h3 style="color: var(--accent-color); margin-bottom: 15px;">üìç Location Overview</h3>
                    <p style="margin-bottom: 20px;">${result.description}</p>
                    
                    <h3 style="color: var(--success); margin-bottom: 15px;">üè∑Ô∏è Tags</h3>
                    <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 20px;">
                        ${result.tags.map(tag => `<span class="result-tag">${tag}</span>`).join('')}
                    </div>
                    
                    <h3 style="color: var(--warning); margin-bottom: 15px;">üîç Sample Objects</h3>
                    <p style="margin-left: 20px; line-height: 2;">${result.objects}</p>
                    
                    <div style="margin-top: 30px; text-align: center;">
                        <button class="open-btn" onclick='closePreview(); openResult(${index});' style="padding: 12px 30px; font-size: 1.1em;">
                            üìÇ Generate This Location
                        </button>
                    </div>
                `;
            }
            
            html += `</div>`;
            previewBody.innerHTML = html;
            modal.classList.add('active');
        }

        // Close preview
        function closePreview() {
            document.getElementById('previewModal').classList.remove('active');
        }

        // Close modal when clicking outside
        document.addEventListener('click', function(e) {
            const modal = document.getElementById('previewModal');
            if (e.target === modal) {
                closePreview();
            }
        });

        // Open result
        function openResult(index) {
            const result = window.searchResults[index];
            
            if (result.type === 'encounter') {
                selectedEnvironment = result.environment;
                
                document.querySelectorAll('.tag').forEach(t => t.classList.remove('active'));
                const tag = document.querySelector(`.tag[data-env="${result.environment}"]`);
                if (tag) tag.classList.add('active');
                
                generateEncounter();
                switchPage('generate');
                
                setTimeout(() => {
                    document.getElementById('encounterDisplay').scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 100);
            } else if (result.type === 'location') {
                // Get location data from locationObjects
                const locationData = locationObjects[result.environment][result.locationType];
                
                // Generate room directly
                generateRoom(result.environment, result.locationType, locationData);
                switchPage('generate');
                
                setTimeout(() => {
                    document.getElementById('roomDisplay').scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 100);
            }
        }

        // Environment tag selection
        document.querySelectorAll('.tag').forEach(tag => {
            tag.addEventListener('click', function() {
                document.querySelectorAll('.tag').forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                selectedEnvironment = this.dataset.env;
            });
        });

        // Set default active tag
        document.querySelector('.tag[data-env="urban"]').classList.add('active');

        // Encounter data structures
        const encounterData = {
            urban: {
                skillChecks: [
                    { skill: 'Investigation', purpose: 'piecing together scattered clues amid market hubbub and alleyway whispers' },
                    { skill: 'Perception', purpose: 'reading the cityscape for hidden sigils, shadowy shapes, or subtle architecture shifts' },
                    { skill: 'Stealth', purpose: 'ghosting through lantern-lit streets without drawing the eye of the watch or rival crews' },
                    { skill: 'Persuasion', purpose: 'coaxing gossip from tavern regulars or calming jittery witnesses' },
                    { skill: 'Insight', purpose: 'sussing out concealed motives behind polite smiles and officious decrees' },
                    { skill: 'Acrobatics', purpose: 'dancing across pitched rooftops and threadbare clotheslines with catlike balance' }
                ],
                traps: [
                    { name: 'Alley Ambush Setup', description: 'Broken barrels, dangling nets, and tripwires choke the narrow lane; triggering one cascades debris in a thunder of splinters and screams.' },
                    { name: 'Sewer Gas Pocket', description: 'A rancid swell of alchemical runoff waits beneath a loose grate, eager to blossom into hungry flame at the spark of a torch.' },
                    { name: 'Collapsing Scaffold', description: 'A mason\u2019s scaffold trembles with hidden faults‚Äîone incautious step sends timbers and tiles collapsing like a wooden avalanche.' },
                    { name: 'Guard Checkpoint', description: 'Steel helms and sharp eyes bar the way; without the right papers or a deft distraction, crossbow bolts and shackles follow.' }
                ],
                hazards: [
                    { name: 'Crowded Market', description: 'A sea of merchants and hawkers surges like a living tide, tangling cloaks and coin purses while unseen hands test every pocket.' },
                    { name: 'Crumbling Buildings', description: 'Abandoned tenements lean together in weary embrace; rotten beams creak underfoot before surrendering to sudden collapse.' },
                    { name: 'Polluted Waterways', description: 'Canals run slick with refuse and alchemical waste, promising fever dreams and gut-twisting curses to any who drink or fall within.' },
                    { name: 'Street Riots', description: 'Cobblestones become weapons as factions clash in a storm of banners, smoke, and hurled debris that swallows whole intersections.' }
                ],
                environmentalEffects: [
                    { name: 'City Noise', description: 'Bell towers, clattering hooves, and relentless gossip forge a constant din that drowns the softest warning or whispered spell.' },
                    { name: 'Smog and Smoke', description: 'Sooty chimneys cloak alleys in eye-stinging haze, stealing breath and weighing on the weary like a tangible shroud.' },
                    { name: 'Labyrinthine Streets', description: 'Switchback alleys and secret courts twist in Escher patterns, confounding memory unless a local map‚Äîor luck‚Äîguides the way.' }
                ]
            },
            arctic: {
                skillChecks: [
                    { skill: 'Survival', purpose: 'charting paths through needle-sharp winds and sculpting snow shelters before nightfall' },
                    { skill: 'Athletics', purpose: 'hauling companions up glassy cliffs and muscling through waist-high drifts' },
                    { skill: 'Perception', purpose: 'catching the whisper-crack of a forming avalanche or the pale gleam of hidden crevasses' },
                    { skill: 'Nature', purpose: 'reading the sky‚Äôs bruised palette to predict storms and judging which ice will bear weight' },
                    { skill: 'Constitution Save', purpose: 'locking mind and muscle against the soul-numbing cold that gnaws exposed flesh' }
                ],
                traps: [
                    { name: 'Hidden Crevasse', description: 'A yawning maw of blue-black ice lies veiled beneath powder; one misstep and the earth swallows the unwary whole.' },
                    { name: 'Thin Ice Patch', description: 'Glass-clear ice glints invitingly over a freezing abyss, splintering the moment true weight tests it.' },
                    { name: 'Snow Shelf', description: 'A fragile cornice hangs over the slope, ready to thunder down in a roaring white avalanche at the slightest vibration.' }
                ],
                hazards: [
                    { name: 'Extreme Cold', description: 'The world itself bites, leeching warmth and vigor until fingers stiffen and thoughts slow to glacial pace.' },
                    { name: 'Whiteout Conditions', description: 'Snow and sky merge into a blank, howling void where orientation is swallowed and sound feels distant.' },
                    { name: 'Avalanche Zone', description: 'Brittle slopes hold their breath, ready to erupt into a roaring cascade that buries trails and travelers alike.' },
                    { name: 'Freezing Water', description: 'A single plunge into black brine steals breath and hope, icing armor and limbs with deadly speed.' }
                ],
                environmentalEffects: [
                    { name: 'Slippery Ice', description: 'Wind-polished ice sheets gleam treacherously, turning every stride into a battle for balance.' },
                    { name: 'Limited Visibility', description: 'Whirling snow halos each torchlight, shrinking the world to a handful of ghostly shapes ahead.' },
                    { name: 'Frostbite Risk', description: 'The cold patiently gnaws at fingertips and ears, inflicting pale wounds that bloom black without swift care.' }
                ]
            },
            ocean: {
                skillChecks: [
                    { skill: 'Athletics', purpose: 'cutting through surging currents and clawing back onto pitching decks' },
                    { skill: 'Survival', purpose: 'steering by star and swell while reading the sea‚Äôs temper' },
                    { skill: 'Perception', purpose: 'spying reef-shadows, distant sails, or leviathan silhouettes before they strike' },
                    { skill: 'Nature', purpose: 'interpreting the ocean‚Äôs tides, omens, and hungry ecosystems' },
                    { skill: 'Acrobatics', purpose: 'dancing across rain-slick rigging and rolling timbers with sailor‚Äôs grace' }
                ],
                traps: [
                    { name: 'Whirlpool', description: 'A maelstrom yawns open, dragging ships into a spiraling throat of foam and splintered masts.' },
                    { name: 'Submerged Reef', description: 'Knife-edged coral lurks inches below the waves, eager to gut hulls and spill holds to the deep.' },
                    { name: 'Rip Current', description: 'A hidden river of water races seaward, snatching swimmers and wreckage into the open blue.' }
                ],
                hazards: [
                    { name: 'Storm at Sea', description: 'Towering waves and knife-sharp rain hurl the vessel between boiling sky and hungry depths.' },
                    { name: 'Dehydration', description: 'Salt-cracked lips and parched throats demand fresh water that the endless sea refuses to provide.' },
                    { name: 'Drowning', description: 'The deep welcomes the weary, wrapping them in cold silence once strength falters.' },
                    { name: 'Dangerous Marine Life', description: 'Predatory fins circle below while territorial beasts strike with barnacled fury.' }
                ],
                environmentalEffects: [
                    { name: 'Waves and Swells', description: 'Decks rise and fall like living things, turning even simple tasks into perilous feats.' },
                    { name: 'Salt Corrosion', description: 'Spray crusts every surface with salt, eating steel and stiffening leather to brittle ruin.' },
                    { name: 'Sun Exposure', description: 'Blistering sun glares off endless water, draining vitality unless shade and salves are at hand.' }
                ]
            },
            space: {
                skillChecks: [
                    { skill: 'Investigation', purpose: 'decoding alien circuitry and reconstructing the story etched in starlit wreckage' },
                    { skill: 'Arcana', purpose: 'communing with cosmic ley lines and taming raw stellar sorcery' },
                    { skill: 'Survival', purpose: 'rationing air, heat, and hope within the void‚Äôs indifferent silence' },
                    { skill: 'Athletics', purpose: 'darting through zero-gravity corridors with practiced thrusts and tethers' },
                    { skill: 'Perception', purpose: 'tracking glimmers of motion against the abyss before they become lethal' }
                ],
                traps: [
                    { name: 'Hull Breach', description: 'Fractured plating screams under pressure; the slightest misstep tears it open, venting air and adventurers into the stars.' },
                    { name: 'Radiation Pocket', description: 'Invisible auroras of lethal light bathe the corridor, searing flesh and warping magic alike.' },
                    { name: 'Magnetic Anomaly', description: 'A rogue magnetosphere seizes metal, wrenching gear from grips and pinning explorers to bulkheads.' }
                ],
                hazards: [
                    { name: 'Vacuum Exposure', description: 'The emptiness beyond the hull sucks warmth and breath away in a heartbeat.' },
                    { name: 'Meteor Shower', description: 'Needle-fine meteoroids slash past like celestial shrapnel, riddling armor and hull alike.' },
                    { name: 'Cosmic Radiation', description: 'Starfire whispers through shielding, leaving sickness and mutations in its wake.' },
                    { name: 'Micro-Gravity', description: 'Every action sends bodies drifting, turning combat into a ballet of inertia and spin.' }
                ],
                environmentalEffects: [
                    { name: 'Weightlessness', description: 'Without gravity, even the smallest force propels bodies into slow-motion orbits.' },
                    { name: 'Temperature Extremes', description: 'Sunward plating sizzles while shadowed hull frosts instantly, stressing gear and flesh.' },
                    { name: 'Communication Lag', description: 'Signals crawl through the void, forcing crews to plan carefully lest instructions arrive too late.' }
                ]
            },
            crypt: {
                skillChecks: [
                    { skill: 'Investigation', purpose: 'reading funerary carvings for concealed mechanisms and forgotten doorways' },
                    { skill: 'Religion', purpose: 'interpreting warding rites to appease ancient spirits' },
                    { skill: 'Perception', purpose: 'catching the cold shuffle of undead or the click of hidden triggers' },
                    { skill: 'Arcana', purpose: 'unraveling necromantic sigils before they awaken slumbering guardians' },
                    { skill: 'History', purpose: 'remembering dynastic feuds and legends tied to the honored dead' }
                ],
                traps: [
                    { name: 'Poison Dart Mechanism', description: 'Stone mosaics hide patient darts steeped in tomb venoms that still burn after centuries.' },
                    { name: 'Collapsing Tomb', description: 'A misjudged pry bar releases ancient counterweights, dropping the vault in a hail of stone.' },
                    { name: 'Cursed Treasure', description: 'Jeweled reliquaries clutch their owners‚Äô spite, lashing thieves with wasting curses.' },
                    { name: 'Animated Guardians', description: 'Sarcophagi groan open as gilded statues or embalmed champions rise to enforce eternal vows.' }
                ],
                hazards: [
                    { name: 'Necrotic Aura', description: 'Every breath tastes of grave dust while necromantic energy gnaws at living flesh.' },
                    { name: 'Disease Vectors', description: 'Moldering wrappings and stagnant pools teem with forgotten plagues.' },
                    { name: 'Unstable Structure', description: 'Time-weakened pillars crumble at a touch, threatening to entomb intruders forever.' },
                    { name: 'Desecration Curse', description: 'Profaning burial rites calls forth wrathful spirits or hexes that linger long after the tomb.' }
                ],
                environmentalEffects: [
                    { name: 'Oppressive Darkness', description: 'Pitch blackness swallows torchlight, letting only whispers and cold drafts hint at vast chambers.' },
                    { name: 'Stale Air', description: 'Dust-choked stillness leaves lungs burning and torches guttering low.' },
                    { name: 'Unnerving Atmosphere', description: 'A chorus of remembered prayers and distant wails gnaws at courage and focus.' }
                ]
            },
            forest: {
                skillChecks: [
                    { skill: 'Survival', purpose: 'following faint tracks across moss and charting trails through tangled boughs' },
                    { skill: 'Nature', purpose: 'reading the language of leaves, spoor, and birdsong to gauge the forest mood' },
                    { skill: 'Stealth', purpose: 'slipping between fern fronds without stirring so much as a whisper' },
                    { skill: 'Perception', purpose: 'catching the flash of predator eyes or the creak of a rigged snare' },
                    { skill: 'Athletics', purpose: 'swinging across ravines and vaulting fallen trunks with rangerly ease' }
                ],
                traps: [
                    { name: 'Pit Trap', description: 'A leaf-draped pit yawns beneath the unwary, studded with sharpened stakes and damp earth.' },
                    { name: 'Snare Trap', description: 'A braided vine lashes tight around a limb, hoisting victims skyward amid snapping branches.' },
                    { name: 'Poisonous Plants', description: 'Glossy leaves conceal irritant oils and paralytic saps cultivated by territorial hunters.' }
                ],
                hazards: [
                    { name: 'Thick Undergrowth', description: 'Brambles and thorn-thick hedges clutch at boots, slowing progress to a crawl.' },
                    { name: 'Wild Beasts', description: 'The forest‚Äôs apex predators stalk intruders with cunning pack tactics.' },
                    { name: 'Quicksand', description: 'Mossy ground liquefies into sucking mire that drags down the panicked and unwary.' },
                    { name: 'Falling Branches', description: 'Storm-tossed limbs and widowmakers crash without warning, splintering armor and bone.' }
                ],
                environmentalEffects: [
                    { name: 'Limited Visibility', description: 'Sunlight filters in dappled shards, cloaking threats in emerald shadow.' },
                    { name: 'Disorientation', description: 'Every glade mirrors the last, turning compasses unreliable and paths into circles.' },
                    { name: 'Insect Swarms', description: 'Gnats and biting flies assail exposed skin, their droning hum fraying tempers.' }
                ]
            },
            desert: {
                skillChecks: [
                    { skill: 'Survival', purpose: 'charting wind-swept dunes and divining scarce water beneath cracked earth' },
                    { skill: 'Constitution Save', purpose: 'withstanding furnace heat and the desiccating bite of desert winds' },
                    { skill: 'Perception', purpose: 'separating mirage from oasis and spotting sandstorms before they loom' },
                    { skill: 'Nature', purpose: 'knowing which cactus heals and which hides scorpion nests' },
                    { skill: 'Athletics', purpose: 'cresting dune ridges and sprinting across searing sand before it swallows tracks' }
                ],
                traps: [
                    { name: 'Sinking Sand', description: 'A dune face collapses into a swirling pit, dragging prey beneath shimmering grains.' },
                    { name: 'Buried Hazards', description: 'Sun-warmed sand hides shattered masonry and glassy obsidian ready to slice boots and flesh.' },
                    { name: 'Scorpion Den', description: 'A seemingly lifeless hummock erupts with chittering stingers angered by careless footsteps.' }
                ],
                hazards: [
                    { name: 'Extreme Heat', description: 'The sun hammers from above while reflected glare cooks armor from below.' },
                    { name: 'Dehydration', description: 'Sweat evaporates before it forms, leaving throats raw and minds swimming.' },
                    { name: 'Sandstorm', description: 'A wall of grit roars across the dunes, flaying exposed skin and burying tracks in moments.' },
                    { name: 'Heat Mirages', description: 'Shimmering heat paints false rivers and phantom caravans on the horizon.' }
                ],
                environmentalEffects: [
                    { name: 'Difficult Terrain', description: 'Shifting dunes swallow footsteps and sap strength with every stride.' },
                    { name: 'Temperature Swings', description: 'Night plummets from blistering heat to knife-edged cold in the span of a sunset.' },
                    { name: 'Sun Glare', description: 'White sand and sky fuse into blinding brilliance, forcing eyes beneath hoods and veils.' }
                ]
            },
            mountain: {
                skillChecks: [
                    { skill: 'Athletics', purpose: 'hauling bodies up sheer cliffs and bracing against punishing grades' },
                    { skill: 'Survival', purpose: 'reading scree slopes and storm fronts to keep the path safe' },
                    { skill: 'Acrobatics', purpose: 'tiptoeing along knife-edge ridges with avalanches yawning below' },
                    { skill: 'Perception', purpose: 'noticing treacherous handholds or distant rockfalls before they strike' },
                    { skill: 'Constitution Save', purpose: 'fighting off altitude sickness and lung-searing chill' }
                ],
                traps: [
                    { name: 'Rockfall Trigger', description: 'A single dislodged stone cascades into a roaring avalanche of boulders.' },
                    { name: 'False Handhold', description: 'Seemingly sturdy outcroppings shear away, sending climbers pitching into the void.' },
                    { name: 'Ice Bridge', description: 'A frost-frosted span hides a yawning crevasse, fracturing under the weight of the unwary.' }
                ],
                hazards: [
                    { name: 'Thin Air', description: 'Each breath is a labor, leaving muscles weak and thoughts hazy.' },
                    { name: 'Rockslides', description: 'Mountains shrug off cloaks of stone, pelting climbers with jagged shards.' },
                    { name: 'Sudden Storms', description: 'Thunderheads roll in with little warning, hurling sleet, lightning, and gale-force winds.' },
                    { name: 'Long Falls', description: 'A misstep offers nothing but empty sky and the promise of a terminal landing.' }
                ],
                environmentalEffects: [
                    { name: 'Strong Winds', description: 'Knife-edged gusts buffet travelers, threatening to pluck them from the path.' },
                    { name: 'Cold Temperature', description: 'Thin air and perpetual frost sap warmth from fingers and gear alike.' },
                    { name: 'Echo and Noise', description: 'Booming echoes rebound through valleys, startling wildlife and loosening stones.' }
                ]
            },
            swamp: {
                skillChecks: [
                    { skill: 'Survival', purpose: 'picking safe routes along half-sunken causeways and root bridges' },
                    { skill: 'Nature', purpose: 'distinguishing healing herbs from venom-dripping flora' },
                    { skill: 'Perception', purpose: 'listening past croaking choruses for lurking predators and bubbles' },
                    { skill: 'Athletics', purpose: 'muscling through sucking bogs and dragging companions to firmer ground' },
                    { skill: 'Constitution Save', purpose: 'enduring miasma-laden air and biting disease clouds' }
                ],
                traps: [
                    { name: 'Bog Pit', description: 'A seemingly solid patch liquefies, sucking travelers into a tar-dark mire.' },
                    { name: 'Submerged Spikes', description: 'Rotten logs conceal jagged stakes that spear boots and skiffs alike.' },
                    { name: 'Poisonous Gas Pocket', description: 'A swirl of pale vapor erupts from the muck, choking lungs with toxic fumes.' }
                ],
                hazards: [
                    { name: 'Deep Mud', description: 'Every step becomes a struggle as mud clings like a living thing.' },
                    { name: 'Disease-Carrying Insects', description: 'Mosquito clouds descend in waves, delivering fevered dreams with every bite.' },
                    { name: 'Toxic Waters', description: 'Oily sheens and skeletal fish warn that the water itself carries poison.' },
                    { name: 'Quickmud', description: 'Seemingly shallow pools turn to grasping slurry that swallows prey whole.' }
                ],
                environmentalEffects: [
                    { name: 'Poor Visibility', description: 'Ghostly fog curls between gnarled trees, muting lantern light to a mere glow.' },
                    { name: 'Constant Wetness', description: 'Moisture seeps into every seam, rotting leather and swelling wood.' },
                    { name: 'Disorientation', description: 'The swamp‚Äôs mirrored pools and moss-draped trees erase sense of direction.' }
                ]
            },
            underground: {
                skillChecks: [
                    { skill: 'Investigation', purpose: 'reading striations and echoes to unmask secret tunnels and vaults' },
                    { skill: 'Survival', purpose: 'mapping labyrinthine passages by memory and stone cairns alone' },
                    { skill: 'Perception', purpose: 'listening for dripping water, skittering feet, or the groan of stressed stone' },
                    { skill: 'Athletics', purpose: 'scrambling over jagged scree and worming through narrow chimneys' },
                    { skill: 'Nature', purpose: 'deciphering subterranean ecosystems and predicting tremors' }
                ],
                traps: [
                    { name: 'Cave-In Trigger', description: 'Loose supports and fault lines await a careless touch to bury intruders in tons of rock.' },
                    { name: 'Poisonous Gas Vent', description: 'A fissure exhales sulfurous fumes, lulling trespassers into choking unconsciousness.' },
                    { name: 'Underground River', description: 'A sudden torrent erupts from a hidden channel, dragging explorers into lightless depths.' }
                ],
                hazards: [
                    { name: 'Total Darkness', description: 'Absolute blackness swallows vision, leaving only touch and sound to navigate.' },
                    { name: 'Unstable Passages', description: 'Ceilings groan and drip, ready to surrender boulders without warning.' },
                    { name: 'Underground Rivers', description: 'Raging currents thunder through narrow tunnels, smashing trespassers against jagged stone.' },
                    { name: 'Toxic Air', description: 'Stagnant pockets of foul air sap strength and smother flames.' }
                ],
                environmentalEffects: [
                    { name: 'Claustrophobia', description: 'Pressing walls and low ceilings gnaw at nerves, sparking panic in the unsteady.' },
                    { name: 'Echo and Reverb', description: 'Voices rebound in eerie chorus, disguising distance and direction.' },
                    { name: 'Temperature Variation', description: 'Chill, damp air clings to skin, numbing fingers and making gear slick.' }
                ]
            }
        };

        function getRandomElements(array, count) {
            // Fisher-Yates shuffle for proper randomization
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled.slice(0, count);
        }

        function calculateDC(partyLevel) {
            if (partyLevel <= 4) return 10 + Math.floor(Math.random() * 3);
            if (partyLevel <= 10) return 12 + Math.floor(Math.random() * 4);
            if (partyLevel <= 16) return 15 + Math.floor(Math.random() * 5);
            return 18 + Math.floor(Math.random() * 5);
        }

        function getScalingNotes(partyLevel) {
            const notes = [];
            
            if (partyLevel <= 4) {
                notes.push('Low-level party: Reduce trap damage by 50%, lower DCs by 2-3.');
                notes.push('Focus on exploration and puzzle-solving over combat danger.');
                notes.push('Provide more obvious clues and warning signs for hazards.');
            } else if (partyLevel <= 10) {
                notes.push('Mid-level party: Standard encounter difficulty as presented.');
                notes.push('Party has access to more resources and magical solutions.');
                notes.push('Can handle multiple simultaneous challenges.');
            } else if (partyLevel <= 16) {
                notes.push('High-level party: Increase trap damage by 50%, raise DCs by 2-3.');
                notes.push('Add magical components to hazards and environmental effects.');
                notes.push('Consider multiple layers of challenges requiring diverse skills.');
            } else {
                notes.push('Epic-level party: Double trap damage, raise DCs by 4-5.');
                notes.push('Incorporate legendary environmental effects and cosmic threats.');
                notes.push('Challenges should require creative use of high-level abilities.');
                notes.push('Standard hazards may be trivial - add supernatural elements.');
            }

            return notes;
        }

        function generateEncounterTitle(environment) {
            const titles = {
                urban: ['The Shadowed Alley', 'Rooftop Chase', 'The Abandoned Warehouse', 'Market District Mystery', 'Sewer Expedition'],
                arctic: ['Frozen Wasteland Trek', 'The Avalanche Path', 'Ice Cave Exploration', 'Blizzard Survival', 'Glacier Crossing'],
                ocean: ['Storm-Tossed Voyage', 'The Coral Labyrinth', 'Derelict Ship Discovery', 'Island Approach', 'Deep Water Descent'],
                space: ['Derelict Station', 'Asteroid Field Navigation', 'Void Walk', 'Alien Ruins', 'Cosmic Anomaly'],
                crypt: ['The Ancient Tomb', 'Forgotten Catacombs', 'Cursed Burial Chamber', 'The Silent Mausoleum', 'Necropolis Depths'],
                forest: ['Dense Woodland Trail', 'The Overgrown Ruins', 'Ancient Grove', 'Forest of Whispers', 'The Hidden Glade'],
                desert: ['Scorching Dunes', 'Oasis Mirage', 'The Buried Temple', 'Canyon of Winds', 'Desert Caravan Route'],
                mountain: ['Treacherous Peak', 'The Mountain Pass', 'Cliffside Trail', 'Summit Ascent', 'The Hidden Valley'],
                swamp: ['The Mire', 'Forgotten Wetlands', 'Bog of Despair', 'Murky Waters', 'The Dead Marsh'],
                underground: ['Cavern Depths', 'The Sunless Expanse', 'Crystal Caves', 'Underground River', 'The Forgotten Mine']
            };

            const envTitles = titles[environment] || titles.urban;
            return envTitles[Math.floor(Math.random() * envTitles.length)];
        }

        function generateEncounterDescription(environment, title) {
            const descriptions = {
                urban: `The party must navigate ${title.toLowerCase()}, where every alley hums with intrigue and the city itself plays kingmaker. Lantern light paints long shadows over ancient masonry, and the press of humanity can offer salvation or doom depending on which whispers they heed.`,
                arctic: `${title} hurls the party into a realm of grinding ice and razor winds. Only careful preparation, shared body heat, and unshakable resolve stand between the heroes and the endless white hunger of the north.`,
                ocean: `The party faces ${title.toLowerCase()}, with the sea rising like a living titan around them. Tempest winds, creaking timbers, and fathomless depths remind them that mortals are but guests upon the waves.`,
                space: `In ${title.toLowerCase()}, the party drifts between stars where silence is lethal and every glimmer could be salvation or an alien trap. The void judges all missteps harshly, yet rewards courage with wonders beyond imagination.`,
                crypt: `${title} beckons with the promise of forgotten relics and the wrath of those sworn to guard them. Dust-laden sarcophagi, echoing prayers, and lingering curses turn each footfall into a negotiation with the dead.`,
                forest: `The party must traverse ${title.toLowerCase()}, an emerald cathedral where roots clutch secrets and spirits watch from the boughs. Beauty and peril twine together as the living wood decides whether these travelers are welcome.`,
                desert: `${title} stretches in shimmering waves, testing endurance, faith, and resourcefulness. The desert buries the incautious beneath sand and legend alike, yet those who read its omens may claim treasures long hidden.`,
                mountain: `The party attempts ${title.toLowerCase()}, climbing into a realm of thin air, thunderous avalanches, and unyielding stone. Each switchback is a wager with gravity, and the summit offers glory only to those who endure.`,
                swamp: `${title} engulfs the party in fetid mists and half-sunken ruins. Murky waters conceal both relics and ravenous jaws, demanding keen senses and iron stomachs from any who dare wade within.`,
                underground: `The party descends into ${title.toLowerCase()}, surrendering sunlight for echoing caverns and subterranean mysteries. Down here, the stone remembers ancient wars, and every tunnel could unveil wonder or waking terror.`
            };

            return descriptions[environment] || descriptions.urban;
        }

        function generateEncounter() {
            const partyLevel = parseInt(document.getElementById('partyLevel').value);
            
            if (isNaN(partyLevel) || partyLevel < 1 || partyLevel > 20) {
                alert('Please enter a valid party level between 1 and 20.');
                return;
            }

            const data = encounterData[selectedEnvironment];
            const title = generateEncounterTitle(selectedEnvironment);
            const description = generateEncounterDescription(selectedEnvironment, title);

            // Select random elements
            const numSkills = 3 + Math.floor(Math.random() * 2); // 3-4 skills
            const numTraps = Math.floor(Math.random() * 3) + 1; // 1-3 traps
            const numHazards = Math.floor(Math.random() * 2) + 2; // 2-3 hazards
            const numEffects = Math.floor(Math.random() * 2) + 1; // 1-2 effects

            const selectedSkills = getRandomElements(data.skillChecks, numSkills);
            const selectedTraps = getRandomElements(data.traps, numTraps);
            const selectedHazards = getRandomElements(data.hazards, numHazards);
            const selectedEffects = getRandomElements(data.environmentalEffects, numEffects);
            const scalingNotes = getScalingNotes(partyLevel);

            // Build HTML
            let html = `
                <div class="encounter-section">
                    <h2>üìú ${title}</h2>
                    <p class="description">${description}</p>
                    <p class="description"><strong>Environment:</strong> ${selectedEnvironment.charAt(0).toUpperCase() + selectedEnvironment.slice(1)} | <strong>Recommended Party Level:</strong> ${partyLevel}</p>
                </div>

                <div class="encounter-section">
                    <h2>üéØ Skill Challenges</h2>
                    <p class="description">These skill checks form the core of the exploration encounter. Players must overcome these challenges to successfully navigate the environment.</p>
            `;

            selectedSkills.forEach(skill => {
                const dc = calculateDC(partyLevel);
                html += `
                    <div class="skill-check">
                        <div class="skill-check-header">
                            <span class="skill-name">${skill.skill}</span>
                            <span class="dc">DC ${dc}</span>
                        </div>
                        <p>Purpose: ${skill.purpose}</p>
                        <p><strong>Success:</strong> The party overcomes this obstacle and gains advantage on their next related check.</p>
                        <p><strong>Failure:</strong> The party takes longer, attracts attention, or suffers minor setbacks.</p>
                    </div>
                `;
            });

            html += `</div>`;

            // Traps
            if (selectedTraps.length > 0) {
                html += `
                    <div class="encounter-section">
                        <h2>‚ö†Ô∏è Traps</h2>
                        <p class="description">Hidden dangers that require careful detection and disarming.</p>
                `;

                selectedTraps.forEach(trap => {
                    const detectDC = calculateDC(partyLevel);
                    const disarmDC = detectDC + 2;
                    // Damage scales with party level: 1d6 per 2 levels (minimum 1d6)
                    const damageScale = Math.max(1, Math.floor(partyLevel / 2));
                    const damage = `${damageScale}d6`;
                    
                    html += `
                        <div class="trap">
                            <div class="trap-name">ü™§ ${trap.name}</div>
                            <p><strong>Description:</strong> ${trap.description}</p>
                            <p><strong>Detection:</strong> DC ${detectDC} Investigation or Perception check</p>
                            <p><strong>Disarm:</strong> DC ${disarmDC} Thieves' Tools check or appropriate skill</p>
                            <p><strong>Effect:</strong> ${damage} damage (type varies by trap nature) on trigger</p>
                        </div>
                    `;
                });

                html += `</div>`;
            }

            // Hazards
            html += `
                <div class="encounter-section">
                    <h2>üí• Environmental Hazards</h2>
                    <p class="description">Natural or environmental dangers that affect the encounter area.</p>
            `;

            selectedHazards.forEach(hazard => {
                const saveDC = calculateDC(partyLevel);
                html += `
                    <div class="hazard">
                        <div class="hazard-name">‚ò†Ô∏è ${hazard.name}</div>
                        <p><strong>Description:</strong> ${hazard.description}</p>
                        <p><strong>Save DC:</strong> ${saveDC} (ability varies by hazard)</p>
                        <p><strong>Mitigation:</strong> Proper preparation, magical protection, or environmental awareness can reduce or negate effects.</p>
                    </div>
                `;
            });

            html += `</div>`;

            // Environmental Effects
            html += `
                <div class="encounter-section">
                    <h2>üå™Ô∏è Environmental Effects</h2>
                    <p class="description">Persistent conditions that affect the entire encounter area.</p>
            `;

            selectedEffects.forEach(effect => {
                html += `
                    <div class="environmental-effect">
                        <div class="effect-name">üîÆ ${effect.name}</div>
                        <p>${effect.description}</p>
                    </div>
                `;
            });

            html += `</div>`;

            // Scaling Notes
            html += `
                <div class="encounter-section">
                    <h2>‚öñÔ∏è Level Scaling Guide</h2>
                    <p class="description">Adjust the encounter difficulty based on your party's level:</p>
            `;

            scalingNotes.forEach(note => {
                html += `
                    <div class="scaling-note">
                        <span class="level-badge">Level ${partyLevel}</span>
                        ${note}
                    </div>
                `;
            });

            html += `
                    <div class="scaling-note">
                        <strong>General Scaling Tips:</strong>
                        <ul>
                            <li>For parties below the recommended level, reduce DCs by 2-3 and halve damage values</li>
                            <li>For parties above the recommended level, increase DCs by 2-3 and add additional complications</li>
                            <li>Consider party composition - groups lacking certain skills may need alternative solutions</li>
                            <li>Time pressure can increase difficulty without changing numbers</li>
                        </ul>
                    </div>
                </div>
            `;

            // Rewards and Conclusion
            html += `
                <div class="encounter-section">
                    <h2>üèÜ Resolution & Rewards</h2>
                    <p class="description"><strong>Success Criteria:</strong> The party successfully navigates the primary hazards and completes the exploration objective.</p>
                    <p class="description"><strong>Rewards:</strong></p>
                    <ul>
                        <li>Experience points appropriate for a medium difficulty exploration encounter</li>
                        <li>Knowledge of the area that may prove useful later</li>
                        <li>Possible discovery of treasure, secrets, or story clues</li>
                        <li>Reputation or favor with relevant factions</li>
                    </ul>
                    <p class="description"><strong>DM Tips:</strong> Exploration encounters work best when players feel clever for overcoming challenges. Reward creative solutions and allow multiple approaches to obstacles. The journey itself should be memorable, not just the destination.</p>
                </div>
                
                <div style="text-align: center; margin-top: 30px; padding: 20px;">
                    <button onclick="exploreEncounterLocation()" style="background: linear-gradient(135deg, #2ecc71, #27ae60); color: white; border: none; padding: 15px 30px; font-size: 18px; border-radius: 8px; cursor: pointer; box-shadow: 0 4px 6px rgba(0,0,0,0.2); transition: all 0.3s ease;">
                        üó∫Ô∏è Explore Location
                    </button>
                    <p style="margin-top: 10px; color: #666; font-size: 14px;">Dive deeper into a contextual location within this environment</p>
                </div>
            `;

            document.getElementById('encounterContent').innerHTML = html;
            document.getElementById('encounterDisplay').classList.add('active');
            
            // Smooth scroll to encounter
            document.getElementById('encounterDisplay').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // Room exploration variables
        let currentRoomEnvironment = '';
        let currentRoomType = '';
        let currentRoomData = null;
        let exploredObjects = new Set();

        // Explore location from encounter
        function exploreEncounterLocation() {
            // Use current encounter environment or default to urban
            const environment = selectedEnvironment || 'urban';
            
            // Find matching location based on encounter tags if available
            const matchingLocations = [];
            
            for (const [locationType, locationData] of Object.entries(locationObjects[environment])) {
                matchingLocations.push({ type: locationType, data: locationData });
            }
            
            // Select random matching location
            const selectedLocation = matchingLocations[Math.floor(Math.random() * matchingLocations.length)];
            
            // Generate and display room
            generateRoom(environment, selectedLocation.type, selectedLocation.data);
        }

        // Generate room
        function generateRoom(environment, locationType, locationData) {
            currentRoomEnvironment = environment;
            currentRoomType = locationType;
            currentRoomData = locationData;
            exploredObjects = new Set();
            
            displayRoomView();
        }

        // Display room view
        function displayRoomView() {
            const envIcons = {
                urban: 'üèõÔ∏è', arctic: '‚ùÑÔ∏è', ocean: 'üåä', space: 'üåå',
                crypt: 'üíÄ', forest: 'üå≤', desert: 'üèúÔ∏è', mountain: '‚õ∞Ô∏è',
                swamp: 'üêä', underground: 'üï≥Ô∏è'
            };
            
            const icon = envIcons[currentRoomEnvironment] || 'üó∫Ô∏è';
            const locationName = currentRoomType.charAt(0).toUpperCase() + currentRoomType.slice(1);
            const environmentName = currentRoomEnvironment.charAt(0).toUpperCase() + currentRoomEnvironment.slice(1);
            
            let html = `
                <div class="encounter-section">
                    <h1 style="text-align: center; color: #27ae60; margin-bottom: 30px;">
                        ${icon} Exploring ${locationName} - ${environmentName}
                    </h1>
                    <p class="description" style="text-align: center; font-size: 18px; margin-bottom: 30px;">
                        You carefully examine this location, looking for anything of interest or value.
                    </p>
                </div>

                <div class="encounter-section">
                    <h2>üîç Primary Objects of Interest</h2>
                    <p class="description">These are the prominent features and objects that immediately catch your attention:</p>
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px; margin-top: 20px;">
            `;
            
            // Display primary objects
            currentRoomData.primary.forEach((obj, index) => {
                const isExplored = exploredObjects.has(`primary-${index}`);
                const buttonStyle = isExplored 
                    ? 'background: #95a5a6; cursor: not-allowed;' 
                    : 'background: linear-gradient(135deg, #3498db, #2980b9); cursor: pointer;';
                const buttonText = isExplored ? '‚úì Explored' : 'üîç Examine';
                
                html += `
                    <div style="border: 2px solid #3498db; border-radius: 8px; padding: 15px; background: rgba(52, 152, 219, 0.1);">
                        <div style="font-weight: bold; margin-bottom: 10px; color: #2c3e50;">${obj}</div>
                        <button onclick="exploreObject('primary', ${index})" 
                                style="${buttonStyle} color: white; border: none; padding: 8px 16px; border-radius: 5px; font-size: 14px; width: 100%;"
                                ${isExplored ? 'disabled' : ''}>
                            ${buttonText}
                        </button>
                    </div>
                `;
            });
            
            html += `
                    </div>
                </div>
            `;
            
            // Show explored secondary objects section if any exist
            if (exploredObjects.size > 0) {
                const secondaryObjects = Array.from(exploredObjects)
                    .filter(id => id.startsWith('primary-'))
                    .map(id => {
                        const index = parseInt(id.split('-')[1]);
                        return currentRoomData.secondary[index];
                    });
                
                if (secondaryObjects.length > 0) {
                    html += `
                        <div class="encounter-section">
                            <h2>üîé Secondary Details Discovered</h2>
                            <p class="description">Upon closer inspection, you've discovered these additional details:</p>
                            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px; margin-top: 20px;">
                    `;
                    
                    Array.from(exploredObjects)
                        .filter(id => id.startsWith('primary-'))
                        .forEach(id => {
                            const index = parseInt(id.split('-')[1]);
                            const secondaryObj = currentRoomData.secondary[index];
                            const isSecondaryExplored = exploredObjects.has(`secondary-${index}`);
                            const buttonStyle = isSecondaryExplored 
                                ? 'background: #95a5a6; cursor: not-allowed;' 
                                : 'background: linear-gradient(135deg, #9b59b6, #8e44ad); cursor: pointer;';
                            const buttonText = isSecondaryExplored ? '‚úì Explored' : 'üîç Examine Closely';
                            
                            html += `
                                <div style="border: 2px solid #9b59b6; border-radius: 8px; padding: 15px; background: rgba(155, 89, 182, 0.1);">
                                    <div style="font-weight: bold; margin-bottom: 10px; color: #2c3e50;">${secondaryObj}</div>
                                    <button onclick="exploreObject('secondary', ${index})" 
                                            style="${buttonStyle} color: white; border: none; padding: 8px 16px; border-radius: 5px; font-size: 14px; width: 100%;"
                                            ${isSecondaryExplored ? 'disabled' : ''}>
                                        ${buttonText}
                                    </button>
                                </div>
                            `;
                        });
                    
                    html += `
                            </div>
                        </div>
                    `;
                }
                
                // Show discovered tertiary objects
                const tertiaryObjects = Array.from(exploredObjects)
                    .filter(id => id.startsWith('secondary-'))
                    .map(id => {
                        const index = parseInt(id.split('-')[1]);
                        return currentRoomData.tertiary[index];
                    });
                
                if (tertiaryObjects.length > 0) {
                    html += `
                        <div class="encounter-section">
                            <h2>‚ú® Hidden Discoveries</h2>
                            <p class="description">Through careful investigation, you've uncovered these hidden elements:</p>
                            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; margin-top: 20px;">
                    `;
                    
                    tertiaryObjects.forEach(obj => {
                        html += `
                            <div style="border: 2px solid #f39c12; border-radius: 8px; padding: 15px; background: linear-gradient(135deg, rgba(243, 156, 18, 0.2), rgba(230, 126, 34, 0.1)); box-shadow: 0 0 15px rgba(243, 156, 18, 0.3);">
                                <div style="font-weight: bold; font-size: 16px; color: #d68910; margin-bottom: 10px;">üèÜ ${obj}</div>
                                <div style="font-size: 13px; color: #7f8c8d; font-style: italic;">Significant discovery! This could be valuable, dangerous, or story-relevant.</div>
                            </div>
                        `;
                    });
                    
                    html += `
                            </div>
                        </div>
                    `;
                }
            }
            
            document.getElementById('roomContent').innerHTML = html;
            document.getElementById('encounterDisplay').classList.remove('active');
            document.getElementById('roomDisplay').style.display = 'block';
            document.getElementById('roomDisplay').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // Explore object
        function exploreObject(level, index) {
            const objectId = `${level}-${index}`;
            
            if (exploredObjects.has(objectId)) {
                return; // Already explored
            }
            
            exploredObjects.add(objectId);
            displayRoomView(); // Refresh the view to show new discoveries
        }

        // Return to encounter
        function returnToEncounter() {
            document.getElementById('roomDisplay').style.display = 'none';
            document.getElementById('encounterDisplay').classList.add('active');
            document.getElementById('encounterDisplay').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
    </script>
</body>
</html>
