name: LoreWeaver CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
    
    - name: Install dependencies
      run: npm install
    
    - name: Validate JSON files
      run: npm run test:json
    
    - name: Lint JavaScript
      run: npm run lint
    
    - name: Validate HTML
      run: npm run test:html
    
    - name: Run all tests
      run: npm test

  build-check:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
    
    - name: Install dependencies
      run: npm install
    
    - name: Test local server start
      run: |
        npx http-server -p 8000 > server.log 2>&1 &
        echo $! > server.pid
        # wait up to ~15s for server to start
        for i in 1 2 3 4 5; do
          sleep 2
          if curl -sSf http://localhost:8000 >/dev/null; then
            echo "Server started"
            break
          fi
          echo "Waiting for server..."
        done
        if ! curl -f http://localhost:8000; then
          echo "Server failed to start â€” dumping server.log"
          cat server.log || true
          exit 1
        fi
        kill $(cat server.pid) || true
